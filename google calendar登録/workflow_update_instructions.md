# n8nワークフロー更新手順書

## 概要
「今日」「明日」などの相対日付表現を正確に処理するため、新しい「相対日付変換」ノードを追加します。

## 追加するノード

### 1. 相対日付変換ノード（Codeノード）
- **名前**: `相対日付変換`
- **タイプ**: `n8n-nodes-base.code`
- **位置**: `[-3536, -128]` (Webhookデータ抽出の後、AI Agent 1の前)
- **コード**: `relative_date_converter.js`の内容を使用
- **説明ノート**:
```
【相対日付変換】

処理内容: 「今日」「明日」「来週」などの相対日付表現を正確な日付に変換

検出パターン:
- 基本: 今日、明日、明後日、昨日、一昨日
- 週: 今週、来週、再来週、先週
- 月: 今月、来月、再来月、先月
- 年: 今年、来年、去年
- 曜日: 今週の月曜日、来週の金曜日 など
- 数値: 3日後、2週間前、1ヶ月後 など

出力:
- date_context: AI用の日付コンテキスト情報
- current_datetime: 現在の日時（ISO形式）
- detected_relative_dates: 検出された相対日付のリスト

役割: AIの学習データではなく、実際の現在日時から正確な日付を計算
重要性: 年の誤認識（2024年 vs 2025年）を防ぐための重要なゲート
```

## 接続の変更

### 変更前
```
Webhookデータ抽出 → ステート確認 → ... → 【AI Agent 1】Discord予定抽出
```

### 変更後
```
Webhookデータ抽出 → 相対日付変換 → ステート確認 → ... → 【AI Agent 1】Discord予定抽出
```

### 具体的な接続変更
1. **Webhookデータ抽出の出力**を`相対日付変換`に接続
2. **相対日付変換の出力**を`ステート確認`に接続
3. **【AI Agent 1】Discord予定抽出のプロンプト**を変更:
   - 変更前: `={{ $json.message_content }}`
   - 変更後: `={{ $json.message_with_context }}`

## Sticky Noteの更新

### 「Sticky Note - Discord入力受付」の更新
```markdown
# 【グループ1: Discord入力受付・日付変換】

## このグループに含まれるノード
📌 **Discord Bot Webhook** (Webhook)
📌 **Webhookデータ抽出** (Set)
📌 **相対日付変換** (Code) ← 新規追加
📌 **ステート確認** (Code)
📌 **フロー振り分け** (IF)
📌 **Webhookデータ検証** (IF)

## 目的
Discordボットからのメッセージを受信し、相対日付表現を正確な日付に変換した上で、必要なデータを抽出・検証します。

## 背景
ユーザーはDiscordで「明日14時から会議」のような自然言語で予定を送信します。
この際、「明日」が具体的に何年何月何日なのかを正確に計算する必要があります。
AIの学習データでは2024年として誤認識される可能性があるため、機械的に現在日時から計算します。

## 処理の流れ
1. Webhook受信: Discordボットからの POST リクエスト
2. データ抽出: user_id, channel_id, message_content等を抽出
3. 【新規】相対日付変換: 「今日」「明日」等を実際の日付に変換
4. ステート確認: 初回か選択フローかを判定
5. フロー振り分け: 初回フローまたは選択フローへ分岐
6. データ検証: 必須フィールドの存在確認

## 達成したいこと
- ユーザーが送信したメッセージを確実に受け取る
- 相対日付表現を正確な日付（2025年基準）に変換
- 次の処理に必要な形式に整える

## 次のステップ
→ AI予定抽出グループへ（初回フロー）
→ 選択フロー処理グループへ（選択フロー）
```

### 「Sticky Note - ワークフロー全体説明」の更新
ノードリストに以下を追加:
```
📌 **相対日付変換** (Code) ← 新規追加
```

全体ノード数を`37個`から`38個`に変更

## JSONファイルでの変更箇所

### 1. nodesセクションに追加
```json
{
  "parameters": {
    "jsCode": "[relative_date_converter.jsの内容]"
  },
  "id": "[新しいUUID]",
  "name": "相対日付変換",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [-3536, -128],
  "notes": "[上記の説明ノートの内容]"
}
```

### 2. connectionsセクションに追加
```json
"Webhookデータ抽出": {
  "main": [
    [
      {
        "node": "相対日付変換",
        "type": "main",
        "index": 0
      }
    ]
  ]
},
"相対日付変換": {
  "main": [
    [
      {
        "node": "ステート確認",
        "type": "main",
        "index": 0
      }
    ]
  ]
}
```

### 3. AI Agent 1のプロンプト変更
```json
{
  "name": "【AI Agent 1】Discord予定抽出",
  "parameters": {
    "text": "={{ $json.message_with_context }}"
  }
}
```

## 実装ファイル
- コードファイル: `relative_date_converter.js`
- 更新対象: `step7_complete_n8n_workflow_NATIVE_NODES_v4.json`
