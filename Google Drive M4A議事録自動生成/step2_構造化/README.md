# Step2: 構造化フェーズ - 完了

## 8層フレームワーク適用結果

業務要件をn8nの8層フレームワークに分解しました。

---

## 📊 レイヤー別タスク一覧

### 1️⃣ Trigger Layer（トリガー層）
| タスク | タイプ | 説明 |
|--------|--------|------|
| Google Driveファイル監視 | Google Drive Trigger | 指定フォルダ内のM4Aファイル追加を検知 |

### 2️⃣ Fetch Layer（取得層）
| タスク | ソース | 説明 |
|--------|--------|------|
| M4Aファイル取得 | Google Drive | ファイル本体とメタデータを取得 |
| 音声文字起こし実行 | Speech-to-Text API | M4Aファイルをテキスト変換 |

### 3️⃣ Validate Layer（検証層）
| タスク | 検証ルール | 説明 |
|--------|-----------|------|
| 文字起こし結果検証 | 空でない、最小文字数満たす | テキスト品質確認 |
| ファイルメタデータ検証 | ファイル名、日時が存在 | メタデータ完全性確認 |

### 4️⃣ Transform Layer（変換層）- **最重要**
| ステップ | AIモデル | タスク | 説明 |
|----------|----------|--------|------|
| **ステップ1** | XAI Grok | 文字起こし整形 | フィラー除去、1行ごとJSON化、**ループ処理** |
| **ステップ2** | XAI Grok | 議題抽出 | 議題ごとにJSONオブジェクト生成 |
| **ステップ3** | XAI Grok | 議題分析 | 決定事項/宿題/保留事項抽出、**ループ処理** |
| - | - | 全ステップデータマージ | ステップ1,2,3のJSON統合 |
| **ステップ4** | Claude Sonnet 4.5 | フォーマット変換 | 統合JSONを議事録Markdownに変換 |
| **ステップ5** | Claude Sonnet 4.5 | 品質保証 | 全ステップ検証、完全性確認 |

### 5️⃣ Conditional Layer（条件分岐層）
| タスク | 条件 | 分岐先 |
|--------|------|--------|
| 文字起こし検証分岐 | 文字起こし結果が有効か | 成功→変換層、失敗→エラー処理 |
| 品質検証分岐 | 品質保証が合格か | 合格→Notion出力、不合格→再処理/通知 |

### 6️⃣ Execute Layer（実行層）
| タスク | アクション | 説明 |
|--------|-----------|------|
| Notion議事録ページ作成 | Notion API - Create Page | 議題ごとに**ループ処理**でページ作成（API制限回避） |
| Google Driveバックアップ | Google Drive - Upload | 議事録PDFを保存（オプション） |
| 完了通知 | Slack/Email | 処理完了を通知（オプション） |

### 7️⃣ Integrate Layer（統合層）
| タスク | 説明 |
|--------|------|
| 全処理ログ統合 | 各ステップの実行時間、データサイズ、エラー、品質スコアを記録 |

### 8️⃣ Output Layer（出力層）
| タスク | 出力先 | フォーマット |
|--------|--------|------------|
| Notionデータベース出力 | Notion | Rich Text（議題ごとにページ） |
| 処理完了ステータス更新 | ワークフロー内部 | ステータスフラグ |

---

## 🔄 データフロー全体像

```
[Google Drive M4Aファイル]
    ↓
[1. Trigger Layer]
    Google Driveファイル監視
    ↓
[2. Fetch Layer]
    M4Aファイル取得 → 音声文字起こし実行
    ↓
[3. Validate Layer]
    文字起こし検証 / メタデータ検証
    ↓ (検証OK)
[4. Transform Layer] ★最重要★
    ├─ ステップ1: 文字起こし整形 (XAI Grok) ← ループ処理
    ├─ ステップ2: 議題抽出 (XAI Grok)
    ├─ ステップ3: 議題分析 (XAI Grok) ← ループ処理
    ├─ データマージ
    ├─ ステップ4: フォーマット変換 (Claude Sonnet 4.5)
    └─ ステップ5: 品質保証 (Claude Sonnet 4.5)
    ↓
[5. Conditional Layer]
    品質検証分岐 (合格/不合格)
    ↓ (合格)
[6. Execute Layer]
    Notion議事録ページ作成 ← ループ処理 (議題ごと)
    ↓
[7. Integrate Layer]
    全処理ログ統合
    ↓
[8. Output Layer]
    Notionデータベース出力 + ステータス更新
```

---

## 🔁 ループ処理ポイント（重要）

### ループ1: ステップ1（文字起こし整形）
- **対象**: 生の文字起こしテキスト
- **ループ単位**: 1行ずつ
- **処理**: フィラー除去 → JSON化
- **n8nノード**: Split in Batches → AI Agent (Grok) → Item Lists (配列統合)

### ループ2: ステップ3（議題分析）
- **対象**: 議題JSON配列
- **ループ単位**: 議題ごと
- **処理**: 決定事項/宿題/保留事項抽出
- **n8nノード**: Split in Batches → AI Agent (Grok) → Item Lists (配列統合)

### ループ3: Notion出力
- **対象**: 議題JSON配列
- **ループ単位**: 議題ごと
- **処理**: Notionページ作成（API制限回避）
- **n8nノード**: Split in Batches → Notion Create Page → Wait (0.5秒) → 次へ

---

## 📁 成果物

**[8層フレームワーク構造.json](./8層フレームワーク構造.json)**
- 詳細な層別タスク定義とデータフロー

---

## ✅ ユーザー確認

この8層構造化で正しいですか？修正点があれば教えてください。

**承認いただければ、Step3: タスク分解フェーズ（10-50ノードへの最適化）に進みます。**
