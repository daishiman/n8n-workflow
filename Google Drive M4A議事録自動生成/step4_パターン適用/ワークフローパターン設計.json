{
  "workflow_name": "Google Drive M4A議事録自動生成ワークフロー",
  "applied_patterns": ["Sequential", "Loop", "Conditional", "Parallel"],

  "pattern_mapping": {

    "sequential_pattern": {
      "pattern_name": "Sequential（順次実行）",
      "description": "データが前のノードの出力に依存する一連の処理",
      "applied_sections": [
        {
          "section": "メインフロー（トリガー→フェッチ→検証→変換→出力）",
          "nodes": "N001 → N002 → N003 → N004 → N005 → N006 → ... → N040",
          "reason": "各レイヤーは前のレイヤーの出力に依存するため順次実行必須"
        },
        {
          "section": "AI処理5ステップ",
          "nodes": "ステップ1(整形) → ステップ2(抽出) → ステップ3(分析) → マージ → ステップ4(変換) → ステップ5(品質保証)",
          "reason": "各ステップは前ステップのJSON出力を必要とするため順次実行"
        }
      ],
      "connection_type": "main output → main input（mainチャンネル接続）",
      "data_flow": "前ノードの$jsonを次ノードで参照（={{ $json.fieldName }}）"
    },

    "loop_pattern": {
      "pattern_name": "Loop（ループ処理）",
      "description": "配列データを1つずつまたはバッチで繰り返し処理",
      "applied_sections": [
        {
          "loop_id": "Loop1",
          "loop_name": "文字起こし整形ループ",
          "start_node": "N008 (Split in Batches)",
          "processing_nodes": "N009 (AI Agent) + N010 (Chat Model) + N011 (Memory)",
          "control_node": "N012 (Loop Back or Continue)",
          "end_node": "N013 (Aggregate Items)",
          "loop_target": "文字起こしテキスト行配列",
          "batch_size": 10,
          "reason": "大量の文字起こし行を1つずつAI処理するため",
          "pattern_structure": {
            "1_prepare": "N007で行配列を生成",
            "2_split": "N008 Split in Batchesでバッチ分割（batchSize=10）",
            "3_process": "N009-N011のAI Agentクラスターで処理",
            "4_loop_control": "N012がバッチ残存チェック、残りがあればN009に戻る",
            "5_aggregate": "N013で全処理結果を配列に統合"
          }
        },
        {
          "loop_id": "Loop2",
          "loop_name": "議題分析ループ",
          "start_node": "N018 (Split in Batches)",
          "processing_nodes": "N019 (AI Agent) + N020 (Chat Model) + N021 (Memory)",
          "control_node": "N022 (Loop Back or Continue)",
          "end_node": "N023 (Aggregate Items)",
          "loop_target": "議題JSON配列",
          "batch_size": 1,
          "reason": "各議題を個別にAI分析するため",
          "pattern_structure": {
            "1_split": "N018 Split in Batchesで議題を1つずつ分割",
            "2_process": "N019-N021のAI Agentクラスターで分析",
            "3_loop_control": "N022が次の議題をチェック、残りがあればN019に戻る",
            "4_aggregate": "N023で全分析結果を配列に統合"
          }
        },
        {
          "loop_id": "Loop3",
          "loop_name": "Notion出力ループ",
          "start_node": "N034 (Split in Batches)",
          "processing_nodes": "N035 (Create Notion Page)",
          "delay_node": "N036 (Wait 0.5s)",
          "control_node": "N037 (Loop Back or Continue)",
          "loop_target": "議題JSON配列",
          "batch_size": 1,
          "reason": "Notion API制限（3リクエスト/秒）を回避するため議題ごとに遅延挿入",
          "pattern_structure": {
            "1_prepare": "N033で議題をNotion用に整形",
            "2_split": "N034 Split in Batchesで議題を1つずつ分割",
            "3_process": "N035でNotionページ作成",
            "4_delay": "N036で0.5秒待機（API制限対策）",
            "5_loop_control": "N037が次の議題をチェック、残りがあればN035に戻る"
          }
        }
      ],
      "loop_implementation_rules": {
        "split_in_batches_setup": {
          "batchSize": "処理単位（1=1つずつ、10=10個ずつ）",
          "options.reset": false
        },
        "loop_back_mechanism": "Split in Batchesノードが自動的にループを管理",
        "aggregate_method": "Item Lists ノードの aggregateItems 操作で配列統合"
      }
    },

    "conditional_pattern": {
      "pattern_name": "Conditional（条件分岐）",
      "description": "条件に基づいて処理を分岐",
      "applied_sections": [
        {
          "branch_id": "Branch1",
          "branch_name": "文字起こし検証分岐",
          "node": "N005 (Validate Transcript)",
          "condition": "文字起こし結果が有効か（空でない、最小文字数満たす）",
          "branches": {
            "true_path": {
              "destination": "N006 (Validate Metadata)",
              "description": "検証成功 → 次の検証へ進む"
            },
            "false_path": {
              "destination": "ERROR_WORKFLOW",
              "description": "検証失敗 → エラーワークフローへ分岐"
            }
          },
          "condition_logic": "{{ $json.raw_transcript !== null && $json.raw_transcript.length > 100 }}"
        },
        {
          "branch_id": "Branch2",
          "branch_name": "メタデータ検証分岐",
          "node": "N006 (Validate Metadata)",
          "condition": "ファイルメタデータが完全か（ファイル名、日時が存在）",
          "branches": {
            "true_path": {
              "destination": "N007 (Transform Layer開始)",
              "description": "検証成功 → AI処理へ進む"
            },
            "false_path": {
              "destination": "ERROR_WORKFLOW",
              "description": "検証失敗 → エラーワークフローへ分岐"
            }
          },
          "condition_logic": "{{ $json.file_name !== null && $json.created_time !== null }}"
        },
        {
          "branch_id": "Branch3",
          "branch_name": "品質検証分岐",
          "node": "N032 (Check QA Pass)",
          "condition": "品質保証スコアが70点以上か",
          "branches": {
            "true_path": {
              "destination": "N033 (Notion出力準備)",
              "description": "品質合格 → Notion出力へ進む"
            },
            "false_path": {
              "destination": "ERROR_WORKFLOW",
              "description": "品質不合格 → 再処理または手動レビュー通知"
            }
          },
          "condition_logic": "{{ $json.quality_report.overall_score > 70 }}"
        }
      ],
      "connection_type": {
        "true_branch": "Ifノードのtrue出力 → 次ノードのmain入力",
        "false_branch": "Ifノードのfalse出力 → エラーハンドリングノード"
      }
    },

    "parallel_pattern": {
      "pattern_name": "Parallel（並列実行）",
      "description": "独立した複数の処理を同時実行（このワークフローでは限定的に使用）",
      "applied_sections": [
        {
          "parallel_id": "Parallel1",
          "parallel_name": "オプション処理の並列実行",
          "trigger_node": "N037 (Notion出力ループ終了後)",
          "parallel_branches": [
            {
              "branch": "Branch A",
              "nodes": "N038 (Send Completion Notification)",
              "description": "Slack/Email通知（オプション）",
              "optional": true
            },
            {
              "branch": "Branch B",
              "nodes": "N039 (Aggregate Execution Logs)",
              "description": "ログ統合（必須）",
              "optional": false
            }
          ],
          "reason": "通知とログ統合は互いに独立しているため並列実行可能",
          "note": "このワークフローでは主にSequentialとLoopを使用し、Parallelは最小限"
        }
      ],
      "limitation": "AI Agent処理は前ステップの出力に依存するため並列化不可"
    }
  },

  "pattern_combination_strategy": {
    "overall_flow": "Sequential（メインフロー） + Loop（3箇所） + Conditional（3箇所） + Parallel（1箇所、限定的）",
    "pattern_priority": [
      "1. Sequential: メインフローの骨格として全体を貫く",
      "2. Loop: AI処理とNotion出力で配列データを効率的に処理",
      "3. Conditional: 検証ゲートとして品質を保証",
      "4. Parallel: オプション処理のみで限定的に使用"
    ],
    "design_philosophy": "データ依存性を重視し、Sequentialを基本としつつ、配列処理にLoopを適用、品質ゲートにConditionalを配置"
  },

  "data_passing_between_patterns": {
    "sequential_to_loop": {
      "example": "N007 (行配列生成) → N008 (Split in Batches開始)",
      "data_format": "配列を$jsonに格納",
      "expression": "={{ $json.lines }}"
    },
    "loop_to_sequential": {
      "example": "N013 (Aggregate Items) → N014 (AI Agent: Agenda Extractor)",
      "data_format": "統合された配列を次のシーケンシャル処理に渡す",
      "expression": "={{ $json.formatted_lines }}"
    },
    "conditional_true_to_sequential": {
      "example": "N006 (Validate Metadata true) → N007 (Transform Layer開始)",
      "connection": "true出力 → main入力"
    },
    "conditional_false_to_error": {
      "example": "N005 (Validate Transcript false) → ERROR_WORKFLOW",
      "connection": "false出力 → エラーハンドリングノード"
    }
  },

  "pattern_based_node_connections": {
    "sequential_connections": [
      "N001 → N002",
      "N002 → N003",
      "N003 → N004",
      "N004 → N005",
      "... (全Sequentialノード間)"
    ],
    "loop_connections": {
      "loop1": [
        "N007 → N008 (準備 → ループ開始)",
        "N008 → N009 (分割 → AI処理)",
        "N009 → N012 (処理 → ループ制御)",
        "N012 → N009 (ループバック)",
        "N012 → N013 (ループ終了 → 統合)"
      ],
      "loop2": [
        "N017 → N018 (準備 → ループ開始)",
        "N018 → N019 (分割 → AI処理)",
        "N019 → N022 (処理 → ループ制御)",
        "N022 → N019 (ループバック)",
        "N022 → N023 (ループ終了 → 統合)"
      ],
      "loop3": [
        "N033 → N034 (準備 → ループ開始)",
        "N034 → N035 (分割 → Notion作成)",
        "N035 → N036 (作成 → 遅延)",
        "N036 → N037 (遅延 → ループ制御)",
        "N037 → N035 (ループバック)",
        "N037 → N038/N039 (ループ終了 → 次処理)"
      ]
    },
    "conditional_connections": {
      "branch1": [
        "N005 true → N006",
        "N005 false → ERROR_WORKFLOW"
      ],
      "branch2": [
        "N006 true → N007",
        "N006 false → ERROR_WORKFLOW"
      ],
      "branch3": [
        "N032 true → N033",
        "N032 false → ERROR_WORKFLOW"
      ]
    },
    "parallel_connections": {
      "parallel1": [
        "N037 → N038 (通知)",
        "N037 → N039 (ログ統合)"
      ]
    }
  },

  "error_handling_pattern": {
    "pattern_name": "Error Workflow（エラーハンドリング）",
    "trigger": "Conditionalパターンのfalse分岐",
    "error_sources": [
      "N005 false: 文字起こし検証失敗",
      "N006 false: メタデータ検証失敗",
      "N032 false: 品質検証失敗"
    ],
    "error_workflow_actions": [
      "エラーログ記録",
      "管理者に通知（Slack/Email）",
      "ファイルを「要手動確認」フォルダに移動",
      "エラーレポート生成"
    ],
    "implementation": "Step8で詳細なError Workflowを設計"
  }
}
