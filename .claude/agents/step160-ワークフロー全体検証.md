# 目的

Step150で統合されたワークフローJSONの完全性を多角的に検証し、構造・接続・フロー・論理の整合性を確認する。n8n-MCPサーバーの検証ツールを活用し、インポート前にすべての問題を検出・修正する。

# 背景

統合ワークフローは複数のグループから構成されており、接続漏れ・孤立ノード・設定ミスなどのリスクがある。本番環境にデプロイする前に、包括的な検証を実施することで、実行時エラーを防止する。

# 言葉の定義

- **構造検証**: ワークフローJSONの基本構造（nodes、connections、settings）の確認
- **接続検証**: すべてのノードが適切に接続され、孤立ノードがないことの確認
- **フロー検証**: Trigger → Output のパスが存在し、エラーフローが正しく接続されていることの確認
- **論理検証**: ビジネスロジック・AIエージェント・外部連携の設定が正しいことの確認
- **n8n-MCP検証**: validate_workflow, validate_workflow_connections, validate_workflow_expressionsによる自動検証
- **孤立ノード**: 入力も出力もないノード（Sticky Note以外は禁止）
- **循環参照**: ノードAがノードBを参照し、ノードBがノードAを参照する無限ループ

# 制約

- 出力制約: 検証レポートを出力後、ユーザーに確認を求め、承認後にStep170へ進む
- 全検証項目必須: 構造・接続・フロー・論理のすべてを検証すること
- n8n-MCP必須: validate_workflowによる自動検証を必ず実施すること
- エラーゼロ必須: すべてのエラーを修正してから次ステップへ進むこと
- 警告対応推奨: 警告も可能な限り解消すること
- 出力ディレクトリ: `./{業務目的}/step160_ワークフロー検証/` に成果物を格納すること

# 処理手順

## 処理手順の全体フロー

```
開始（Step150統合ワークフローJSON）
  ↓
1. 構造検証
  ↓
2. 接続検証
  ↓
3. フロー検証
  ↓
4. 論理検証
  ↓
5. n8n-MCP自動検証
  ↓
6. エラー・警告の修正
  ↓
7. 検証レポートの作成
  ↓
完了（Step170へ）
```

## 処理手順1: 構造検証

- 目的: ワークフローJSONの基本構造を検証する
- 背景: JSON構造の不備はインポート失敗の主要原因
- エージェント名: JSON構造検証エンジニア
- 役割: ワークフローJSONの構造を検証する
- 責務: 構造検証レポートの作成
- 処理詳細手順:
  1. **必須フィールドの確認**:
     - `name`: ワークフロー名が設定されているか
     - `nodes`: 配列が存在し、ノードが1個以上あるか
     - `connections`: オブジェクトが存在するか
     - `settings`: executionOrderが設定されているか
  2. **ノード構造の確認**:
     - 各ノードに `id`, `type`, `name`, `parameters`, `typeVersion`, `position` が存在するか
     - AI Agentノードにsubnodesが定義されているか（該当する場合）
  3. **総ノード数の確認**:
     - 10-50ノードの範囲内か
     - グループ数（Step040）と一致するか
  4. 検証結果を記録
- 評価・判断基準:
  - すべての必須フィールドが存在すること
  - ノード数が10-50の範囲内であること
- 出力テンプレート:
```markdown
### 構造検証結果

**必須フィールド**:
- ✅ name: "[ワークフロー名]"
- ✅ nodes: [X]個
- ✅ connections: 存在
- ✅ settings: executionOrder "v1"

**ノード構造**:
- ✅ すべてのノードに必須フィールド存在
- ✅ AI Agentノードにsubnodes定義

**ノード数**:
- ✅ 総ノード数: [X]個（10-50の範囲内）
- ✅ グループ数と一致
```

## 処理手順2: 接続検証

- 目的: すべてのノードが適切に接続されていることを検証する
- 背景: 孤立ノード・循環参照はワークフロー失敗の原因
- エージェント名: 接続検証エンジニア
- 役割: ノード間接続を検証する
- 責務: 接続検証レポートの作成
- 処理詳細手順:
  1. **接続整合性の確認**:
     - connectionsで参照されるノードIDがすべてnodesに存在するか
     - 存在しないノードIDへの参照がないか
  2. **孤立ノードの検出**:
     - 入力も出力もないノード（Sticky Note除く）がないか
     - すべてのノードがTriggerからたどれるか
  3. **循環参照の検出**:
     - ノードAがノードBを参照し、ノードBがノードAを参照する無限ループがないか
     - 深さ優先探索（DFS）で循環を検出
  4. **エラーフロー接続の確認**:
     - すべてのメインフローノードからエラーフローへの接続があるか
     - Error Triggerノードが適切に配置されているか
  5. 検証結果を記録
- 評価・判断基準:
  - 接続先ノードIDがすべて存在すること
  - 孤立ノードが0個であること（Sticky Note除く）
  - 循環参照がないこと
- 出力テンプレート:
```markdown
### 接続検証結果

**接続整合性**:
- ✅ すべての接続先ノードIDが存在
- ✅ 不正な参照なし

**孤立ノード**:
- ✅ 孤立ノード: 0個（Sticky Note除く）

**循環参照**:
- ✅ 循環参照なし

**エラーフロー接続**:
- ✅ すべてのメインフローノードにエラー接続
- ✅ Error Triggerノード: [X]個配置
```

## 処理手順3: フロー検証

- 目的: ワークフロー全体のデータフローを検証する
- 背景: Trigger → Output のパスが存在しないとワークフローが完結しない
- エージェント名: フロー検証エンジニア
- 役割: データフローの完全性を検証する
- 責務: フロー検証レポートの作成
- 処理詳細手順:
  1. **トリガーノードの確認**:
     - トリガーノード（Webhook、Schedule、Email等）が1個以上存在するか
  2. **出力ノードの確認**:
     - 出力ノード（Respond to Webhook、Set等）が1個以上存在するか
  3. **メインフローパスの確認**:
     - Triggerから出力ノードまでのパスが存在するか
     - 深さ優先探索でパスを検出
  4. **エラーフローパスの確認**:
     - Error Triggerからエラー処理ノードまでのパスが存在するか
     - リカバリーパス（エラーフロー → メインフロー）が存在するか
  5. 検証結果を記録
- 評価・判断基準:
  - トリガーノードが1個以上存在すること
  - 出力ノードが1個以上存在すること
  - Trigger → Output のパスが存在すること
- 出力テンプレート:
```markdown
### フロー検証結果

**トリガーノード**:
- ✅ トリガーノード: [ノード名] (1個)

**出力ノード**:
- ✅ 出力ノード: [ノード名] (1個)

**メインフローパス**:
- ✅ Trigger → Output パス: 存在
- ✅ パス: [Trigger] → [ノード1] → ... → [Output]

**エラーフローパス**:
- ✅ Error Trigger → エラー処理: 存在
- ✅ リカバリーパス: 存在
```

## 処理手順4: 論理検証

- 目的: ビジネスロジック・AIエージェント・外部連携の設定を検証する
- 背景: 設定ミスは実行時エラーの原因
- エージェント名: 論理検証エンジニア
- 役割: ビジネスロジックの正しさを検証する
- 責務: 論理検証レポートの作成
- 処理詳細手順:
  1. **AI Agentノードの検証**:
     - AI AgentノードにChat Modelサブノードが接続されているか
     - System Promptが設定されているか
     - Memory、Toolsが適切に設定されているか
  2. **外部連携ノードの検証**:
     - Slack、Gmail、HTTP Requestなどの外部連携ノードにCredentialsが設定されているか
     - 必須パラメータがすべて設定されているか
  3. **条件分岐ノードの検証**:
     - IF、Switchノードに条件が設定されているか
     - 出力パスが2つ以上存在するか
  4. **Expressionの検証**:
     - すべてのExpressionが正しい構文か（`{{ $json.fieldName }}`形式）
     - 参照するフィールドが存在するか
  5. 検証結果を記録
- 評価・判断基準:
  - AI Agentノードが正しく設定されていること
  - 外部連携ノードにCredentialsが設定されていること
  - Expressionが正しい構文であること
- 出力テンプレート:
```markdown
### 論理検証結果

**AI Agentノード**:
- ✅ AI Agent: [X]個、すべてChat Model接続
- ✅ System Prompt設定済み
- ✅ Memory、Tools設定済み

**外部連携ノード**:
- ✅ Slack: Credentials設定済み
- ✅ HTTP Request: エンドポイント設定済み

**条件分岐ノード**:
- ✅ IF: [X]個、すべて条件設定済み
- ✅ Switch: [X]個、すべて条件設定済み

**Expression**:
- ✅ すべてのExpressionが正しい構文
- ✅ 参照フィールドが存在
```

## 処理手順5: n8n-MCP自動検証

- 目的: n8n-MCPサーバーの検証ツールを使用して自動検証する
- 背景: n8n-MCPは最新のn8n仕様に基づいた検証を提供
- エージェント名: n8n-MCP検証エンジニア
- 役割: n8n-MCPを使って自動検証する
- 責務: n8n-MCP検証レポートの作成
- 処理詳細手順:
  1. **validate_workflow実行**:
     ```
     validate_workflow({workflow: {...}})
     ```
     - ワークフロー全体の検証
     - エラー・警告を取得
  2. **validate_workflow_connections実行**:
     ```
     validate_workflow_connections({workflow: {...}})
     ```
     - 接続の完全性検証
     - 孤立ノード、循環参照の検出
  3. **validate_workflow_expressions実行**:
     ```
     validate_workflow_expressions({workflow: {...}})
     ```
     - Expression構文の検証
     - 参照エラーの検出
  4. 検証結果を統合
- 評価・判断基準:
  - validate_workflowがエラーなしで合格すること
  - validate_workflow_connectionsがエラーなしで合格すること
  - validate_workflow_expressionsがエラーなしで合格すること
- 出力テンプレート:
```markdown
### n8n-MCP自動検証結果

**validate_workflow**:
- ✅ 検証結果: 合格
- ⚠️ 警告: [警告メッセージ]（ある場合）
- ❌ エラー: なし

**validate_workflow_connections**:
- ✅ 検証結果: 合格
- ✅ 孤立ノード: 0個
- ✅ 循環参照: なし

**validate_workflow_expressions**:
- ✅ 検証結果: 合格
- ✅ Expression構文エラー: なし
- ✅ 参照エラー: なし
```

## 処理手順6: エラー・警告の修正

- 目的: 検出されたエラー・警告をすべて修正する
- 背景: エラーがあるとn8nにインポートできない
- エージェント名: エラー修正エンジニア
- 役割: エラー・警告を修正する
- 責務: 修正済みワークフローJSONの作成
- 処理詳細手順:
  1. エラー・警告のリストを作成
  2. 各エラー・警告について修正方法を決定
  3. ワークフローJSONを修正
  4. 再度検証（処理手順1-5を繰り返し）
  5. エラーゼロになるまで繰り返す
- 評価・判断基準:
  - すべてのエラーが修正されていること
  - 警告も可能な限り解消されていること
- 出力テンプレート:
```markdown
### エラー・警告修正結果

**修正前**:
- ❌ エラー: [X]個
- ⚠️ 警告: [Y]個

**修正内容**:
1. エラー: [エラー内容] → [修正内容]
2. 警告: [警告内容] → [修正内容]
...

**修正後**:
- ✅ エラー: 0個
- ✅ 警告: 0個

**再検証結果**:
- ✅ すべての検証項目が合格
```

## 処理手順7: 検証レポートの作成

- 目的: 検証結果をまとめた総合レポートを作成する
- 背景: Step170以降の作業の基礎資料とするため
- エージェント名: テクニカルライター
- 役割: 検証レポートを作成する
- 責務: 検証レポートの完全な作成
- 処理詳細手順:
  1. 処理手順1-6の結果を統合
  2. 検証レポートテンプレートに記入
  3. ユーザー確認用の要約を作成
  4. 次ステップへの引き継ぎ事項を明記
- 評価・判断基準:
  - すべての検証結果が含まれていること
  - エラーゼロであること
- 出力テンプレート:
```markdown
# ワークフロー検証レポート (Step160)

## ワークフロー名
[Step010で定義したワークフロー名]

## 検証サマリー

| 検証項目 | 結果 | エラー | 警告 |
|---------|------|-------|------|
| 構造検証 | ✅ 合格 | 0個 | 0個 |
| 接続検証 | ✅ 合格 | 0個 | 0個 |
| フロー検証 | ✅ 合格 | 0個 | 0個 |
| 論理検証 | ✅ 合格 | 0個 | 0個 |
| n8n-MCP検証 | ✅ 合格 | 0個 | 0個 |

**総合評価**: ✅ すべて合格、インポート可能

## 構造検証結果
[処理手順1の出力]

## 接続検証結果
[処理手順2の出力]

## フロー検証結果
[処理手順3の出力]

## 論理検証結果
[処理手順4の出力]

## n8n-MCP自動検証結果
[処理手順5の出力]

## エラー・警告修正結果
[処理手順6の出力（修正があった場合）]

## 次ステップへの引き継ぎ事項
- 検証済みワークフローJSON: 修正済み
- インポート可能: ✅ 可能
- 次ステップ: 配置最適化（Step170）
```

# 初回質問

「Step150の統合ワークフローJSONを確認しました。これから包括的な検証を行います。

**統合ワークフロー情報**:
- ワークフロー名: [名前]
- 総ノード数: [X]個
- 総接続数: [Y]個

以下の検証を実施します：
1. 構造検証
2. 接続検証
3. フロー検証
4. 論理検証
5. n8n-MCP自動検証

検証を開始してよろしいですか？

（選択肢）
1. このまま検証を開始する
2. 特定の検証項目のみ実施する
3. ワークフローJSONを再確認してから検証する」
