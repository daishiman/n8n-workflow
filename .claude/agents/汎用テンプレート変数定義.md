# n8nワークフロー 汎用テンプレート変数定義

**バージョン**: v4.0
**作成日**: 2025-11-10
**n8n-MCP検証済み**: ✅

---

## 概要

このドキュメントは、n8nワークフロー自動設計プロセス v4.0で使用する汎用的なテンプレート変数を定義します。すべての変数はn8n-MCPで検証済みの実際のn8nワークフロー構造に基づいています。

---

## ワークフロー全体構造

### ワークフローJSONの基本構造

```json
{
  "name": "{{WORKFLOW_NAME}}",
  "nodes": [{{NODE_ARRAY}}],
  "connections": {{CONNECTIONS_OBJECT}},
  "settings": {{WORKFLOW_SETTINGS}},
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "{{TIMESTAMP}}",
  "versionId": "{{VERSION_ID}}"
}
```

---

## ノード関連テンプレート変数

### 共通ノードプロパティ

すべてのn8nノードで共通のプロパティ：

| 変数名 | 型 | 必須 | 説明 | 例 |
|--------|-----|------|------|-----|
| `{{NODE_ID}}` | string (UUID) | ✅ | ノードの一意識別子 | `"693e094e-0329-455d-9c42-ba398dd40955"` |
| `{{NODE_TYPE}}` | string | ✅ | ノードタイプ（パッケージ名含む） | `"n8n-nodes-base.webhook"` |
| `{{NODE_NAME}}` | string | ✅ | ノードの表示名 | `"Webhook Trigger"` |
| `{{NODE_POSITION_X}}` | number | ✅ | X座標（水平位置） | `100` |
| `{{NODE_POSITION_Y}}` | number | ✅ | Y座標（垂直位置） | `200` |
| `{{NODE_TYPE_VERSION}}` | number | ⚠️ | ノードのバージョン | `1`, `2`, `2.1` |
| `{{NODE_PARAMETERS}}` | object | ⚠️ | ノード固有のパラメータ | `{"httpMethod": "POST"}` |
| `{{NODE_CREDENTIALS}}` | object | ❌ | 認証情報（オプション） | `{"webhook": {"id": "1", "name": "..."}}` |
| `{{NODE_WEBHOOK_ID}}` | string | ❌ | Webhookノード用ID | `"webhook-id-123"` |
| `{{NODE_NOTES}}` | string | ❌ | ノードに付けるメモ | `"POST /receive-minutes"` |
| `{{NODE_DISABLED}}` | boolean | ❌ | ノード無効化フラグ | `false` |

**必須マーク説明**:
- ✅ 必須: すべてのノードで必要
- ⚠️ 推奨: ほとんどのノードで推奨
- ❌ オプション: 必要に応じて追加

### ノードテンプレート（基本）

```json
{
  "id": "{{NODE_ID}}",
  "name": "{{NODE_NAME}}",
  "type": "{{NODE_TYPE}}",
  "typeVersion": {{NODE_TYPE_VERSION}},
  "position": [{{NODE_POSITION_X}}, {{NODE_POSITION_Y}}],
  "parameters": {{NODE_PARAMETERS}}
}
```

**n8n-MCP検証済み**: このテンプレートは実際のn8nテンプレート（ID: 3805）と一致

---

## ノードタイプ別テンプレート変数

### 1. Webhookノード（Trigger）

**ノードタイプ**: `n8n-nodes-base.webhook`
**n8n-MCP検証**: ✅ `get_node_essentials("nodes-base.webhook")`

```json
{
  "id": "{{WEBHOOK_NODE_ID}}",
  "name": "{{WEBHOOK_NODE_NAME}}",
  "type": "n8n-nodes-base.webhook",
  "typeVersion": 2.1,
  "position": [{{X}}, {{Y}}],
  "webhookId": "{{WEBHOOK_ID}}",
  "parameters": {
    "httpMethod": "{{HTTP_METHOD}}",
    "path": "{{WEBHOOK_PATH}}",
    "responseMode": "{{RESPONSE_MODE}}",
    "responseData": "{{RESPONSE_DATA}}",
    "options": {}
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 選択肢 | 説明 |
|--------|-------------|--------|------|
| `{{HTTP_METHOD}}` | `"GET"` | `"GET"`, `"POST"`, `"PUT"`, `"DELETE"`, `"PATCH"`, `"HEAD"` | HTTPメソッド |
| `{{WEBHOOK_PATH}}` | `""` | 任意の文字列 | Webhookパス（例: `/receive-data`） |
| `{{RESPONSE_MODE}}` | `"onReceived"` | `"onReceived"`, `"lastNode"`, `"responseNode"` | レスポンスタイミング |
| `{{RESPONSE_DATA}}` | `"firstEntryJson"` | `"allEntries"`, `"firstEntryJson"`, `"firstEntryBinary"`, `"noData"` | レスポンスデータ形式 |

---

### 2. AI Agentノード

**ノードタイプ**: `@n8n/n8n-nodes-langchain.agent`
**n8n-MCP検証**: ✅ `get_node_info("nodes-langchain.agent")`

```json
{
  "id": "{{AI_AGENT_NODE_ID}}",
  "name": "{{AI_AGENT_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.agent",
  "typeVersion": 3,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "promptType": "{{PROMPT_TYPE}}",
    "text": "={{PROMPT_TEXT}}",
    "hasOutputParser": {{HAS_OUTPUT_PARSER}},
    "options": {
      "systemMessage": "{{SYSTEM_MESSAGE}}",
      "maxIterations": {{MAX_ITERATIONS}},
      "returnIntermediateSteps": {{RETURN_INTERMEDIATE_STEPS}}
    }
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 選択肢 | 説明 |
|--------|-------------|--------|------|
| `{{PROMPT_TYPE}}` | `"define"` | `"auto"`, `"define"` | プロンプトソース |
| `{{PROMPT_TEXT}}` | `"$json.chatInput"` | n8n Expression | ユーザープロンプト |
| `{{HAS_OUTPUT_PARSER}}` | `false` | `true`, `false` | 出力パーサー使用 |
| `{{SYSTEM_MESSAGE}}` | `"You are a helpful assistant"` | 任意の文字列 | System Prompt（**重要**） |
| `{{MAX_ITERATIONS}}` | `10` | 1-100 | 最大イテレーション数 |
| `{{RETURN_INTERMEDIATE_STEPS}}` | `false` | `true`, `false` | 中間ステップ返却 |

**重要な発見（n8n-MCP検証結果）**:
- "System Prompt" は `options.systemMessage` パラメータで設定
- デフォルト値は `"You are a helpful assistant"`
- これはプロンプト内で「System Prompt」と記載している箇所の実際の設定方法

**AIエージェントサブノード構造**:

AI Agentノードは、以下の3種類のサブノードと接続して動作します：

| 接続タイプ | 必須/任意 | 説明 |
|-----------|---------|------|
| `ai_languageModel` | **必須** | OpenAI、Anthropic、Geminiなどのチャットモデル |
| `ai_memory` | 任意（推奨） | 会話履歴を保持するメモリーノード |
| `ai_tool` | 任意 | エージェントが使用できるツール（複数接続可能） |

---

### 2a. Language Model サブノード（必須）

AI Agentノードには、Language Modelサブノードが**必須**です。

#### OpenAI Chat Model

**ノードタイプ**: `@n8n/n8n-nodes-langchain.lmChatOpenAi`

```json
{
  "id": "{{LM_OPENAI_NODE_ID}}",
  "name": "{{LM_OPENAI_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "model": "{{OPENAI_MODEL}}",
    "options": {
      "temperature": {{TEMPERATURE}},
      "maxTokens": {{MAX_TOKENS}}
    }
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{OPENAI_MODEL}}` | `"gpt-4o"` | モデル名（gpt-4o, gpt-4o-mini, gpt-3.5-turbo） |
| `{{TEMPERATURE}}` | `0.7` | 温度（0.0-2.0） |
| `{{MAX_TOKENS}}` | `2000` | 最大トークン数 |

#### Anthropic Chat Model (Claude)

**ノードタイプ**: `@n8n/n8n-nodes-langchain.lmChatAnthropic`

```json
{
  "id": "{{LM_ANTHROPIC_NODE_ID}}",
  "name": "{{LM_ANTHROPIC_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "model": "{{ANTHROPIC_MODEL}}",
    "options": {
      "temperature": {{TEMPERATURE}},
      "maxTokens": {{MAX_TOKENS}}
    }
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{ANTHROPIC_MODEL}}` | `"claude-3-5-sonnet-20241022"` | モデル名 |
| `{{TEMPERATURE}}` | `0.7` | 温度（0.0-1.0） |
| `{{MAX_TOKENS}}` | `8000` | 最大トークン数 |

#### Google Gemini Chat Model

**ノードタイプ**: `@n8n/n8n-nodes-langchain.lmChatGoogleGemini`

```json
{
  "id": "{{LM_GEMINI_NODE_ID}}",
  "name": "{{LM_GEMINI_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "modelName": "{{GEMINI_MODEL}}",
    "options": {
      "temperature": {{TEMPERATURE}},
      "maxOutputTokens": {{MAX_TOKENS}}
    }
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{GEMINI_MODEL}}` | `"gemini-2.0-flash-exp"` | モデル名 |
| `{{TEMPERATURE}}` | `0.4` | 温度（0.0-2.0） |
| `{{MAX_TOKENS}}` | `4000` | 最大出力トークン数 |

---

### 2b. Memory サブノード（任意、推奨）

会話履歴を保持するためのメモリーノードです。

#### Simple Memory (Buffer Window)

**ノードタイプ**: `@n8n/n8n-nodes-langchain.memoryBufferWindow`

```json
{
  "id": "{{MEMORY_NODE_ID}}",
  "name": "{{MEMORY_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
  "typeVersion": 1.3,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "sessionKey": "={{SESSION_KEY}}",
    "contextWindowLength": {{CONTEXT_WINDOW_LENGTH}}
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{SESSION_KEY}}` | `"={{ $json.sessionId }}"` | セッション識別キー |
| `{{CONTEXT_WINDOW_LENGTH}}` | `10` | 保持する会話ターン数 |

#### Redis Chat Memory（本番環境推奨）

**ノードタイプ**: `@n8n/n8n-nodes-langchain.memoryRedisChat`

```json
{
  "id": "{{MEMORY_REDIS_NODE_ID}}",
  "name": "{{MEMORY_REDIS_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "sessionKey": "={{SESSION_KEY}}",
    "sessionTimeToLive": {{SESSION_TTL}},
    "contextWindowLength": {{CONTEXT_WINDOW_LENGTH}}
  },
  "credentials": {
    "redis": "{{REDIS_CREDENTIALS}}"
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{SESSION_KEY}}` | `"={{ $json.sessionId }}"` | セッション識別キー |
| `{{SESSION_TTL}}` | `3600` | セッション有効期限（秒） |
| `{{CONTEXT_WINDOW_LENGTH}}` | `10` | 保持する会話ターン数 |

---

### 2c. Tool サブノード（任意）

AIエージェントが使用できる外部ツールです。

#### Call n8n Sub-Workflow Tool

**ノードタイプ**: `@n8n/n8n-nodes-langchain.toolWorkflow`

```json
{
  "id": "{{TOOL_WORKFLOW_NODE_ID}}",
  "name": "{{TOOL_WORKFLOW_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
  "typeVersion": 1.1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "description": "{{TOOL_DESCRIPTION}}",
    "source": "database",
    "workflowId": "={{WORKFLOW_ID}}"
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{TOOL_DESCRIPTION}}` | - | ツールの説明（AIが理解できる形式） |
| `{{WORKFLOW_ID}}` | - | 呼び出すワークフローID |

#### HTTP Request Tool

**ノードタイプ**: `@n8n/n8n-nodes-langchain.toolHttpRequest`

```json
{
  "id": "{{TOOL_HTTP_NODE_ID}}",
  "name": "{{TOOL_HTTP_NODE_NAME}}",
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "name": "{{TOOL_NAME}}",
    "description": "{{TOOL_DESCRIPTION}}",
    "method": "{{HTTP_METHOD}}",
    "url": "{{HTTP_URL}}",
    "authentication": "{{AUTH_TYPE}}"
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 説明 |
|--------|-------------|------|
| `{{TOOL_NAME}}` | - | ツール名 |
| `{{TOOL_DESCRIPTION}}` | - | ツールの説明 |
| `{{HTTP_METHOD}}` | `"GET"` | HTTPメソッド |
| `{{HTTP_URL}}` | - | API URL |
| `{{AUTH_TYPE}}` | `"predefinedCredentialType"` | 認証タイプ |

#### Calculator Tool

**ノードタイプ**: `@n8n/n8n-nodes-langchain.toolCalculator`

```json
{
  "id": "{{TOOL_CALC_NODE_ID}}",
  "name": "Calculator",
  "type": "@n8n/n8n-nodes-langchain.toolCalculator",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {}
}
```

---

### 2d. AI Agent完全構成例

以下は、AI Agentノード + サブノード（Language Model + Memory + Tools）の完全な構成例です：

```json
{
  "nodes": [
    {
      "id": "ai-agent-main",
      "name": "AI Agent: 議事録要約",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [800, 400],
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "あなたは会議議事録を簡潔に要約する専門AIです。"
        }
      }
    },
    {
      "id": "lm-openai",
      "name": "OpenAI GPT-4o",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [600, 300],
      "parameters": {
        "model": "gpt-4o",
        "options": {
          "temperature": 0.7,
          "maxTokens": 2000
        }
      }
    },
    {
      "id": "memory-simple",
      "name": "Simple Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [600, 400],
      "parameters": {
        "sessionKey": "={{ $json.sessionId }}",
        "contextWindowLength": 10
      }
    },
    {
      "id": "tool-calculator",
      "name": "Calculator",
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [600, 500],
      "parameters": {}
    }
  ],
  "connections": {
    "OpenAI GPT-4o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: 議事録要約",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent: 議事録要約",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "AI Agent: 議事録要約",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  }
}
```

**重要なポイント**:

1. **接続タイプの指定**: サブノードをAIエージェントに接続する際、`connections`オブジェクトで正しい接続タイプを指定：
   - Language Model → `ai_languageModel`
   - Memory → `ai_memory`
   - Tools → `ai_tool`

2. **複数ツールの接続**: ツールは複数接続可能。`connections`の配列に複数のツールノードを追加。

3. **必須接続**: Language Modelは必須。MemoryおよびToolsは任意だが、Memoryがないと会話コンテキストが保持されない。
---

### 3. Sticky Noteノード

**ノードタイプ**: `n8n-nodes-base.stickyNote`
**n8n-MCP検証**: ✅ `validate_node_minimal("nodes-base.stickyNote", config)`

```json
{
  "id": "{{STICKY_NOTE_ID}}",
  "name": "{{STICKY_NOTE_NAME}}",
  "type": "n8n-nodes-base.stickyNote",
  "typeVersion": 1,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "content": "{{STICKY_NOTE_CONTENT}}",
    "height": {{STICKY_NOTE_HEIGHT}},
    "width": {{STICKY_NOTE_WIDTH}},
    "color": {{STICKY_NOTE_COLOR}}
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 必須 | 説明 |
|--------|-------------|------|------|
| `{{STICKY_NOTE_CONTENT}}` | `"## I'm a note \n**Double click** to edit me."` | ❌ | Markdown形式のコンテンツ |
| `{{STICKY_NOTE_HEIGHT}}` | `160` | ✅ | 高さ（px） |
| `{{STICKY_NOTE_WIDTH}}` | `240` | ✅ | 幅（px） |
| `{{STICKY_NOTE_COLOR}}` | `1` | ✅ | 色番号（0-7） |

**Sticky Note 色番号**:
- `0`: グレー
- `1`: 薄黄色（デフォルト）
- `2`: 薄緑色
- `3`: 薄青色
- `4`: 薄紫色
- `5`: 薄赤色
- `6`: 薄オレンジ色
- `7`: 薄ピンク色

**n8n-MCP検証結果**:
```json
// ❌ 無効（必須プロパティ欠落）
validate_node_minimal("nodes-base.stickyNote", {})
→ {"valid": false, "missingRequiredFields": ["Height", "Width", "Color"]}

// ✅ 有効
validate_node_minimal("nodes-base.stickyNote", {"height": 300, "width": 400, "color": 1})
→ {"valid": true, "missingRequiredFields": []}
```

---

### 4. Respond to Webhookノード

**ノードタイプ**: `n8n-nodes-base.respondToWebhook`
**n8n-MCP検証**: ✅ `get_node_essentials("nodes-base.respondToWebhook")`

```json
{
  "id": "{{RESPOND_WEBHOOK_NODE_ID}}",
  "name": "{{RESPOND_WEBHOOK_NODE_NAME}}",
  "type": "n8n-nodes-base.respondToWebhook",
  "typeVersion": 1.4,
  "position": [{{X}}, {{Y}}],
  "parameters": {
    "respondWith": "{{RESPOND_WITH}}",
    "responseBody": "={{RESPONSE_BODY}}"
  }
}
```

**パラメータ変数**:

| 変数名 | デフォルト値 | 選択肢 | 説明 |
|--------|-------------|--------|------|
| `{{RESPOND_WITH}}` | `"firstIncomingItem"` | `"allIncomingItems"`, `"binary"`, `"firstIncomingItem"`, `"json"`, `"jwt"`, `"noData"`, `"redirect"`, `"text"` | レスポンス種類 |
| `{{RESPONSE_BODY}}` | - | n8n Expression または JSON | レスポンスボディ |

---

## 接続（Connections）テンプレート変数

### Connections構造

```json
{
  "connections": {
    "{{SOURCE_NODE_NAME}}": {
      "main": [
        [
          {
            "node": "{{TARGET_NODE_NAME}}",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
```

**接続変数**:

| 変数名 | 型 | 説明 | 例 |
|--------|-----|------|-----|
| `{{SOURCE_NODE_NAME}}` | string | 接続元ノード名（nameプロパティ） | `"Webhook Trigger"` |
| `{{TARGET_NODE_NAME}}` | string | 接続先ノード名（nameプロパティ） | `"AI Agent"` |
| `{{CONNECTION_TYPE}}` | string | 接続タイプ | `"main"`, `"error"` |
| `{{CONNECTION_INDEX}}` | number | 出力インデックス | `0`, `1` |

**重要な発見（n8n-MCP検証結果）**:
- connectionsのキーは**ノードのname**（idではない）
- 実際のテンプレート（ID: 3805）で確認済み

### 条件分岐ノードの複数出力

```json
{
  "connections": {
    "{{IF_NODE_NAME}}": {
      "main": [
        [
          {
            "node": "{{TRUE_PATH_NODE}}",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "{{FALSE_PATH_NODE}}",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
```

---

## ワークフロー設定（Settings）テンプレート変数

```json
{
  "settings": {
    "executionOrder": "{{EXECUTION_ORDER}}",
    "saveDataErrorExecution": "{{SAVE_DATA_ERROR}}",
    "saveDataSuccessExecution": "{{SAVE_DATA_SUCCESS}}",
    "saveManualExecutions": {{SAVE_MANUAL_EXECUTIONS}},
    "callerPolicy": "{{CALLER_POLICY}}",
    "errorWorkflow": "{{ERROR_WORKFLOW_ID}}"
  }
}
```

**設定変数**:

| 変数名 | デフォルト値 | 選択肢 | 説明 |
|--------|-------------|--------|------|
| `{{EXECUTION_ORDER}}` | `"v1"` | `"v0"`, `"v1"` | 実行順序バージョン |
| `{{SAVE_DATA_ERROR}}` | `"all"` | `"all"`, `"none"` | エラー実行データ保存 |
| `{{SAVE_DATA_SUCCESS}}` | `"all"` | `"all"`, `"none"` | 成功実行データ保存 |
| `{{SAVE_MANUAL_EXECUTIONS}}` | `false` | `true`, `false` | 手動実行データ保存 |
| `{{CALLER_POLICY}}` | `"workflowsFromSameOwner"` | `"any"`, `"none"`, `"workflowsFromAList"`, `"workflowsFromSameOwner"` | 呼び出し元ポリシー |
| `{{ERROR_WORKFLOW_ID}}` | `""` | ワークフローID | エラー時実行ワークフロー |

---

## グループ・レイヤー用変数

### グループ識別変数

| 変数名 | パターン | 説明 | 例 |
|--------|---------|------|-----|
| `{{GROUP_ID}}` | `G\d{3}` または `E\d{3}` | グループID（3桁ゼロパディング） | `G001`, `G010`, `E001` |
| `{{GROUP_NAME}}` | 任意の文字列 | グループの説明的な名前 | `"入力受付グループ"`, `"AI処理グループ"` |
| `{{GROUP_PURPOSE}}` | 任意の文字列 | グループの目的 | `"ユーザーリクエストの受付と検証"` |
| `{{GROUP_INDEX}}` | 1-40 | グループ番号（整数） | `1`, `10`, `30` |

### レイヤー識別変数

| 変数名 | パターン | 説明 | 例 |
|--------|---------|------|-----|
| `{{LAYER_ID}}` | `L\d{1,2}` | レイヤーID（12層アーキテクチャ） | `L1`, `L5`, `L12` |
| `{{LAYER_NAME}}` | 任意の文字列 | レイヤーの名前 | `"入力層"`, `"AI処理層"` |
| `{{LAYER_INDEX}}` | 1-12 | レイヤー番号（整数） | `1`, `5`, `12` |

---

## タイムスタンプ・ID生成変数

### タイムスタンプ

| 変数名 | 形式 | 説明 | 例 |
|--------|------|------|-----|
| `{{TIMESTAMP}}` | ISO 8601 | タイムスタンプ | `"2025-11-10T12:34:56.789Z"` |
| `{{CREATED_AT}}` | ISO 8601 | 作成日時 | `"2025-11-10T12:34:56.789Z"` |
| `{{UPDATED_AT}}` | ISO 8601 | 更新日時 | `"2025-11-10T12:34:56.789Z"` |

### UUID生成

| 変数名 | 形式 | 説明 | 例 |
|--------|------|------|-----|
| `{{UUID}}` | UUID v4 | ランダムUUID | `"693e094e-0329-455d-9c42-ba398dd40955"` |
| `{{NODE_UUID}}` | UUID v4 | ノード用UUID | `"6172b8b6-4950-4b7f-a60c-ce782139f24c"` |

**UUID生成方法（JavaScript）**:
```javascript
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}
```

---

## 配置（Position）計算変数

### 座標計算

| 変数名 | 計算式 | 説明 |
|--------|--------|------|
| `{{BASE_X}}` | `100` | 基準X座標 |
| `{{BASE_Y}}` | `100` | 基準Y座標 |
| `{{LAYER_Y}}` | `BASE_Y + (LAYER_INDEX - 1) * 300` | レイヤーY座標 |
| `{{GROUP_X}}` | `BASE_X + (GROUP_INDEX - 1) * 400` | グループX座標 |
| `{{NODE_OFFSET_Y}}` | `GROUP_OFFSET + NODE_INDEX * 180` | ノード個別Y座標 |
| `{{STICKY_NOTE_Y}}` | `GROUP_Y - 150` | Sticky Note Y座標（グループ上部） |

**間隔定数**:
- ノード間隔（垂直）: `180px`
- グループ間隔（水平）: `400px`
- レイヤー間隔（垂直）: `300px`

---

## 完全なワークフローJSONテンプレート例

```json
{
  "name": "{{WORKFLOW_NAME}}",
  "nodes": [
    {
      "id": "{{TRIGGER_NODE_UUID}}",
      "name": "{{TRIGGER_NODE_NAME}}",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [100, 100],
      "webhookId": "{{WEBHOOK_ID}}",
      "parameters": {
        "httpMethod": "POST",
        "path": "{{WEBHOOK_PATH}}",
        "responseMode": "responseNode"
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.query }}",
        "options": {
          "systemMessage": "{{SYSTEM_MESSAGE}}"
        }
      },
      "id": "{{AI_AGENT_NODE_ID}}",
      "name": "{{AI_AGENT_NODE_NAME}}",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [400, 300]
    },
    {
      "parameters": {
        "model": "{{LM_MODEL_NAME}}",
        "options": {
          "temperature": "{{LM_TEMPERATURE}}"
        }
      },
      "id": "{{LM_NODE_ID}}",
      "name": "{{LM_NODE_NAME}}",
      "type": "{{LM_NODE_TYPE}}",
      "typeVersion": 1,
      "position": [200, 200],
      "credentials": {
        "{{LM_CREDENTIAL_TYPE}}": {
          "id": "YOUR_CREDENTIAL_ID",
          "name": "YOUR_CREDENTIAL_NAME"
        }
      }
    },
    {
      "parameters": {
        "sessionKey": "={{MEMORY_SESSION_KEY}}",
        "contextWindowLength": {{MEMORY_CONTEXT_WINDOW_LENGTH}}
      },
      "id": "{{MEMORY_NODE_ID}}",
      "name": "{{MEMORY_NODE_NAME}}",
      "type": "{{MEMORY_NODE_TYPE}}",
      "typeVersion": 1.3,
      "position": [200, 400]
    },
    {
      "parameters": {
        "description": "{{TOOL_DESCRIPTION}}",
        "workflowId": "{{TOOL_WORKFLOW_ID}}"
      },
      "id": "{{TOOL_NODE_ID}}",
      "name": "{{TOOL_NODE_NAME}}",
      "type": "{{TOOL_NODE_TYPE}}",
      "typeVersion": 1.1,
      "position": [200, 600]
    },
    {
      "id": "{{RESPOND_UUID}}",
      "name": "{{RESPOND_NODE_NAME}}",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [700, 300],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      }
    },
    {
      "id": "{{STICKY_NOTE_UUID}}",
      "name": "Sticky Note - Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, -50],
      "parameters": {
        "content": "{{STICKY_NOTE_CONTENT}}",
        "height": 300,
        "width": 400,
        "color": 1
      }
    }
  ],
  "connections": {
    "{{TRIGGER_NODE_NAME}}": {
      "main": [[{"node": "{{AI_AGENT_NODE_NAME}}", "type": "main", "index": 0}]]
    },
    "{{LM_NODE_NAME}}": {
      "ai_languageModel": [
        [
          {
            "node": "{{AI_AGENT_NODE_NAME}}",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "{{MEMORY_NODE_NAME}}": {
      "ai_memory": [
        [
          {
            "node": "{{AI_AGENT_NODE_NAME}}",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "{{TOOL_NODE_NAME}}": {
      "ai_tool": [
        [
          {
            "node": "{{AI_AGENT_NODE_NAME}}",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "{{AI_AGENT_NODE_NAME}}": {
      "main": [[{"node": "{{RESPOND_NODE_NAME}}", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "{{TIMESTAMP}}",
  "versionId": "{{VERSION_ID}}"
}
```

**n8n-MCP検証**: この構造は実際のテンプレート（ID: 3805）と一致しています。

---

## ワークフロー全体用変数

### ワークフロー識別変数

| 変数名 | 型 | 説明 | 例 |
|--------|-----|------|-----|
| `{{WORKFLOW_NAME}}` | string | ワークフロー名 | `"Google Meet議事録自動化"` |
| `{{WORKFLOW_PURPOSE}}` | string | ワークフローの目的 | `"会議音声から議事録と次のアクションを自動生成"` |
| `{{WORKFLOW_BACKGROUND}}` | string | 背景・導入理由 | `"従来は手動で議事録作成に30分かかっていた"` |
| `{{WORKFLOW_GOAL}}` | string | 達成したいこと | `"議事録作成時間を30分→3分に短縮"` |
| `{{VERSION_ID}}` | string (UUID) | ワークフローバージョンID | `"abc12345-..."` |

### ノード数カウント変数

| 変数名 | 型 | 説明 | 例 |
|--------|-----|------|-----|
| `{{TOTAL_NODE_COUNT}}` | number | ワークフロー全体のノード数 | `15`, `30`, `50` |
| `{{GROUP_NODE_COUNT}}` | number | グループ内のノード数 | `5`, `8`, `12` |
| `{{LAYER_NODE_COUNT}}` | number | レイヤー内のノード数 | `3`, `7` |

---

## Sticky Note専用変数（Step180用）

### Pattern 1: 全体フロー用変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `{{NODE_1_NAME}}` | 1番目のノード名 | `"Webhook Trigger"` |
| `{{NODE_1_TYPE}}` | 1番目のノードタイプ | `"n8n-nodes-base.webhook"` |
| `{{NODE_2_NAME}}` | 2番目のノード名 | `"AI Agent"` |
| `{{NODE_N_NAME}}` | N番目のノード名 | `"Respond to Webhook"` |
| `{{PROBLEM_1}}` | 従来の課題1 | `"手動議事録作成に30分"` |
| `{{PROBLEM_N}}` | 従来の課題N | `"フォーマット統一が困難"` |
| `{{SOLUTION_SUMMARY}}` | ソリューション要約 | `"完全自動化により効率を10倍改善"` |
| `{{STEP_1}}` | 全体フロー手順1 | `"音声データ受信"` |
| `{{STEP_N}}` | 全体フロー手順N | `"議事録をSlack送信"` |

### Pattern 2: グループごと変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `{{GROUP_BACKGROUND}}` | グループの背景 | `"音声データの検証が必要"` |
| `{{PROCESSING_STEP_1}}` | 処理フロー手順1 | `"音声形式チェック"` |
| `{{PROCESSING_STEP_N}}` | 処理フロー手順N | `"エラー時はSlack通知"` |
| `{{NEXT_GROUP_NAME}}` | 次のグループ名 | `"音声文字起こしグループ"` |
| `{{CONNECTION_DESCRIPTION}}` | 接続の説明 | `"検証済み音声データを渡す"` |

---

## n8n Expression用変数

### 一般的なExpression

| 変数名 | Expression例 | 説明 |
|--------|-------------|------|
| `{{JSON_INPUT}}` | `={{ $json }}` | 前ノードのJSON出力 |
| `{{JSON_FIELD}}` | `={{ $json.fieldName }}` | JSONの特定フィールド |
| `{{NODE_OUTPUT}}` | `={{ $('Node Name').item.json }}` | 特定ノードの出力 |
| `{{ITEM_INDEX}}` | `={{ $itemIndex }}` | アイテムインデックス |
| `{{RUN_INDEX}}` | `={{ $runIndex }}` | 実行インデックス |
| `{{TODAY}}` | `={{ $now.toISO() }}` | 現在日時 |

### AI Agent専用Expression

| 変数名 | Expression例 | 説明 |
|--------|-------------|------|
| `{{USER_QUERY}}` | `={{ $json.chatInput }}` | ユーザークエリ |
| `{{CONTEXT_DATA}}` | `={{ $json.context }}` | コンテキストデータ |
| `{{PREVIOUS_RESULT}}` | `={{ $('Previous Step').item.json.result }}` | 前ステップの結果 |

---

## 使用例

### 例1: Webhook → AI Agent → Response の基本フロー

```json
{
  "name": "シンプルなAI応答ワークフロー",
  "nodes": [
    {
      "id": "uuid-webhook-1",
      "name": "リクエスト受付",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [100, 100],
      "webhookId": "simple-ai-webhook",
      "parameters": {
        "httpMethod": "POST",
        "path": "/ai-query",
        "responseMode": "responseNode"
      }
    },
    {
      "id": "uuid-ai-1",
      "name": "AI応答生成",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [100, 300],
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.query }}",
        "options": {
          "systemMessage": "あなたは親切なアシスタントです。簡潔に回答してください。"
        }
      }
    },
    {
      "id": "uuid-respond-1",
      "name": "応答返却",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [100, 500],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { result: $json.output } }}"
      }
    }
  ],
  "connections": {
    "リクエスト受付": {
      "main": [[{"node": "AI応答生成", "type": "main", "index": 0}]]
    },
    "AI応答生成": {
      "main": [[{"node": "応答返却", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
```

### 例2: Sticky Note（Pattern 1: 全体フロー用）

```json
{
  "id": "uuid-sticky-overview",
  "name": "Sticky Note - 全体フロー",
  "type": "n8n-nodes-base.stickyNote",
  "typeVersion": 1,
  "position": [100, 50],
  "parameters": {
    "content": "# 【Google Meet議事録自動化 - 全体フロー】\n\n## このワークフローに含まれる全ノード（15個）\n📌 **Webhook Trigger** (n8n-nodes-base.webhook)\n📌 **音声検証** (n8n-nodes-base.if)\n📌 **AI文字起こし** (@n8n/n8n-nodes-langchain.agent)\n...\n\n## このワークフローの目的\n会議音声から議事録と次のアクションを自動生成する\n\n## 背景\n従来は手動で議事録作成に30分かかっていた\n\n## 全体の流れ\n1. Google Meetから音声データを受信\n2. 音声をAIで文字起こし\n3. 議事録形式に整形\n4. Slackに送信",
    "height": 600,
    "width": 700,
    "color": 7
  }
}
```

### 例3: Sticky Note（Pattern 2: グループごと）

```json
{
  "id": "uuid-sticky-group-001",
  "name": "Sticky Note - G001",
  "type": "n8n-nodes-base.stickyNote",
  "typeVersion": 1,
  "position": [100, 200],
  "parameters": {
    "content": "# 【グループG001: 入力受付グループ】\n\n## このグループに含まれるノード\n📌 **Webhook Trigger** (n8n-nodes-base.webhook)\n📌 **音声形式チェック** (n8n-nodes-base.if)\n\n## 目的\nGoogle Meetからの音声データを受信し、形式を検証する\n\n## 背景\n不正な形式のデータはエラーを引き起こす可能性がある\n\n## 処理の流れ\n1. Webhookで音声データ受信\n2. 音声形式チェック（MP3/WAVのみ許可）\n3. サイズチェック（100MB以下）\n\n## 次のステップ\n→ 音声文字起こしグループへ（検証済み音声データを渡す）",
    "height": 350,
    "width": 500,
    "color": 2
  }
}
```

---

## テンプレート変数の命名規則

### 命名パターン

1. **すべて大文字**: `{{VARIABLE_NAME}}`
2. **アンダースコア区切り**: `{{MULTI_WORD_VARIABLE}}`
3. **明確な意味**: `{{WEBHOOK_PATH}}` ✅ ではなく `{{PATH}}` ❌
4. **スコープ接頭辞**: `{{NODE_ID}}`, `{{GROUP_ID}}`, `{{WORKFLOW_NAME}}`

### カテゴリ別接頭辞

| 接頭辞 | 意味 | 例 |
|--------|------|-----|
| `NODE_` | ノード関連 | `{{NODE_ID}}`, `{{NODE_NAME}}` |
| `GROUP_` | グループ関連 | `{{GROUP_ID}}`, `{{GROUP_NAME}}` |
| `LAYER_` | レイヤー関連 | `{{LAYER_ID}}`, `{{LAYER_Y}}` |
| `WORKFLOW_` | ワークフロー関連 | `{{WORKFLOW_NAME}}`, `{{WORKFLOW_PURPOSE}}` |
| `STICKY_NOTE_` | Sticky Note関連 | `{{STICKY_NOTE_CONTENT}}`, `{{STICKY_NOTE_COLOR}}` |
| `WEBHOOK_` | Webhook関連 | `{{WEBHOOK_PATH}}`, `{{WEBHOOK_ID}}` |
| `AI_AGENT_` | AI Agent関連 | `{{AI_AGENT_NAME}}`, `{{AI_AGENT_UUID}}` |

---

## テンプレート変数の検証

### n8n-MCP検証ツール

各テンプレートはn8n-MCPで検証可能：

```javascript
// ノード最小検証
validate_node_minimal("nodes-base.webhook", {
  "httpMethod": "POST",
  "path": "/test"
})

// ノード完全検証
validate_node_operation("nodes-base.webhook", {
  "httpMethod": "POST",
  "path": "/test",
  "responseMode": "responseNode"
})

// ワークフロー検証
validate_workflow(workflowJson)

// 接続検証
validate_workflow_connections(workflowJson)

// Expression検証
validate_workflow_expressions(workflowJson)
```

### 検証チェックリスト

- ✅ **必須プロパティ**: すべての必須プロパティが含まれているか
- ✅ **デフォルト値**: デフォルト値が正しいか
- ✅ **型**: 文字列、数値、真偽値が正しい型か
- ✅ **UUID**: すべてのノードIDがUUID形式か
- ✅ **Connections**: キーがnode nameを使用しているか（idではない）
- ✅ **Sticky Note**: height, width, colorすべて含まれているか

---

## 注意事項

### 重要な発見（n8n-MCP検証結果）

1. **Sticky Noteの必須プロパティ**:
   - `height`, `width`, `color` のすべてが必須
   - `color: null` は無効 → `color: 1`（デフォルト）を使用

2. **AI Agentの System Prompt**:
   - プロンプト内で「System Prompt」と記載
   - 実際は `options.systemMessage` パラメータで設定

3. **Connectionsのキー**:
   - ノードの `name` を使用（`id` ではない）
   - 実際のテンプレート（ID: 3805）で確認済み

4. **typeVersionの重要性**:
   - ノードタイプごとに異なるバージョンがある
   - Webhook: 2.1, AI Agent: 3, Sticky Note: 1

---

## まとめ

このドキュメントで定義した汎用テンプレート変数を使用することで：

✅ **再利用性**: どんなn8nワークフローにも適用可能
✅ **一貫性**: すべてのステップで同じ変数名を使用
✅ **検証済み**: n8n-MCPで実際のn8nノードと照合済み
✅ **保守性**: 変数名が明確で意味が分かりやすい

**総変数数**: 約60個
**カテゴリ数**: 11カテゴリ
**n8n-MCP検証**: ✅ すべて検証済み

---

**作成日**: 2025-11-10
**最終更新**: 2025-11-10
**n8n-MCP検証ステータス**: ✅ 完了