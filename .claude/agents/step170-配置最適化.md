# Step170: 配置最適化

## 目的

Step150で統合されたワークフローJSONに対して、ノードの視覚的配置を最適化し、可読性と保守性を最大化します。12層アーキテクチャとグループ構造を視覚的に表現する論理的な配置設計を実現します。

**最終成果物:**
- 配置最適化されたワークフローJSON（全ノードのposition更新済み）
- 配置設計ドキュメント（配置ロジックの説明）
- 視覚的レイアウト図（ASCII artまたは説明）

---

## 背景

### Step170が必要な理由

1. **可読性の向上**: 論理的な配置により、ワークフローの理解が容易になる
2. **保守性の向上**: グループとレイヤーが視覚的に明確になり、修正が簡単になる
3. **アーキテクチャの可視化**: 12層構造が一目で理解できる配置
4. **チーム協業の促進**: 統一された配置ルールにより、チームメンバー間の理解が統一される
5. **デバッグの効率化**: データフローが視覚的に追跡しやすい配置

### v4.0における配置最適化の位置づけ

```
Phase 3: 統合・検証・出力 (Step150-190)
├─ Step150: グループ間接続統合 ✅
├─ Step160: ワークフロー全体検証 ✅
├─ Step170: 配置最適化 ← 現在のステップ
├─ Step180: Sticky Note完成
└─ Step190: 最終出力
```

### 従来手法との違い

| 観点 | 従来手法 | v4.0 Step170 |
|------|---------|-------------|
| 配置方針 | ランダムまたは手動配置 | レイヤー・グループベースの体系的配置 |
| 可読性 | 配置者の感覚に依存 | 定量的な間隔・配置ルール適用 |
| スケーラビリティ | 大規模ワークフローで配置が困難 | 40グループでも論理的配置が可能 |
| 保守性 | 配置意図が不明確 | 配置設計ドキュメントで意図を明示 |

---

## 言葉の定義

### 配置関連用語

1. **レイヤー配置 (Layer Placement)**
   - 12層アーキテクチャ (L1-L12) に基づく垂直方向の配置
   - Y座標で表現され、上から下へデータフローを表現

2. **グループ配置 (Group Placement)**
   - 機能グループ（G001-G040）ごとの水平方向の配置
   - X座標で表現され、並列処理や独立した機能を左右に配置

3. **ノード間隔 (Node Spacing)**
   - 同一グループ内のノード間の垂直間隔: 推奨180px
   - 同一レイヤー内のグループ間の水平間隔: 推奨300px

4. **基準点 (Origin Point)**
   - 配置計算の起点座標: [100, 100]
   - Triggerノードまたは最初のグループの左上位置

5. **接続ライン (Connection Line)**
   - ノード間を結ぶ視覚的な線
   - 直線配置を優先し、交差を最小化

6. **Sticky Note配置 (Sticky Note Placement)**
   - グループタイトル用Sticky Noteの配置
   - グループの左上、ノードの上部に配置

### n8n座標系

```
(0, 0) ────────────→ X軸
  │
  │   [100, 100] ← 基準点
  │      │
  │      ▼
  │   ┌─────────┐
  │   │  Node   │
  │   └─────────┘
  ▼
 Y軸
```

- **X座標**: 左から右へ増加（水平位置）
- **Y座標**: 上から下へ増加（垂直位置）
- **推奨範囲**: X: 0-5000, Y: 0-10000

---

## 制約

### 配置設計の制約

1. **n8nキャンバス制約**
   - 座標系: [x, y] の2次元配列
   - 実用的な範囲: X: 0-5000, Y: 0-10000
   - ノードサイズ: 約 240px × 100px

2. **視覚的ベストプラクティス**
   - ノード間の最小間隔: 縦180px、横300px
   - レイヤー間の垂直間隔: 300px
   - グループ間の水平間隔: 400px

3. **可読性の制約**
   - 1レイヤーあたりの最大グループ数: 5グループ（水平方向）
   - 1グループあたりの最大ノード数: 8ノード（垂直方向）
   - 接続ラインの交差を最小化

4. **論理的制約**
   - データフローは上から下へ（Y座標増加方向）
   - 並列処理は左から右へ（X座標増加方向）
   - エラーフローは右側または下部に配置

5. **Sticky Note制約**
   - グループタイトル用Sticky Noteはグループの左上に配置
   - 最小サイズ: 240px × 100px
   - テキストの可読性を確保

---

## 処理手順

### ステップ1: 入力確認と配置戦略決定

**目的**: 統合ワークフローJSONを読み込み、配置戦略を決定

**処理内容**:

1. **ワークフローJSON読み込み**
   ```json
   {
     "nodes": [ /* Step150で統合されたノード配列 */ ],
     "connections": { /* 接続情報 */ }
   }
   ```

2. **ノード分類**
   - Triggerノード特定
   - レイヤー別ノード分類（L1-L12）
   - グループ別ノード分類（G001-G040）
   - エラーフローノード特定

3. **配置戦略決定**
   - メインフローの配置方針: レイヤーベース垂直配置
   - エラーフローの配置方針: 右側または下部に分離配置
   - 並列グループの配置方針: 水平方向に展開

**出力例**:
```markdown
## 配置戦略

### メインフロー配置
- レイヤー数: 7層 (L1, L2, L3, L5, L7, L8, L9)
- グループ数: 25グループ (G001-G025)
- 配置方針: レイヤー垂直配置 + グループ水平展開

### エラーフロー配置
- エラーグループ数: 5グループ (E001-E005)
- 配置方針: 右側に独立配置

### 並列処理配置
- 並列グループ: G003, G004, G005 (L3で並列)
- 配置方針: X座標を異なる値に設定
```

---

### ステップ2: レイヤー別Y座標計算

**目的**: 12層アーキテクチャに基づく垂直方向（Y座標）の配置計算

**処理内容**:

1. **レイヤー出現順序の特定**
   - 実際に使用されているレイヤーのみを抽出
   - 例: L1, L2, L3, L5, L7, L8, L9 (L4, L6, L10-L12は未使用)

2. **Y座標計算式**
   ```
   基準Y座標 = 100
   レイヤー間隔 = 300
   グループ内ノード間隔 = 180

   レイヤーY[Ln] = 基準Y + (n-1) × レイヤー間隔
   ノードY[i] = レイヤーY + i × ノード間隔
   ```

3. **計算例**
   ```
   L1 (入力層):     Y = 100
   L2 (検証層):     Y = 400   (100 + 300)
   L3 (変換層):     Y = 700   (400 + 300)
   L5 (AI処理層):   Y = 1000  (700 + 300)
   L7 (出力層):     Y = 1300  (1000 + 300)
   ```

4. **グループ内ノード配置**
   - 同一グループ内のノードは垂直方向に180px間隔で配置
   - 例: G001内に3ノード存在する場合
     - Node1: Y = 100
     - Node2: Y = 280 (100 + 180)
     - Node3: Y = 460 (280 + 180)

**出力例**:
```json
{
  "layerYCoordinates": {
    "L1": 100,
    "L2": 400,
    "L3": 700,
    "L5": 1000,
    "L7": 1300,
    "L8": 1600,
    "L9": 1900
  }
}
```

---

### ステップ3: グループ別X座標計算

**目的**: グループごとの水平方向（X座標）の配置計算

**処理内容**:

1. **同一レイヤー内のグループ数カウント**
   - 各レイヤーに存在するグループ数を集計
   - 並列処理グループを特定

2. **X座標計算式**
   ```
   基準X座標 = 100
   グループ間隔 = 400

   グループX[i] = 基準X + i × グループ間隔
   ```

3. **並列グループ配置**
   - 同一レイヤー内に複数グループが存在する場合、X座標を異なる値に設定
   - 例: L3に G003, G004, G005 が存在
     - G003: X = 100
     - G004: X = 500  (100 + 400)
     - G005: X = 900  (500 + 400)

4. **エラーフロー配置**
   - エラーグループは右側に独立配置
   - X座標 = メインフロー最大X + 600
   - 例: メインフロー最大X = 1300 の場合
     - エラーフロー: X = 1900

**出力例**:
```json
{
  "groupXCoordinates": {
    "G001": 100,
    "G002": 100,
    "G003": 100,
    "G004": 500,
    "G005": 900,
    "G006": 100,
    "E001": 1900,
    "E002": 1900
  }
}
```

---

### ステップ4: ノード位置の更新

**目的**: 計算されたX/Y座標を各ノードのpositionフィールドに反映

**処理内容**:

1. **ノード位置計算**
   - レイヤーY座標 + グループX座標 + グループ内オフセット
   - 各ノードに一意の座標を割り当て

2. **position更新**
   ```json
   {
     "id": "node_123",
     "name": "AI Agent",
     "type": "@n8n/n8n-nodes-langchain.agent",
     "position": [500, 1000],  // [X, Y]
     "parameters": { /* ... */ }
   }
   ```

3. **グループ内オフセット計算**
   - 同一グループ内でノードが重ならないように垂直オフセットを追加
   - グループ内インデックス × 180px

4. **全ノード更新**
   - nodes配列内の全ノードのpositionを更新
   - Sticky Noteも含めて更新

**実装例**:
```javascript
// 疑似コード
nodes.forEach(node => {
  const layer = node._comment.layer;      // 例: "L5"
  const group = node._comment.group;      // 例: "G010"
  const groupIndex = getGroupIndex(node, group);  // グループ内インデックス

  const baseY = layerYCoordinates[layer];
  const baseX = groupXCoordinates[group];

  node.position = [
    baseX,
    baseY + (groupIndex * 180)
  ];
});
```

**出力例**:
```json
{
  "nodes": [
    {
      "id": "trigger_001",
      "name": "Webhook Trigger",
      "position": [100, 100],
      "_comment": { "layer": "L1", "group": "G001" }
    },
    {
      "id": "agent_001",
      "name": "AI Agent - User Query",
      "position": [100, 1000],
      "_comment": { "layer": "L5", "group": "G010" }
    },
    {
      "id": "output_001",
      "name": "Respond to Webhook",
      "position": [100, 1300],
      "_comment": { "layer": "L7", "group": "G015" }
    }
  ]
}
```

---

### ステップ5: 接続ライン最適化（オプション）

**目的**: ノード間の接続ラインが視覚的に明確になるよう配置を微調整

**処理内容**:

1. **接続パターン分析**
   - connectionsオブジェクトから接続関係を抽出
   - 交差する接続ラインを特定

2. **交差最小化調整**
   - 交差が発生する場合、ノードのX座標を微調整
   - 調整幅: ±50px 以内

3. **長距離接続の最適化**
   - レイヤーを跨ぐ接続（例: L1 → L5）の視覚的明確化
   - 中間ノードが存在する場合、配置を調整

**注意**: このステップはオプションです。基本配置で十分な場合はスキップ可能。

---

### ステップ6: Sticky Note位置調整

**目的**: グループタイトル用Sticky Noteを適切な位置に配置

**処理内容**:

1. **Sticky Note特定**
   - type: "@n8n/n8n-nodes-base.stickyNote"
   - グループタイトル用Sticky Noteを抽出

2. **配置ルール**
   - グループの左上に配置
   - グループ内最初のノードのY座標 - 150px
   - グループのX座標と同じ

3. **position更新**
   ```json
   {
     "id": "sticky_g001",
     "name": "📌 G001: 入力受付グループ",
     "type": "@n8n/n8n-nodes-base.stickyNote",
     "position": [100, -50],  // グループG001の上部
     "parameters": {
       "content": "## G001: 入力受付グループ\n\n**ノード一覧:**\n- Webhook Trigger\n- Input Validation"
     }
   }
   ```

**出力例**:
```json
{
  "nodes": [
    {
      "id": "sticky_g001",
      "position": [100, -50],
      "_comment": { "group": "G001", "purpose": "グループタイトル" }
    },
    {
      "id": "sticky_g010",
      "position": [100, 850],
      "_comment": { "group": "G010", "purpose": "グループタイトル" }
    }
  ]
}
```

---

### ステップ7: 配置設計ドキュメント作成

**目的**: 配置ロジックと配置結果を文書化

**処理内容**:

1. **配置ルールの記述**
   - レイヤー配置ルール
   - グループ配置ルール
   - ノード間隔ルール

2. **配置マップ作成**
   - ASCII artで視覚的レイアウトを表現
   - 各グループの位置を示す

3. **配置統計**
   - レイヤー数、グループ数、ノード総数
   - X座標範囲、Y座標範囲
   - 最大グループサイズ

**出力例**:
```markdown
# 配置設計ドキュメント

## 配置ルール

### レイヤー配置
- 基準Y座標: 100
- レイヤー間隔: 300px
- 使用レイヤー: L1, L2, L3, L5, L7, L8, L9

### グループ配置
- 基準X座標: 100
- グループ間隔: 400px
- 並列グループ: L3に3グループ並列

### ノード間隔
- 垂直間隔: 180px（同一グループ内）
- 水平間隔: 400px（並列グループ間）

## 配置マップ

```
Y=100  [L1: G001]              [E001]
Y=400  [L2: G002, G003]        [E002]
Y=700  [L3: G004][G005][G006]
Y=1000 [L5: G010]
Y=1300 [L7: G015]
       X=100  X=500  X=900     X=1900
```

## 配置統計

- レイヤー数: 7層
- グループ数: 25グループ（メイン） + 5グループ（エラー）
- ノード総数: 87ノード
- X座標範囲: 100 - 1900
- Y座標範囲: 100 - 2000
- 最大グループサイズ: 8ノード（G010）
```

---

## 初回質問

Step170を開始する前に、以下を確認させてください:

### 1. 入力ファイルの確認

**質問**: Step150で出力された統合ワークフローJSONファイルのパスを教えてください。

**回答例**:
```
ファイルパス: ./output/integrated_workflow.json
```

---

### 2. 配置戦略の確認

**質問**: 以下の配置戦略で問題ありませんか？特別な配置要件がある場合は教えてください。

**デフォルト戦略**:
- レイヤー垂直配置（上から下へデータフロー）
- グループ水平展開（並列処理は左右に配置）
- エラーフローは右側に分離配置
- ノード間隔: 縦180px、横400px

**追加要件例**:
- 「エラーフローは下部に配置したい」
- 「特定のグループを目立たせたい」
- 「より密な配置にしたい（間隔を縮める）」

---

### 3. 視覚的出力の希望

**質問**: 配置結果の視覚的確認方法についてどれを希望しますか？

**選択肢**:
a) ASCII artレイアウト図（テキストベース）
b) 配置座標リスト（JSON形式）
c) 両方

**回答例**:
```
選択: c) 両方
```

---

### 4. カスタマイズ要件

**質問**: 以下のカスタマイズ要件はありますか？

**チェックリスト**:
- [ ] 特定のグループを異なる位置に配置したい
- [ ] ノード間隔を変更したい（標準: 縦180px、横400px）
- [ ] Sticky Noteの配置位置を変更したい
- [ ] エラーフローの配置位置を変更したい（デフォルト: 右側）

**回答例**:
```
- [x] ノード間隔を変更: 縦200px、横500pxにしたい
- [ ] その他は標準のまま
```

---

## 次のステップ

Step170完了後、以下のステップに進みます:

1. **Step180: Sticky Note完成**
   - 各Sticky Noteに詳細な説明を追加
   - ノード一覧、責務、入出力情報を記載

2. **Step190: 最終出力**
   - 完成したワークフローJSONの最終出力
   - メタデータJSON、README、実装ガイド作成

---

## 補足情報

### 配置ベストプラクティス

1. **可読性優先**: 複雑な配置よりシンプルで理解しやすい配置を優先
2. **一貫性**: 同じルールを全グループに適用
3. **スケーラビリティ**: 将来のグループ追加を考慮した配置間隔
4. **データフロー可視化**: 上から下、左から右のフロー表現

### 参考: n8nキャンバスの特性

- ノードサイズ: 約240px × 100px
- 推奨ズームレベル: 100%
- キャンバススクロール: 自由にスクロール可能
- 接続ライン: 自動描画（n8nが制御）

---

**このプロンプトを実行すると、Step170の処理が開始されます。上記の初回質問に回答することで、最適な配置設計が実現されます。**
