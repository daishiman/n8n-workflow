# エージェント開発ガイドライン

このドキュメントは、n8nワークフロー自動設計システムにおけるAIエージェント開発のガイドラインを提供します。

## 目的

Claude Code（AI CLI）を使用してn8nワークフローを自動生成するための標準化されたプロセスとベストプラクティスを定義します。

## エージェントの役割と責務

### フェーズ1: 要件定義・設計エージェント

#### システムアーキテクト（Step010, 030, 040）
- **参照**: グレディ・ブーチ『オブジェクト指向分析設計』
- **役割**: 業務要件の構造化と12層アーキテクチャへのマッピング
- **責務**:
  - 12要素フレームワークによる要件収集
  - 業務要件の層別分解
  - タスクの適切な粒度への分解とグループ化

#### データエンジニア（Step030）
- **参照**: マーティン・クレップマン『データ指向アプリケーション設計』
- **役割**: データフロー層（L1-L7）の設計
- **責務**:
  - 各層へのn8nノードタイプの割り当て
  - データフローの明確化
  - データ変換ロジックの設計

#### SREエンジニア（Step030）
- **役割**: 横断的関心事層（L8-L12）の設計
- **責務**:
  - エラーハンドリング戦略の定義
  - セキュリティ要件の実装計画
  - 監視とパフォーマンス最適化の設計

#### n8nエキスパート（Step030, 050, 060）
- **役割**: n8n固有の技術要件の適用
- **責務**:
  - n8n-MCPを使用した最適ノード選定
  - AI Agent Nodeの責務定義
  - ベストプラクティスパターンの適用

#### テクニカルライター（Step010-060, 150-190）
- **役割**: ドキュメンテーションの完全性と一貫性の確保
- **責務**:
  - 各ステップの成果物作成
  - 技術要件書の統合
  - 最終実装パッケージの文書化

### フェーズ2: JSON生成エージェント

#### データフローエンジニア（Step070-149）
- **役割**: グループ単位のワークフローJSON生成
- **責務**:
  - テンプレートに基づくJSON生成
  - ノードパラメータの具体化
  - データフロー表現（n8n Expression）の設計

### フェーズ3: 統合・検証エージェント

#### 統合エンジニア（Step150）
- **役割**: グループ間接続の統合
- **責務**:
  - 全グループJSONの統合
  - ノード接続の一貫性確保
  - 座標計算と配置調整

#### 品質保証エンジニア（Step160）
- **役割**: ワークフロー全体の検証
- **責務**:
  - n8n-MCPによる包括的検証
  - 接続整合性チェック
  - エラーハンドリングの検証

#### UIデザイナー（Step170, 180）
- **役割**: ビジュアル配置とSticky Note設計
- **責務**:
  - ノードの視覚的配置最適化
  - Sticky Noteの詳細説明追加
  - 色とサイズのポリシー適用

## エージェント実行パターン

### 単一エージェント実行
各ステップは単一のエージェントが責任を持って実行：
```
Step010: システムアーキテクト → 業務理解書
Step020: AIエキスパート → AI設定書
Step030: システムアーキテクト + データエンジニア + SRE → 技術要件書
```

### マルチエージェント協調
複雑なステップでは複数エージェントが協調：
```
Step030（技術要件変換）:
1. システムアーキテクト: 業務要件の層別分解
2. データエンジニア: データフロー層マッピング
3. SREエンジニア: 横断的関心事層マッピング
4. n8nエキスパート: ノード選定
5. テクニカルライター: 技術要件書統合
```

### テンプレート駆動実行
Phase 2では同一テンプレートを複数グループに適用：
```
step070-メインフローグループJSON生成テンプレート.md
  ↓ [N]=1, [グループ名]=データ受信初期化
Group 1 JSON生成
  ↓ [N]=2, [グループ名]=入力検証前処理
Group 2 JSON生成
  ...
```

## プロンプト設計原則

### 構造化フォーマット
すべてのプロンプトは以下の構造に従う：
```markdown
# 目的
[ステップの明確な目的]

# 背景
[なぜこのステップが重要か]

# 言葉の定義
[ユーザー独自の用語定義]

# 制約
[出力制約、技術制約など]

# 処理手順
## 処理手順の全体フロー
[Mermaid図など]

## 処理手順1-N
- 目的: [...]
- 背景: [...]
- エージェント名: [実在する専門家・フレームワーク]
- 役割: [...]
- 責務: [...]
- 処理詳細手順: [...]
- 評価・判断基準: [...]
- 出力テンプレート: [...]

# 初回質問
[ユーザーに最初に尋ねる質問]
```

### エージェント名の明示
各処理手順には以下を明記：
- **エージェント名**: 実在する書籍・専門家・フレームワーク
- **役割**: 手順における具体的な役割
- **責務**: エージェントの具体的な責務

### 評価基準の明確化
各処理手順の成功基準を定量的・定性的に明記：
- 定量的基準: ノード数、トークン数、処理時間など
- 定性的基準: 完全性、一貫性、妥当性など

### 出力テンプレートの提供
各処理手順に具体的な出力フォーマットを提供：
```markdown
## 処理手順1: 業務要件の層別分解
- 出力テンプレート:
```markdown
### 業務要件の層別分解

| 層 | 業務要件 | 該当要素 |
|----|---------|---------|
| L1: Trigger | [トリガー条件] | Webhook経由で議事録JSON受信 |
| ... | ... | ... |
```
```

## n8n-MCP統合ガイドライン

### ノード検索
```javascript
// 適切なノードを検索
search_nodes({
  query: "webhook",
  category: "trigger"
})

// AI関連ノードを検索
search_nodes({
  query: "ai agent",
  includeExamples: true
})
```

### ノード詳細取得
```javascript
// ノードの基本情報を取得
get_node_essentials({
  nodeType: "n8n-nodes-base.webhook",
  includeExamples: true
})

// 読みやすいドキュメントを取得
get_node_documentation({
  nodeType: "@n8n/n8n-nodes-langchain.agent"
})
```

### ノード設定検証
```javascript
// 設定の妥当性を検証
validate_node_operation({
  nodeType: "n8n-nodes-base.webhook",
  config: {
    path: "receive-minutes",
    method: "POST"
  }
})
```

### ワークフロー全体検証
```javascript
// 完全なワークフローを検証
validate_workflow({
  workflow: {
    nodes: [...],
    connections: {...}
  }
})
```

## 品質保証

### コード品質
- すべてのJSON出力はn8n-MCPで検証
- typeVersionは最新を使用
- 必須パラメータはすべて定義
- ノード間の接続互換性を確認

### ドキュメント品質
- 各ステップの成果物は完全で一貫性がある
- 技術用語は「言葉の定義」で定義
- 出力テンプレートに従った形式

### プロセス品質
- 各ステップ完了後にユーザー確認
- フィードバックに基づく修正
- 12層アーキテクチャの完全適用

## ベストプラクティス

### 単一責任の原則
各エージェント・各ステップは単一の明確な責務を持つ：
- ✅ 良い例: Step010は業務理解のみに専念
- ❌ 悪い例: Step010で業務理解とAI設定を同時実行

### 完全性の原則
開始した実装は必ず完成させる：
- ✅ 良い例: すべてのノードに完全なパラメータ設定
- ❌ 悪い例: TODOコメントやプレースホルダーを残す

### 検証優先の原則
すべての出力をn8n-MCPで検証：
- ✅ 良い例: JSON生成後、validate_workflowで検証
- ❌ 悪い例: 検証なしでJSONを出力

### データフロー明示の原則
データの流れを常に明確にする：
- ✅ 良い例: `{{ $json.body.title }}` で明示的に参照
- ❌ 悪い例: 暗黙的なデータ受け渡し

## トラブルシューティング

### よくある問題

**Q: グループ数が30を超える**
- A: Step040でタスクを再分解し、グループを統合する

**Q: トークン数が2500を超える**
- A: グループサイズを縮小（5-15ノード → 3-5ノード）

**Q: n8n-MCP検証エラー**
- A: エラーメッセージを確認し、Step060を修正後、再生成

**Q: Sticky Noteが正しく表示されない**
- A: サイズを確認（最小760×650 or 540×420）、色を確認（白系0/1は禁止）

## 参考資料

### 必読ドキュメント
- [README.md](../README.md) - プロジェクト全体概要
- [CLAUDE.md](../CLAUDE.md) - Claude Code向けガイド
- [.claude/agents/README.md](../.claude/agents/README.md) - プロンプト集概要
- [.github/GIT_WORKFLOW.md](GIT_WORKFLOW.md) - Gitワークフロー

### 技術参考書籍
- グレディ・ブーチ『オブジェクト指向分析設計』
- マーティン・クレップマン『データ指向アプリケーション設計』
- n8n公式ドキュメント: https://docs.n8n.io/

## バージョン履歴

- **v4.0** (2025-11-11): 12層アーキテクチャ対応、n8n-MCP統合
- **作成者**: Claude Code (Anthropic)
