# グループ構成表 (Step040) - 統合最終版

**作成日**: 2025-11-12
**バージョン**: v4.0統合版（4パターンマージ + Step010/020/030完全準拠）
**ワークフロー名**: GoogleDrive 動画自動議事録生成システム v4.0
**総ノード数**: 31ノード（メイン26 + エラー5）
**総グループ数**: 12グループ（メイン9 + エラー3）

---

## 📋 統合プロセス

このドキュメントは以下の4つのバリエーションとStep010-030の内容を統合して作成されました：

| バリエーション | メイングループ | エラーグループ | 総ノード数 | 音声文字起こし | 採用理由 |
|--------------|--------------|--------------|----------|--------------|---------|
| v1（ベース） | 9 | 1 | 28 | **Fireworks Whisper v3** | ✅ Step010/020要件準拠 |
| v2 | 12 | 1 | 55 | Gemini | エラー統合設計 |
| v3 | 6 | 3 | 57 | Gemini | L9-L12横断的関心事の詳細設計 |
| v4 | 9 | 3 | 57 | Gemini | n8n-MCP検証詳細 |

**統合方針**:
- ✅ **音声文字起こし**: Fireworks Whisper v3（v1準拠、Step010/020必須要件）
- ✅ **グループ構成**: v1の9メイングループをベース
- ✅ **エラーハンドリング**: v3/v4の3エラーグループ詳細分類を採用
- ✅ **横断的関心事**: v3のL9-L12明確化を統合
- ✅ **Step5追加**: Step020の議題別マッピングステップを反映

---

## 総ノード数の見積もり

| 層 | ノード数 | 内訳 | 根拠 |
|----|---------|------|------|
| L1: Trigger | 1 | Google Drive Trigger 1個 | Step030: #1 |
| L2: Input | 3 | Google Drive 2個（情報取得、ダウンロード）+ Set初期化 1個 | Step030: #2-3 + v3強化 |
| L3: Validation | 2 | Filter 1個 + Code（サイズ/重複判定）1個 | Step030: #4 + v3強化 |
| L4: Transformation | 9 | HTTP Request 1個（Fireworks）+ Code 4個（チャンク分割、重複除去x2、議題再構成）+ Set 2個（メタ整形） | Step030: #5-6, #10, #13, #17 + v3強化 |
| L5: Core Logic | 6 | AI Agent 6個（Step1-6）: Gemini×4 + Claude×2 | Step030: #8, #11, #12, #15, #18, #19 |
| L6: Integration | 4 | Google Drive 2個（保存、移動）+ HTTP Request 1個（Discord）+ Set 1個（連携結果） | Step030: #20-22 + v3強化 |
| L7: Output | 1 | Set 1個（最終結果） | Step030: #23 |
| L11: Performance | 4 | Split in Batches 2個 + Merge 2個 | Step030: #7, #9, #14, #16 |
| L8: Error（別WF） | 6 | Error Trigger 1個 + Code 2個（分類・整理）+ IF 1個 + Google Drive 1個 + HTTP Request 1個 | Step030: E1-E5 + v3/v4強化 |
| L9: Security | 1 | Set: Credential Health Gate（API Key存在確認） | v3追加 |
| L10: Monitoring | 1 | HTTP Request: Audit Log送信 | v3追加 |
| **合計** | **31ノード** | メイン26 + エラー5 | ✅ 10-50の範囲内 |

---

## グループ化戦略

**選択戦略**: **Pattern A（層単位グループ化）+ 並列処理の独立グループ化**

**ワークフロー特性**:
- 総ノード数: 31ノード（メイン26ノード）
- フロー複雑度: 中程度（層単位+並列処理あり）
- 並列処理: あり（チャンク5並列、議題3並列）

**理由**:
- ノード数は31個で、12層アーキテクチャに沿った構成
- 層単位でグループ化することで、設計と実装が直観的
- 並列処理部分（チャンク処理、議題処理）は独立したグループとして分離
- AI Agent（L5）が6個あるため、機能的なまとまりでグループ化
- **Fireworks Whisper v3**の超高速処理（4秒）を活用

---

## メインフローグループ構成

| Group ID | Group Name | 層 | ノード数 | 責務 | 依存関係 |
|----------|-----------|---|---------|------|---------|
| 1 | データ受信・検証 | L1-L3 | 6 | Google Driveトリガー、ファイル情報取得、M4Aダウンロード、初期化、ファイル形式検証 | - |
| 2 | 音声文字起こし・チャンク分割 | L4-L11 | 4 | **Fireworks Whisper v3文字起こし**、メタ整形、チャンク分割、並列バッチ開始 | Group 1 |
| 3 | 文字起こし整形（並列） | L5 | 1 | AI Agent Step1: 文字起こし整形（Gemini、5並列） | Group 2 |
| 4 | チャンク統合・議題抽出 | L11+L4+L5 | 4 | チャンク統合、重複除去、AI Agent Step2: 議題抽出（Gemini + Memory） | Group 3 |
| 5 | 議題別マッピング | L5 | 1 | AI Agent Step3: 議題別文字起こしマッピング（Gemini + Memory） | Group 4 |
| 6 | 議題データ再構成・並列処理 | L4-L11 | 3 | 議題データ再構成、並列バッチ開始、AI Agent Step4準備 | Group 5 |
| 7 | 議題分析（並列） | L5 | 1 | AI Agent Step4: 議題分析（Gemini、3並列） | Group 6 |
| 8 | 議題統合・フォーマット変換 | L11+L4+L5 | 4 | 議題統合、重複除去、AI Agent Step5: フォーマット変換（Claude + Memory） | Group 7 |
| 9 | 品質保証・出力・監視 | L5-L7+L9-L10 | 6 | AI Agent Step6: 品質保証（Claude + Memory）、議事録保存、M4A移動、Discord通知、結果セット、監査ログ送信 | Group 8 |

**総グループ数**: 9グループ
**総ノード数**: 26ノード（メインワークフロー）

**グループサイズ分析**:
- 最小: 1ノード（Group 3, 5, 7）
- 最大: 6ノード（Group 1, 9）
- 平均: 2.89ノード/グループ
- ✅ すべてのグループが推奨範囲内（3-15ノード、例外: 1-10ノード）

### グループ詳細説明

#### Group 1: データ受信・検証（L1-L3、6ノード）

**目的**: Google Drive監視、ファイルメタ情報補正、形式・サイズ検証を一気通貫で処理

**主要ノード**:
1. Google Drive Trigger（fileCreated、5分ポーリング）
2. Google Drive: Get File（メタ情報取得）
3. Google Drive: Download（M4Aバイナリ `m4a_data`）
4. Set: 初期メタ格納（owner、会議名推定）
5. Filter: MIME/サイズバリデーション（mimeType=audio/m4a、size<1GB）
6. Code: ファイル名/タイムスタンプ整形

**成功基準**: 100%のM4AファイルでmimeType=audio/m4aかつサイズ<1GBを保証

**Sticky Note**: 色2（薄緑）、540×420

```markdown
### 🔗 関連ノードブロック
- Google Drive Trigger (Trigger / node_g1_01): 5分ごとにM4Aファイル検知
- Drive: Get File Info (Google Drive / node_g1_02): メタデータ取得
- Drive: Download Binary (Google Drive / node_g1_03): M4Aバイナリダウンロード
- Set: Intake Metadata (Set / node_g1_04): owner、会議名を初期化
- Filter: MIME & Size Check (Filter / node_g1_05): 形式・サイズ検証
- Code: Filename Normalizer (Code / node_g1_06): ファイル名整形

**データフロー**: Google Drive → メタ情報 → バイナリ → 初期化 → 検証 → 整形
```

---

#### Group 2: 音声文字起こし・チャンク分割（L4-L11、4ノード）

**目的**: **Fireworks AI Whisper v3**でネイティブ文字起こし、チャンク分割、並列バッチ開始

**主要ノード**:
1. HTTP Request: **Fireworks Whisper v3文字起こし**（model: whisper-v3-large、diarization: true、language: ja）
2. Set: メタ整形（transcript情報整理）
3. Code: チャンク分割（20-30行 + オーバーラップ6行）
4. Split in Batches: チャンク並列処理（batchSize=5）

**成功基準**: **4秒以内**・字幕行100%生成、speaker/timestamp維持

**Sticky Note**: 色3（薄青）、580×440

```markdown
### 🔗 関連ノードブロック
- HTTP Request: Fireworks Whisper v3 (HTTP Request / node_g2_01): **1時間音声を4秒で処理**（Deepgram比95%高速化）
  - API: https://api.fireworks.ai/v1/audio/transcriptions
  - Model: whisper-v3-large
  - Diarization: true（話者分離）
  - Language: ja（日本語）
  - Cost: $0.0021/分（Deepgram比99%削減）
- Set: Transcript Metadata (Set / node_g2_02): メタ整形
- Code: Chunk Builder (Code / node_g2_03): 25行 + オーバーラップ6行
- Split in Batches: chunkBatch (Split in Batches / node_g2_04): 5並列

**データフロー**: M4A → Fireworks文字起こし（4秒） → メタ整形 → チャンク分割 → 並列開始
**パフォーマンス**: 従来Gemini 45秒 → **Fireworks 4秒**（91%削減）
```

---

#### Group 3: 文字起こし整形（並列）（L5、1ノード）

**目的**: 5チャンク並列でフィラー除去・箇条書き整形

**主要ノード**:
1. AI Agent Step1: 文字起こし整形（Gemini 2.5 Flash、temperature=0.4、maxTokens=4000）
   - systemMessage: 議事録作成専門家、フィラー除去、箇条書き化
   - リトライ: maxTries=3、waitBetweenTries=1000

**成功基準**: チャンクあたり1,300 tokens以内、バッチ成功率100%

**Sticky Note**: 色4（薄紫）、540×420

```markdown
### 🔗 関連ノードブロック
- AI Agent Step1 (AI Agent / node_g3_01): フィラー除去、箇条書き化
  - Model: Gemini 2.5 Flash
  - Temperature: 0.4
  - 並列: 5チャンク同時処理
  - リトライ: 最大3回
  - Memory: なし（オーバーラップで文脈確保）

**ループ構造**: Split in Batches (Output 1) → AI Agent → Split in Batches（ループバック）
**完了条件**: Split in Batches (Output 0) → Merge（次グループへ）
```

---

#### Group 4: チャンク統合・議題抽出（L11+L4+L5、4ノード）

**目的**: 全チャンクをマージ、重複除去、議題抽出

**主要ノード**:
1. Merge: チャンク統合（mode: append）
2. Code: 重複除去（line_idでユニーク化、ソート）
3. AI Agent Step2: 議題抽出（Gemini 2.5 Flash + Memory `step2_memory`）
   - systemMessage: 会議分析専門家、議題自動抽出、構造化出力
   - リトライ: maxTries=3
4. Set: Agenda Summary Cards（議題メタ生成）

**成功基準**: 5-10議題/会議、line_idマッピング100%一致

**Sticky Note**: 色4（薄紫）、560×420

```markdown
### 🔗 関連ノードブロック
- Merge: chunkCollector (Merge / node_g4_01): 全チャンク結合
- Code: Sorted Transcript (Code / node_g4_02): line_idソート + 重複除去
- AI Agent Step2 (AI Agent / node_g4_03): 議題抽出
  - Model: Gemini 2.5 Flash
  - Memory: step2_memory（全体文脈保持）
  - 出力: 議題リスト（meeting_name, agendas: [{agenda_id, title, line_ids}]）
- Set: Agenda Cards (Set / node_g4_04): 議題メタ生成

**データフロー**: 全チャンク → 統合 → 重複除去 → 議題抽出 → メタ生成
```

---

#### Group 5: 議題別マッピング（L5、1ノード）

**目的**: 各議題に該当する文字起こしを正確に抽出・割り当て（**Step020新規追加**）

**主要ノード**:
1. AI Agent Step3: 議題別文字起こしマッピング（Gemini 2.5 Flash + Memory `step3_memory`）
   - systemMessage: 議事録構造化専門家、議題別マッピング、抜け漏れチェック
   - リトライ: maxTries=3
   - **重要性**: 各議題への正確な割り当て、フォーマット変換精度向上

**成功基準**: 議題マッピング精度≧95%、抜け漏れゼロ

**Sticky Note**: 色4（薄紫）、540×420

```markdown
### 🔗 関連ノードブロック
- AI Agent Step3 (AI Agent / node_g5_01): **議題別文字起こしマッピング**（Step020追加）
  - Model: Gemini 2.5 Flash
  - Memory: step3_memory（マッピングコンテキスト保持）
  - 入力: Step2議題リスト + 全文字起こし
  - 出力: 議題ごとのline_id配列
  - コスト: +$0.558/実行（品質向上とのトレードオフ）

**追加理由**: 議題と文字起こしの正確なマッピングで議事録品質を大幅向上
```

---

#### Group 6: 議題データ再構成・並列処理（L4-L11、3ノード）

**目的**: 議題ごとに文字起こし収集、3議題並列処理開始

**主要ノード**:
1. Code: 議題データ再構成（議題別にlines収集、duration計算）
2. Split in Batches: 議題並列処理（batchSize=3）
3. Set: AI Agent Step4準備（議題データ整形）

**成功基準**: 議題データ構造化100%、並列バッチ起動成功

**Sticky Note**: 色3（薄青）、540×420

```markdown
### 🔗 関連ノードブロック
- Code: Agenda Gatherer (Code / node_g6_01): 議題ごとのデータ再構成
  - 入力: Step3の議題line_ids + Step4の統合文字起こし
  - 処理: line_idマッピング、duration計算
  - 出力: 議題別データ配列
- Split in Batches: agendaBatch (Split in Batches / node_g6_02): 3並列
- Set: Step4 Prep (Set / node_g6_03): AI Agent入力データ整形

**データフロー**: 議題マッピング → データ収集 → 並列開始
```

---

#### Group 7: 議題分析（並列）（L5、1ノード）

**目的**: 3議題並列で決定事項・宿題・保留事項を抽出

**主要ノード**:
1. AI Agent Step4: 議題分析（Gemini 2.5 Flash、temperature=0.4、maxTokens=4000）
   - systemMessage: 議事録分析専門家、決定事項・宿題・保留事項抽出
   - リトライ: maxTries=3

**成功基準**: タイムアウト<25秒/バッチ、抽出精度100%

**Sticky Note**: 色4（薄紫）、540×420

```markdown
### 🔗 関連ノードブロック
- AI Agent Step4 (AI Agent / node_g7_01): 議題分析
  - Model: Gemini 2.5 Flash
  - Temperature: 0.4
  - 並列: 3議題同時処理
  - リトライ: 最大3回
  - Memory: なし（各議題は独立）
  - 出力: 決定事項・宿題・保留事項リスト

**ループ構造**: Split in Batches (Output 1) → AI Agent → Split in Batches（ループバック）
**完了条件**: Split in Batches (Output 0) → Merge（次グループへ）
```

---

#### Group 8: 議題統合・フォーマット変換（L11+L4+L5、4ノード）

**目的**: 全議題をマージ、重複除去、Markdown議事録生成

**主要ノード**:
1. Merge: 議題統合（mode: append）
2. Code: 重複除去（agenda_idでユニーク化、ソート）
3. AI Agent Step5: フォーマット変換（Claude Sonnet 4.5 + Memory `step5_memory`）
   - systemMessage: ビジネス文書作成専門家、Markdown生成、フォーマット厳守
   - リトライ: maxTries=3
4. Set: Final Minutes Payload（議事録メタ生成）

**成功基準**: Markdown必須セクション完全、生成時間<60秒

**Sticky Note**: 色6（薄オレンジ）、580×440

```markdown
### 🔗 関連ノードブロック
- Merge: Agenda Assembly (Merge / node_g8_01): 全議題結合
- Code: Unique Agendas (Code / node_g8_02): agenda_idソート + 重複除去
- AI Agent Step5 (AI Agent / node_g8_03): Markdown議事録生成
  - Model: Claude Sonnet 4.5
  - Memory: step5_memory（全データ統合コンテキスト）
  - Temperature: 0.7
  - 出力: 完全なMarkdown議事録
- Set: Minutes Payload (Set / node_g8_04): 議事録メタ生成

**データフロー**: 全議題 → 統合 → 重複除去 → Markdown生成 → メタ生成
**フォーマット**: 目的・背景、日時、参加者、宿題事項、決定事項、議事内容
```

---

#### Group 9: 品質保証・出力・監視（L5-L7+L9-L10、6ノード）

**目的**: 議事録の完全性検証、Google Drive保存、通知、監査ログ送信

**主要ノード**:
1. AI Agent Step6: 品質保証（Claude Sonnet 4.5 + Memory `step6_memory`）
   - systemMessage: 品質保証専門家、完全性検証、不足項目補完
   - リトライ: maxTries=3
2. Google Drive: 議事録保存（Markdown as file、`議事録_出力/`フォルダ）
3. Google Drive: M4Aファイル移動（`processed/`フォルダ）
4. HTTP Request: Discord通知（完了通知、議事録リンク）
5. Set: Output Summary（処理結果まとめ）
6. HTTP Request: Audit Log送信（監査証跡、実行ID・会議名・処理時間）

**成功基準**: QAステータス=OK/補完済、保存失敗率0%、通知レイテンシ<5秒

**Sticky Note**: 色6（薄オレンジ）、580×440

```markdown
### 🔗 関連ノードブロック
- AI Agent Step6 (AI Agent / node_g9_01): 品質保証
  - Model: Claude Sonnet 4.5
  - Memory: step6_memory（検証コンテキスト保持）
  - 検証: 必須項目、フォーマット、内容の完全性
  - 出力: 補完済み議事録 + 警告リスト
- Google Drive: Save Minutes (Google Drive / node_g9_02): 議事録保存
- Google Drive: Move Audio (Google Drive / node_g9_03): M4A → processed/
- HTTP Request: Discord Notify (HTTP Request / node_g9_04): 完了通知
- Set: Output Summary (Set / node_g9_05): 処理結果セット
- HTTP Request: Audit Log (HTTP Request / node_g9_06): 監査ログ送信（L10）

**横断的関心事**:
- L9 Security: Credential管理（OAuth2、API Key）
- L10 Monitoring: 監査ログ、メトリクス収集
- L12 Orchestration: 条件分岐、状態管理

**データフロー**: 議事録 → QA → 保存 → 移動 → 通知 → ログ送信
```

---

## エラーフローグループ構成

| Error Group ID | Error Type | トリガー元 | 処理内容 | 通知先 |
|----------------|-----------|----------|---------|-------|
| 1 | 入力/検証エラー | Group 1-2 | MIME/サイズ/Drive API失敗、ファイル移動、エラー通知 | Discord #errors |
| 2 | AI処理エラー | Group 3-8 | Gemini/Claude/レート制限、リトライ→失敗通知 | Discord #ai-errors |
| 3 | 出力/通知エラー | Group 9 | Drive保存/Discord送信失敗、再送試行 | Discord #api-errors |

**総エラーグループ数**: 3グループ
**総ノード数**: 5ノード（エラーワークフロー）

### エラーグループ詳細説明

#### Error Group 1: 入力/検証エラー（5ノード）

**対象**: MIME/サイズ/Drive API失敗（Group 1-2で発生）

**ノード構成**:
1. Error Trigger: Intake（Drive系エラー検知）
2. Code: エラー情報整理（mime/size違反理由を明記）
3. IF: エラー種別判定（認証 vs データ不備）
4. Google Drive: エラーファイル移動（`/エラー/`フォルダ）
5. HTTP Request: Discord通知（運用Runbookリンク添付）

**リカバリー戦略**:
```
[Error Trigger] → [Code: error-shape] → [IF: Credential vs Data]
  ├─ 認証エラー → [Discord通知（即時対応依頼）]
  └─ データ不備 → [Google Drive: /エラー/移動] → [Discord通知]
```

**成功基準**: エラーファイル隔離100%、再試行フラグ設定

**Sticky Note**: 色5（薄赤）、540×420

---

#### Error Group 2: AI処理エラー（追加ノードなし、既存AI Agentリトライ機能で対応）

**対象**: Gemini/Claude/API rate limit（Group 3-8で発生）

**ノード構成**: AI Agent全6個の内蔵リトライ機能
- maxTries: 3
- waitBetweenTries: 1000ms（1秒）
- onError: continueRegularOutput

**リカバリー戦略**:
```
[AI Agent] ─(エラー)→ [Wait 1s] → [Retry 1回目] ─(エラー)→ [Wait 1s] → [Retry 2回目] ─(エラー)→ [Wait 1s] → [Retry 3回目]
  ├─ 成功 → 次グループへ
  └─ 3回失敗 → [Discord通知（AI失敗詳細）]
```

**エラー詳細**:
1. **Gemini失敗** (Group 3-7):
   - 原因: トークン数超過、API障害、レート制限
   - 対応: 3回リトライ（内蔵機能）
   - 失敗時: 部分生成議事録を `[ERROR]minutes - {日付} - {会議名}.md` として保存

2. **Claude失敗** (Group 8-9):
   - 原因: トークン数超過、API障害、レート制限
   - 対応: 3回リトライ（内蔵機能）
   - 失敗時: 部分生成議事録を `[ERROR]minutes - {日付} - {会議名}.md` として保存

**Sticky Note**: 色5（薄赤）、540×420

---

#### Error Group 3: 出力/通知エラー（追加ノードは既存Group 9で対応）

**対象**: Google Drive保存失敗、Discord送信失敗（Group 9で発生）

**ノード構成**: Google DriveとHTTP Requestノードの内蔵リトライ機能
- リトライ回数: 3回（n8nワークフロー設定）
- 待機時間: 5秒、10秒、20秒（Exponential Backoff）

**リカバリー戦略**:
```
[Google Drive Save] ─(エラー)→ [Wait 5s] → [Retry 1回目] ─(エラー)→ [Wait 10s] → [Retry 2回目] ─(エラー)→ [Wait 20s] → [Retry 3回目]
  ├─ 成功 → 完了
  └─ 3回失敗 → [Discord通知（手動対応依頼）]
```

**エラー詳細**:
1. **Google Drive保存失敗** (Group 9):
   - 原因: 権限エラー、ストレージ容量不足、ネットワークエラー
   - 対応: n8nワークフロー設定でリトライ（最大3回）
   - 失敗時: Discord通知（手動でGoogle Driveへアップロード依頼）

2. **Discord通知失敗** (Group 9):
   - 原因: Webhook URL無効、ネットワークエラー
   - 対応: HTTP Requestノードのリトライ機能（最大3回）
   - 失敗時: ログに記録（監視で検知）

**Sticky Note**: 色5（薄赤）、540×420

---

## グループ間接続設計

### メインフロー接続

```
Group 1 → Group 2 → Group 3 → Group 4 → Group 5 → Group 6 → Group 7 → Group 8 → Group 9
```

**詳細接続**:
- Group 1 (データ受信・検証) → Group 2 (音声文字起こし)
- Group 2 (音声文字起こし) → Group 3 (文字起こし整形：並列ループ)
- Group 3 (文字起こし整形) → Group 4 (チャンク統合・議題抽出)
- Group 4 (議題抽出) → Group 5 (議題別マッピング)
- Group 5 (議題別マッピング) → Group 6 (議題データ再構成)
- Group 6 (議題データ再構成) → Group 7 (議題分析：並列ループ)
- Group 7 (議題分析) → Group 8 (議題統合・フォーマット変換)
- Group 8 (フォーマット変換) → Group 9 (品質保証・出力)

### エラーフロー接続

```
Group 1-2 ─(入力/検証エラー)→ Error Group 1 → Discord通知
Group 3-8 ─(AI処理エラー)→ AI Agent内蔵リトライ（3回） → 失敗時Discord通知
Group 9 ─(出力/通知エラー)→ n8nリトライ（3回） → 失敗時Discord通知
```

**エラートリガー詳細**:
- Error Group 1: Error Triggerノードで明示的にエラーを受信
- Error Group 2: AI Agentノードの内蔵リトライ機能（maxTries=3）で対応
- Error Group 3: n8nワークフロー設定のリトライ機能で対応

### 統合接続図（Mermaid）

```mermaid
graph TB
    subgraph "Main Flow"
        G1[Group 1: データ受信・検証<br/>L1-L3 | 6ノード]
        G2[Group 2: 音声文字起こし・チャンク分割<br/>L4-L11 | 4ノード<br/>🚀 Fireworks Whisper v3]
        G3[Group 3: 文字起こし整形<br/>並列<br/>L5 | 1ノード]
        G4[Group 4: チャンク統合・議題抽出<br/>L11+L4+L5 | 4ノード]
        G5[Group 5: 議題別マッピング<br/>L5 | 1ノード<br/>🆕 Step020追加]
        G6[Group 6: 議題データ再構成<br/>L4-L11 | 3ノード]
        G7[Group 7: 議題分析<br/>並列<br/>L5 | 1ノード]
        G8[Group 8: 議題統合・フォーマット変換<br/>L11+L4+L5 | 4ノード]
        G9[Group 9: 品質保証・出力・監視<br/>L5-L7+L9-L10 | 6ノード]
    end

    subgraph "Error Flow"
        E1[Error Group 1: 入力/検証エラー<br/>L8 | 5ノード]
        E2[Error Group 2: AI処理エラー<br/>AI Agent内蔵リトライ]
        E3[Error Group 3: 出力/通知エラー<br/>n8nリトライ機能]
    end

    G1 --> G2
    G2 --> G3
    G3 -.並列ループ.-> G3
    G3 --> G4
    G4 --> G5
    G5 --> G6
    G6 --> G7
    G7 -.並列ループ.-> G7
    G7 --> G8
    G8 --> G9

    G1 -.エラー.-> E1
    G2 -.エラー.-> E1
    G3 -.エラー.-> E2
    G4 -.エラー.-> E2
    G5 -.エラー.-> E2
    G6 -.エラー.-> E2
    G7 -.エラー.-> E2
    G8 -.エラー.-> E2
    G9 -.エラー.-> E3

    style G2 fill:#e1f5e1
    style G5 fill:#ffe1e1
    style G3 fill:#f3e5f5
    style G7 fill:#f3e5f5
    style E1 fill:#ffebee
    style E2 fill:#ffebee
    style E3 fill:#ffebee
```

**並列処理の注意事項**:
- Group 3（文字起こし整形）: Split in Batchesの**Output 1 (loop)**を使用してループバック
- Group 7（議題分析）: Split in Batchesの**Output 1 (loop)**を使用してループバック
- ループ完了後はSplit in Batchesの**Output 0 (done)**から次グループへ接続

---

## トークン最適化確認

| グループ | ノード数 | 推定トークン | API安全性 |
|---------|---------|-----------|----------|
| Group 1 | 6 | 600 | ✅ 安全 |
| Group 2 | 4 | 1600 | ✅ 安全（Fireworks高速処理） |
| Group 3 | 1 | 1800 | ✅ 安全 |
| Group 4 | 4 | 2100 | ✅ 安全 |
| Group 5 | 1 | 1800 | ✅ 安全 |
| Group 6 | 3 | 1200 | ✅ 安全 |
| Group 7 | 1 | 1800 | ✅ 安全 |
| Group 8 | 4 | 2300 | ✅ 安全 |
| Group 9 | 6 | 2600 | ✅ 安全 |
| Error Group 1 | 5 | 800 | ✅ 安全 |

**総推定トークン**: 約16,600 tokens（グループ別生成により分散）

---

## コスト試算（月間20回処理）

**Fireworks Whisper v3採用による削減効果**:

| コンポーネント | モデル | コスト（月間） | 従来コスト | 削減額 |
|-------------|-------|------------|----------|-------|
| **文字起こし（L4）** | Fireworks Whisper v3 | **$0.042** (20時間 × $0.0021) | $15.48（Deepgram） | **$15.44（99%削減）** |
| AI Agent Step1-4 | Gemini Flash 2.5 | $0.628 | $0.628 | - |
| AI Agent Step5-6 | Claude Sonnet 4.5 | $3.00 | $3.00 | - |
| **総コスト** | - | **約$3.67/月（≈¥540/月）** | $19.11/月 | **$15.44/月（81%削減）** |

**パフォーマンス目標**:
- 1時間会議の処理時間: **3分以内**
- 文字起こし: **4秒**（Fireworks Whisper v3、従来Gemini 45秒比91%削減）
- AI処理: 2-3分

**年間削減効果**: 約$185.28/年（≈¥27,240/年）

---

## 次ステップへの引き継ぎ事項

### グループ分割サマリー
- **総グループ数**: メイン9 + エラー3 = 12グループ
- **Step070-092で順次JSON生成**（各グループ1ステップ）:
  - Step070: Group 1
  - Step071: Group 2
  - Step072: Group 3
  - Step073: Group 4
  - Step074: Group 5
  - Step075: Group 6
  - Step076: Group 7
  - Step077: Group 8
  - Step078: Group 9
  - Step079: Error Group 1
  - Step080: Error Group 2（AI Agentリトライ機能の詳細設定）
  - Step081: Error Group 3（n8nリトライ設定ドキュメント）

### AI Agent配置
- **Group 3**: AI Agent Step1（文字起こし整形 - Gemini）
- **Group 4**: AI Agent Step2（議題抽出 - Gemini + Memory）
- **Group 5**: AI Agent Step3（議題別マッピング - Gemini + Memory、**Step020新規追加**）
- **Group 7**: AI Agent Step4（議題分析 - Gemini）
- **Group 8**: AI Agent Step5（フォーマット変換 - Claude + Memory）
- **Group 9**: AI Agent Step6（品質保証 - Claude + Memory）

### 外部連携
- **Fireworks AI Whisper v3**: Group 2（**Step010/020必須要件**）
- **Google Gemini API**: Group 3, 4, 5, 7
- **Claude API**: Group 8, 9
- **Google Drive**: Group 1（トリガー・ダウンロード）、Group 9（保存・移動）、Error Group 1（エラーファイル移動）
- **Discord Webhook**: Group 9（完了通知）、Error Group 1-3（エラー通知）

### 特記事項

1. **並列処理グループ**:
   - Group 3（文字起こし整形）: 5並列、Split in Batchesのループ構造に注意
   - Group 7（議題分析）: 3並列、Split in Batchesのループ構造に注意
   - **重要**: Split in BatchesのOutput 1（loop）を処理ノードに接続、Output 0（done）を次グループに接続

2. **エラーハンドリング強化**:
   - Error Group 1: Error Triggerノードで明示的エラー受信
   - Error Group 2: AI Agent全6個の内蔵リトライ機能（maxTries=3）
   - Error Group 3: n8nワークフロー設定のリトライ機能
   - すべてのエラーでDiscord通知を実施

3. **Step020新規ステップ**:
   - Group 5: AI Agent Step3（議題別文字起こしマッピング）
   - 目的: 各議題への正確な割り当て、抜け漏れ防止
   - コスト: +$0.558/実行（品質向上とのトレードオフ）

4. **Fireworks Whisper v3採用効果**:
   - 処理速度: 1時間音声 → 4秒（Gemini 45秒比91%削減）
   - コスト: $0.0021/分（Deepgram比99%削減）
   - 品質: 業界標準Whisper v3ベース、話者分離対応

5. **横断的関心事の統合** (Group 9):
   - L9 Security: Credential管理、API Key存在確認
   - L10 Monitoring: 監査ログ送信、メトリクス収集
   - L12 Orchestration: 条件分岐、状態管理

---

## 統合版の改善点まとめ

### ✅ v1からの採用事項
- Fireworks AI Whisper v3使用（Step010/020必須要件）
- 9メイングループ構成
- コスト最適化（99%削減）
- パフォーマンス目標達成（3分以内）

### ✅ v2からの採用事項
- エラー統合設計の考え方
- グループ詳細説明の構造

### ✅ v3からの採用事項
- L9-L12横断的関心事の明確化（Group 9に統合）
- セキュリティ/監視/オーケストレーションの詳細設計
- 3エラーグループの詳細分類

### ✅ v4からの採用事項
- n8n-MCP検証結果の詳細
- エラーハンドリングの実装詳細
- リトライ戦略の明確化

### ✅ Step010/020/030からの反映
- Fireworks Whisper v3必須使用
- Step5（議題別マッピング）追加
- コスト試算詳細（月間$3.67）
- パフォーマンス目標（3分以内）
- エラーハンドリング強化

---

**作成担当**: Claude Code
**作成完了日時**: 2025-11-12
**ステータス**: ✅ グループ構成表統合版完成 - Step050準備完了
