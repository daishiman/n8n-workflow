# 実装手順書

**ワークフロー**: GoogleDrive音声Meet議事録自動生成システム v4.0
**対象**: 初心者から上級者まで
**所要時間**: 約30-60分（Credentials取得含む）

---

## 前提条件

### 必須環境

- ✅ n8n がインストール済み（バージョン: 1.0以上推奨）
- ✅ Google Cloud Platformアカウント（Google Drive + Gemini API）
- ✅ Anthropic Cloudアカウント（Claude API）
- ✅ Fireworks AIアカウント（Whisper v3 API）
- ✅ Discord Webhookアカウント（任意、通知用）

### 必要なCredentials情報を準備

| Credential | 取得方法 |
|-----------|---------|
| **Google Drive OAuth2** | Google Cloud Console → API有効化 → OAuth2 Client作成 |
| **Google Gemini OAuth2** | Google AI Studio → API Key取得 |
| **Anthropic API** | Anthropic Console → API Key取得 |
| **Fireworks AI API** | Fireworks AI → API Key取得 |
| **Discord Webhook**（任意） | Discord Server Settings → Integrations → Webhooks |

---

## 手順1: ワークフローのインポート

### 1.1 n8n UIにアクセス

1. Webブラウザでn8n URLを開く（例: `http://localhost:5678`）
2. n8nにログイン

### 1.2 ワークフローをインポート

1. 左メニューから **「Workflows」** を選択
2. 右上の **「+ Add Workflow」** をクリック
3. **「Import from File」** をクリック
4. `GoogleDrive音声Meet議事録自動生成_workflow_integrated_v4.json` を選択
5. **「Import」** をクリック
6. インポート完了を確認（50ノードが表示される）

---

## 手順2: Credentials設定

### 🔴 重要: AI Agent NodeのChat Model手動接続が必須

**このワークフローには6つのAI Agentノードがあり、それぞれにChat Modelサブノードを手動で接続する必要があります。**

### 手順2.1: AI Agent NodeのChat Model接続（必須）

各AI Agentノード（**Step2, Step3, Step4, Step5, Step6, Step7**）に対して、以下の手順を実行してください：

#### AI Agent Step2 - 文字起こし整形（Gemini Flash 2.5）

1. **AI Agent Step2** ノードをダブルクリックして開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatGoogleGemini`**
4. モデルパラメータを設定:
   - **Model**: `models/gemini-2.5-flash`
   - **Temperature**: `0.4`
   - **Max Output Tokens**: `4000`
5. **「Credentials」** で **「Create New Credential」** をクリック
6. **Credential Name**: `Google Gemini OAuth2`
7. **API Key**: [Google AI Studioで取得したAPI Key]
8. **保存**

#### AI Agent Step3 - 議題抽出（Gemini Flash 2.5）

1. **AI Agent Step3** ノードを開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatGoogleGemini`**
4. モデルパラメータ:
   - **Model**: `models/gemini-2.5-flash`
   - **Temperature**: `0.4`
   - **Max Output Tokens**: `4000`
5. **Credentials**: 既存の `Google Gemini OAuth2` を選択（Step2で作成済み）
6. **保存**

#### AI Agent Step4 - 議題分析（Gemini Flash 2.5）

1. **AI Agent Step4** ノードを開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatGoogleGemini`**
4. モデルパラメータ:
   - **Model**: `models/gemini-2.5-flash`
   - **Temperature**: `0.4`
   - **Max Output Tokens**: `3000`
5. **Credentials**: 既存の `Google Gemini OAuth2` を選択
6. **保存**

#### AI Agent Step5 - 議題別マッピング（Claude Sonnet 4.5）

1. **AI Agent Step5** ノードを開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatAnthropic`**
4. モデルパラメータ:
   - **Model**: `claude-4-5-sonnet-20250929`
   - **Temperature**: `0.5`
   - **Max Tokens**: `5000`
5. **「Credentials」** で **「Create New Credential」** をクリック
6. **Credential Name**: `Anthropic API`
7. **API Key**: [Anthropic Consoleで取得したAPI Key]
8. **保存**

#### AI Agent Step6 - フォーマット変換（Claude Sonnet 4.5）

1. **AI Agent Step6** ノードを開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatAnthropic`**
4. モデルパラメータ:
   - **Model**: `claude-4-5-sonnet-20250929`
   - **Temperature**: `0.7`
   - **Max Tokens**: `8000`
5. **Credentials**: 既存の `Anthropic API` を選択（Step5で作成済み）
6. **保存**

#### AI Agent Step7 - 品質保証（Claude Sonnet 4.5）

1. **AI Agent Step7** ノードを開く
2. 「Chat Model」セクションで **「Add Sub-Node」** をクリック
3. ノードタイプ選択: **`@n8n/n8n-nodes-langchain.lmChatAnthropic`**
4. モデルパラメータ:
   - **Model**: `claude-4-5-sonnet-20250929`
   - **Temperature**: `0.3`
   - **Max Tokens**: `8000`
5. **Credentials**: 既存の `Anthropic API` を選択
6. **保存**

### 手順2.2: Google Drive OAuth2

1. **M4Aファイル検知** ノードをダブルクリックして開く
2. **「Credential to connect with」** で **「Create New Credential」** をクリック
3. **Credential Name**: `Google Drive OAuth2`
4. Google Cloud Consoleで取得した **Client ID** と **Client Secret** を入力
5. **「Connect」** をクリックしてOAuth2認証を完了
6. **保存**
7. **他のGoogle Driveノード（ファイル情報取得、M4Aダウンロード、議事録保存、M4A処理済み移動）** にも同じCredentialを適用

### 手順2.3: Fireworks AI API

1. **Fireworks Whisper v3文字起こし** ノードをダブルクリックして開く
2. **「Credential to connect with」** で **「Create New Credential」** をクリック
3. **Credential Name**: `Fireworks AI API`
4. **API Key**: [Fireworks AIで取得したAPI Key]
5. **保存**

### 手順2.4: Discord Webhook（任意）

1. **Discord完了通知** ノードをダブルクリックして開く
2. **URL** フィールドに Discord Webhook URL を入力
3. **保存**

### 手順2.5: 監査ログサーバー（任意）

1. **監査ログ送信** ノードをダブルクリックして開く
2. **URL** フィールドに監査ログサーバーのURLを入力
3. 必要に応じて認証ヘッダーを設定
4. **保存**

---

## 手順3: テスト実行

### 3.1 ワークフローを有効化

1. ワークフロー画面右上の **「Inactive」** をクリック
2. **「Active」** に変更
3. Google Drive Triggerが監視を開始

### 3.2 テストファイルをアップロード

1. Google Driveの監視対象フォルダを確認（**M4Aファイル検知** ノードの設定参照）
2. テスト用M4A音声ファイルを監視対象フォルダにアップロード
   - ファイル名例: `2025-01-15_14-30_定例会議.m4a`
   - ファイルサイズ: 1GB以下推奨
3. n8n UIで **「Executions」** タブを開く
4. 新しい実行が開始されたことを確認

### 3.3 実行ログの確認

1. **Executions** タブで最新の実行をクリック
2. 各ノードの実行結果を確認:
   - **M4Aファイル検知**: ファイル情報が取得されているか
   - **Fireworks Whisper v3文字起こし**: 文字起こしテキストが生成されているか
   - **AI Agent Step2-7**: 各AI AgentがErrorなく実行されているか
   - **議事録保存**: Google Driveに議事録が保存されているか
   - **Discord完了通知**: Discordに通知が送信されているか

### 3.4 出力確認

1. Google Driveの出力フォルダを開く（**議事録保存** ノードの設定参照）
2. 議事録Markdownファイルが保存されていることを確認
3. ファイル内容を確認:
   - 議題が正しく抽出されているか
   - 決定事項、アクションアイテム、保留事項が記載されているか
   - Markdown形式が整っているか

---

## 手順4: エラーハンドリングテスト

### 4.1 無効なファイル形式テスト

1. 監視対象フォルダに **MP3ファイル** をアップロード（M4A以外）
2. **ファイル妥当性チェック** ノードでフィルタされることを確認
3. ワークフローが途中で停止することを確認

### 4.2 AI Agentエラーリトライテスト

1. 一時的にGemini API Keyを無効化（または削除）
2. M4Aファイルをアップロード
3. **AI Agent Step2** で3回リトライ（maxTries=3）されることを確認
4. 3回失敗後、`continueRegularOutput` で次のノードに進むことを確認
5. API Keyを元に戻す

---

## 手順5: 本番デプロイ

### 5.1 Webhook URLを本番URLに変更（該当する場合）

1. Webhookノードを開く
2. Production URLを設定
3. 保存

### 5.2 ワークフローを「Active」に設定

1. ワークフロー画面右上で **「Active」** を確認
2. Google Drive Triggerが監視を開始

### 5.3 本番環境でテスト実行

1. 本番環境のGoogle Driveフォルダに実際のM4Aファイルをアップロード
2. ワークフローが正常に実行されることを確認
3. 議事録が正しく保存されることを確認
4. Discord通知が正しく送信されることを確認

### 5.4 監視ダッシュボード設定

1. **Executions** タブで実行履歴を監視
2. 定期的にエラーログを確認
3. Discord通知で処理完了を監視
4. 監査ログサーバーでログを確認（設定している場合）

---

## トラブルシューティング

### エラー1: AI Agent接続エラー

**エラーメッセージ**: `AI Agent has no Chat Model configured`

**原因**: Chat ModelサブノードのCredentials未設定、またはChat Modelサブノード自体が未接続

**対処**:
1. 該当AI Agentノードを開く
2. 「Chat Model」セクションを確認
3. Chat Modelサブノードが接続されていない場合:
   - **手順2.1** を再実行してChat Modelサブノードを手動接続
4. Credentialsが設定されていない場合:
   - Chat Modelサブノードを開く
   - **「Credentials」** で適切なAPI Keyを選択または新規作成

### エラー2: Google Drive認証エラー

**エラーメッセージ**: `Unauthorized`, `OAuth2 token expired`

**原因**: OAuth2トークンが期限切れ、またはスコープ不足

**対処**:
1. **Google Drive OAuth2** Credentialを開く
2. **「Reconnect」** をクリックして再認証
3. 必要なスコープ（`https://www.googleapis.com/auth/drive`）が付与されていることを確認
4. 再認証後、ワークフローを再実行

### エラー3: Fireworks文字起こし失敗

**エラーメッセージ**: `Fireworks API error`, `Invalid API Key`

**原因**: Fireworks AI API Keyが無効、またはクレジット不足

**対処**:
1. Fireworks AI Consoleで API Keyを確認
2. クレジット残高を確認
3. **Fireworks AI API** Credentialを再設定
4. 必要に応じて新しいAPI Keyを発行

### エラー4: Gemini API接続エラー

**エラーメッセージ**: `Gemini API error`, `Quota exceeded`

**原因**: API Key無効、またはクォータ超過

**対処**:
1. Google AI StudioでAPI Keyを確認
2. クォータ（Requests per minute: RPM）を確認
3. 必要に応じてAPI Keyを再発行
4. **Google Gemini OAuth2** Credentialを再設定

### エラー5: Claude API接続エラー

**エラーメッセージ**: `Anthropic API error`, `Rate limit exceeded`

**原因**: API Key無効、またはレート制限超過

**対処**:
1. Anthropic ConsoleでAPI Keyを確認
2. レート制限（Tokens per minute: TPM）を確認
3. 必要に応じてAPI Keyを再発行
4. **Anthropic API** Credentialを再設定

### エラー6: Discord通知失敗

**エラーメッセージ**: `Webhook URL invalid`, `404 Not Found`

**原因**: Discord Webhook URLが無効、または削除済み

**対処**:
1. Discord Server Settings → Integrations → Webhooksを開く
2. 新しいWebhookを作成
3. Webhook URLをコピー
4. **Discord完了通知** ノードのURLフィールドに貼り付け
5. 保存して再実行

### エラー7: 議事録保存失敗

**エラーメッセージ**: `Permission denied`, `Folder not found`

**原因**: 出力フォルダへのアクセス権限不足、またはフォルダID無効

**対処**:
1. **議事録保存** ノードを開く
2. **「Folder」** フィールドのフォルダIDを確認
3. Google Driveで該当フォルダが存在することを確認
4. OAuth2アカウントがフォルダへの書き込み権限を持つことを確認
5. 必要に応じてフォルダIDを正しいものに変更

---

## パフォーマンス最適化Tips

### Tip 1: チャンクサイズ調整

- **チャンク並列バッチ** ノードの `batchSize` を調整（デフォルト: 5）
- 小さいサイズ（3-4）: 並列処理数増加、メモリ使用量削減
- 大きいサイズ（7-10）: バッチ数削減、総処理時間短縮

### Tip 2: 議題並列バッチサイズ調整

- **議題並列バッチ** ノードの `batchSize` を調整（デフォルト: 3）
- 会議の議題数に応じて最適化（議題9個なら3並列、議題12個なら4並列など）

### Tip 3: AI Agentのmax Tokensチューニング

- Gemini Flash 2.5の `maxOutputTokens` を調整（デフォルト: 3000-4000）
- Claude Sonnet 4.5の `maxTokens` を調整（デフォルト: 5000-8000）
- 短い会議: トークン数削減でコスト最適化
- 長い会議: トークン数増加で出力品質向上

### Tip 4: Memoryコンテキスト長調整

- Memory ノードの `contextWindowLength` を調整（デフォルト: 10）
- 短い会議: 5-7で十分
- 長い会議: 15-20に増加して文脈保持

---

## 参考資料

### 公式ドキュメント

- **n8n公式ドキュメント**: https://docs.n8n.io/
- **AI Agent Node**: https://docs.n8n.io/integrations/builtin/cluster-nodes/sub-nodes/n8n-nodes-langchain.agent/
- **Google Drive Trigger**: https://docs.n8n.io/integrations/builtin/trigger-nodes/n8n-nodes-base.googledrivetrigger/
- **HTTP Request Node**: https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.httprequest/

### APIドキュメント

- **Fireworks AI**: https://docs.fireworks.ai/
- **Google Gemini**: https://ai.google.dev/docs
- **Anthropic Claude**: https://docs.anthropic.com/

### 本ワークフロー設計ドキュメント

- **メタデータ**: `GoogleDrive音声Meet議事録自動生成_metadata_v4.json`
- **検証レポート**: `検証レポート.md`
- **README**: `README.md`

---

**実装手順書バージョン**: v4.0
**最終更新日**: 2025-11-13
**作成者**: n8n AI自動設計システム（Claude Code + n8n-MCP）
