# 業務理解書 (Step010)

## ワークフロー名

GoogleDrive 動画自動議事録生成システム v4.0

## ビジネス要件

### 業務目的

- **問題点**: 議事録作成に時間がかかり、他の重要な作業に集中できない
- **理想**: 動画が保存された段階で完全に手離れし、指定フォーマットの議事録が自動生成される
- **目標**: 議事録作成作業の完全自動化、他業務への集中時間を確保

### ユースケース

- **主要ユーザー**: 現状は本人（万壽本）、将来的には不特定多数も使用可能
- **使用頻度**:
  - 1 日: 1-5 回
  - 1 週間: 最大 15-20 回
- **使用シーン**:
  - パターン 1: Google Meet 会議録画が自動的に Google Drive に保存される
  - パターン 2: 手動で MP4 ファイルを Google Drive にアップロード
  - 両方のパターンに対応

### ビジネスルール

- **承認フロー**: 不要、自動生成された議事録をそのまま使用
- **データ保持期間**:
  - 元の MP4 ファイル: ユーザーが削除するまで無期限保存
  - 議事録ファイル: ユーザーが削除するまで無期限保存
  - 自動削除ルール: なし
- **アクセス権限**: Google Drive にアクセスできる人は誰でも閲覧可能
- **処理対象外**: なし（すべての.mp4 ファイルを処理）

## 機能要件

### トリガー条件

- **トリガータイプ**: Google Drive Trigger（Polling 方式）
- **トリガー頻度**: 5 分ごとにチェック
- **監視対象フォルダ**: 2 つのフォルダを監視
  1. **Google Meet 録画保存先**: `https://drive.google.com/drive/u/0/folders/17NRimTzbihKP9clM1Oiblu2TvEiSS-dv`
  2. **手動アップロード保存先**: `https://drive.google.com/drive/u/0/folders/1Ddh7AFQooIcogKZeLNnWPqzrq2DX97QH`
- **検知対象**: 新規追加された `.mp4` ファイル
- **ファイルサイズ**: 300MB ～ 1GB（3 時間超えの動画も対応）

### データ処理

- **入力データ形式**: MP4 動画ファイル
- **ファイル名パース**:
  - 構造: `{YYYY-MM-DD} {会議タイトル}@{参加者1}・{参加者2}・{参加者N}.mp4`
  - 例: `2025-11-11 近況共有会@たてさん・万壽本.mp4`
  - 抽出情報: 日付、会議タイトル、参加者（・で分割）
- **データ変換ロジック**:
  1. MP4 動画から音声抽出
  2. Fireworks AI Whisper API で文字起こし（Speaker Diarization 有効）
  3. 行ごとに分割して AI 処理
  4. 指定フォーマットの Markdown 議事録に変換
- **出力データ形式**: Markdown ファイル (`.md`)
- **出力ファイル名**: `minutes - {YYYY-MM-DD} - {会議タイトル}@{参加者1}・{参加者2}・{参加者N}.md`

### 統合要件

- **外部 API**:
  1. **Fireworks AI Whisper API**:
     - 用途: 動画文字起こし（Speaker Diarization 有効）
     - エンドポイント: https://docs.fireworks.ai/api-reference/audio-transcriptions
     - 認証: API Key（n8n 環境変数 `FIREWORKS_API_KEY`）
     - ファイルサイズ上限: 1GB
     - 日本語対応: あり
  2. **Google Gemini Flash 2.5**:
     - 用途: Step1-3（整形、議題抽出、分析）
     - 認証: API Key（n8n 環境変数 `GEMINI_API_KEY`）
  3. **Anthropic Claude Sonnet 4.5**:
     - 用途: Step4-5（フォーマット変換、品質保証）
     - 認証: API Key（n8n 環境変数 `CLAUDE_API_KEY`）
  4. **Discord Webhook**:
     - 用途: 処理通知（開始、完了、エラー）
     - 認証: Webhook URL（n8n 環境変数 `DISCORD_WEBHOOK_URL`）
- **Google Drive**:
  - 認証方式: OAuth2
  - 連携内容:
    - 新規ファイル検知
    - ファイルダウンロード
    - 議事録アップロード
    - 処理済みファイル移動
- **データ同期方向**:
  - Google Drive → n8n → Fireworks AI → Gemini → Claude → Google Drive（一方向）

### AI 処理

#### 処理フロー

```
Step0: 文字起こし (Fireworks AI Whisper)
  ↓
Step1: 文字起こし整形 (Gemini Flash 2.5)
  ↓
Step2: 議題抽出 (Gemini Flash 2.5)
  ↓
Step3: 議題分析 (Gemini Flash 2.5)
  ↓
Step4: フォーマット変換 (Claude Sonnet 4.5)
  ↓
Step5: 品質保証 (Claude Sonnet 4.5)
```

#### Step0: 文字起こし (Fireworks AI Whisper)

- **入力**: MP4 動画ファイル（音声抽出済み）
- **処理**:
  - Whisper-v3 モデル使用
  - Speaker Diarization 有効（話者分離）
  - 日本語モデル
- **出力**: 生テキスト（句読点付き、話者情報付き）

#### Step1: 文字起こし整形 (Gemini Flash 2.5)

- **入力**: 生テキスト（行分割済み）
- **処理**:
  - フィラー除去（「えー」「あのー」「その」等）
  - 1 行ずつ箇条書き化
  - 意味のある文章単位に整形
- **出力**: JSON 配列 `[{"line": 1, "content": "..."}, ...]`

#### Step2: 議題抽出 (Gemini Flash 2.5)

- **入力**: Step1 の整形済み JSON
- **処理**: 会話の流れから議題を自動抽出、議題ごとにグループ化
- **出力**: JSON 配列 `[{"id": 1, "title": "...", "lines": [1, 2, 3]}, ...]`

#### Step3: 議題分析 (Gemini Flash 2.5)

- **入力**: Step2 の議題 JSON
- **処理**: 各議題ごとに決定事項、宿題（TODO）、保留事項を抽出
- **出力**: JSON 配列（拡張版）`[{"id": 1, "title": "...", "decisions": [...], "todos": [...], "pending": [...]}, ...]`

#### Step4: フォーマット変換 (Claude Sonnet 4.5)

- **入力**: Step1-3 の全 JSON + ファイルメタデータ
- **処理**: 指定フォーマットに従って Markdown 生成
- **出力**: Markdown テキスト

#### Step5: 品質保証 (Claude Sonnet 4.5)

- **入力**: Step4 の Markdown + Step1-3 の全データ
- **処理**: 議事録の完全性を検証、不足項目があれば補完
- **出力**: 最終 Markdown（検証済み）

#### 参加者情報の統合ロジック

1. **ファイル名から抽出**（メイン参加者）: `@{参加者1}・{参加者2}` の部分をパース
2. **音声ファイルから抽出**（Speaker Diarization）: 話者分離で検出された追加の話者
3. **Google Meet 情報から抽出**（可能な場合）: 会議メタデータに参加者情報があれば追加
4. **統合**: 重複排除してすべてを議事録の「参加者」欄に記載

## 非機能要件

### パフォーマンス

- **目標処理時間**: 処理時間は問わない（議事録生成完了を優先）
- **タイムアウト設定**: n8n 推奨値で長時間動画対応（3 時間超えも処理可能）
- **最大スループット**: 1 ファイルずつ順次処理（API レート制限を回避）
- **並列実行**: なし（1 ファイル完了後、次のファイルを処理）

### セキュリティ

- **認証方式**:
  - Google Drive: OAuth2
  - Fireworks AI: API Key
  - Gemini: API Key
  - Claude: API Key
  - Discord: Webhook URL
- **API Key 管理**: n8n 環境変数で管理
  - `FIREWORKS_API_KEY`
  - `GEMINI_API_KEY`
  - `CLAUDE_API_KEY`
  - `DISCORD_WEBHOOK_URL`
- **アクセス制御**: Google Drive のアクセス権限に準拠
- **データ暗号化**:
  - 通信時: HTTPS/TLS（すべての API 通信）
  - 保存時: Google Drive の暗号化機能に依存

### 信頼性

- **許容エラー率**: エラー発生時は即座に通知、次のファイルに進む
- **リトライ戦略**: API 障害時は自動リトライ（n8n デフォルト設定）
- **エラーハンドリング**:
  - エラー発生時: Discord 通知を送信
  - エラー内容: ファイル名、エラー種別、エラーメッセージ、タイムスタンプ
  - エラーファイル: 処理済みフォルダには移動せず、元の場所に残す
- **データ整合性保証**:
  - 議事録生成完了後にのみ、元の MP4 ファイルを移動
  - 途中エラーの場合、ファイルは移動しない

## 運用要件

### 運用・監視

- **ログレベル**: INFO
- **ログ記録項目**:
  - 処理開始: ファイル名、ファイルサイズ、処理開始時刻
  - 処理完了: 議事録ファイル名、保存先、合計処理時間
  - エラー発生: エラー種別、エラーメッセージ
- **アラート条件**:
  - エラー発生時: 即座に Discord 通知
  - 処理開始時: Discord 通知「🚀 議事録生成開始: {ファイル名}」
  - 処理完了時: Discord 通知「✅ 議事録生成完了: {議事録ファイル名}」
- **Discord 通知フォーマット**:
  - 開始: `🚀 議事録生成開始\nファイル名: {元のファイル名}\n開始時刻: {YYYY-MM-DD HH:mm:ss}`
  - 完了: `✅ 議事録生成完了\n議事録: {議事録ファイル名}\n処理時間: {XX分XX秒}`
  - エラー: `🚨 エラー発生\nファイル名: {元のファイル名}\nエラー種別: {種別}\nエラー内容: {メッセージ}\n発生時刻: {YYYY-MM-DD HH:mm:ss}`

### 保守・拡張

- **将来機能**: 現時点では追加機能なし
- **スケーリング戦略**: ファイル数増加時は処理頻度を調整（5 分 → 10 分等）
- **拡張性**:
  - 新規通知先追加（Slack、メール等）に対応可能な設計
  - AI モデル変更（Gemini → Claude 等）に対応可能な設計
  - フォーマット変更に柔軟に対応

## 次ステップへの引き継ぎ事項

### AI 処理が必要な箇所

1. 文字起こし（Fireworks AI Whisper）
2. 文字起こし整形（Gemini Flash 2.5）
3. 議題抽出（Gemini Flash 2.5）
4. 議題分析（Gemini Flash 2.5）
5. フォーマット変換（Claude Sonnet 4.5）
6. 品質保証（Claude Sonnet 4.5）

### 外部連携が必要なシステム

1. Google Drive（ファイル検知、ダウンロード、アップロード、移動）
2. Fireworks AI（文字起こし API）
3. Google Gemini（AI 処理 Step1-3）
4. Anthropic Claude（AI 処理 Step4-5）
5. Discord（Webhook 通知）

### 特記事項

#### ファイル構成

- **監視フォルダ 1（Google Meet）**: `17NRimTzbihKP9clM1Oiblu2TvEiSS-dv`
- **監視フォルダ 2（手動）**: `1Ddh7AFQooIcogKZeLNnWPqzrq2DX97QH`
- **議事録出力先**: `12J4nKaLa3veMHXKsv-bPOq1j5jsvacu5`
- **処理済み動画移動先**: `1fja7UEFSM9XbcGF9PgkhNyH10MsIw9an`

#### 議事録フォーマット（固定）

```markdown
# 目的・背景

{AI が抽出した会議の目的}

# 日時

{YYYY} 年 {MM} 月 {DD} 日（{曜日}） {HH}:{mm} 〜 {HH}:{mm}

# 参加者

{ファイル名 + 音声 + Google Meet から統合した参加者}

# 宿題事項

- {宿題 1}
- {宿題 2}

# 決定事項

- {決定事項 1}
- {決定事項 2}

# 次回の日時

{YYYY} 年 {MM} 月 {DD} 日（{曜日}） {HH}:{mm} 〜 {HH}:{mm}

# 議事内容

## 本日の議題

- [ ] 議題 1：{議題タイトル 1}
- [ ] 議題 2：{議題タイトル 2}

## 議題 1：{議題タイトル 1}

- {箇条書き内容 1}
- {箇条書き内容 2}

## 議題 2：{議題タイトル 2}

- {箇条書き内容 1}
- {箇条書き内容 2}
```

#### コスト試算（参考）

- **文字起こし**: Fireworks AI Whisper
  - 価格: $0.0009 ～$0.0015/分
  - 1 時間動画: $0.054 ～$0.09
  - 週 20 回（各 1 時間）: $1.08 ～$1.8/週
- **AI 処理**: Gemini Flash 2.5 + Claude Sonnet 4.5
  - 変動費のため、実運用で測定

---

**作成日**: 2025-11-12
**作成者**: Claude Code (Anthropic)
**次ステップ**: Step020（AI 設定）
