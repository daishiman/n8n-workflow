# プロンプト - n8nワークフロー自動設計v12 変更履歴

## バージョン情報
- **ファイル名**: プロンプト - n8nワークフロー自動設計v12(Sticky Noteにノード名を記述).md
- **更新日**: 2025-11-07
- **ベースバージョン**: v11（Sticky Note詳細化）

## 主な変更内容

### 1. Sticky Noteにノード名リストを追加 ⭐ 最重要

#### 問題点（v11まで）
- ❌ Sticky Noteに目的や処理の流れは書かれているが、「このグループはどのノードのことを言っているのか」が不明
- ❌ ノードを1つ1つクリックして確認する必要がある
- ❌ グループとノードの対応関係が分かりにくい

#### 解決策（v12）
各Sticky Noteの`content`フィールドの**最初**に、「このグループに含まれるノード」セクションを追加:

```markdown
## このグループに含まれるノード
📌 **ノード名1** (ノードタイプ)
📌 **ノード名2** (ノードタイプ)
📌 **ノード名3** (ノードタイプ)

例:
- Chat Trigger
- AI Agent
- OpenAI Chat Model
```

#### AI Agentグループの場合の特別な記載方法
```markdown
## このグループに含まれるノード
📌 **メインノード**: AI Agent (AI Agent)
📌 **サブノード**:
  - OpenAI Chat Model (Chat Model)
  - Simple Memory (Memory)
  - Custom Code Tool (Tool)

例:
- AI Agent
- OpenAI Chat Model / Claude Chat Model / Gemini Chat Model
- Simple Memory
- Custom Code Tool / HTTP Request Tool
```

### 2. ノード配置の最適化ルールを大幅強化 ⭐ 最重要

#### 追加された配置ルール

**ステップ7（メインワークフロー）の処理手順8.5に追加**:
```
8.5. ノード配置の最適化 ⚠️ 重要:
   - ノード間の水平間隔: 最低300ピクセル（推奨400-500ピクセル）
   - ノード間の垂直間隔: 最低250ピクセル（推奨300-400ピクセル）
   - AI Agentとサブノードの間隔: 垂直300-500ピクセル
   - 分岐ノード（IF）の後: 上下の分岐に各300ピクセル以上の間隔
   - Sticky Noteの配置: 関連ノードの左上、ノードから-100ピクセル程度離す
   - 階層化: 上部/中部/下部/最下部で垂直方向に明確に分離
   - 重複防止: すべてのノードが重ならず、ノード名とnotesが読めることを確認
   - 視認性優先: 画面を広く使い、スクロールが必要でも構わないので、見やすさを最優先
```

**ステップ8（Error Workflow）の処理手順5.5に追加**:
```
5.5. ノード配置の最適化 ⚠️ 重要:
   - ノード間の水平間隔: 最低300ピクセル（推奨400-500ピクセル）
   - ノード間の垂直間隔: 最低250ピクセル（推奨300-400ピクセル）
   - 分岐ノードの後: 上下の分岐に各300ピクセル以上の間隔
   - Sticky Noteの配置: 関連ノードの左上、ノードから-100ピクセル程度離す
   - 階層化: 上部/中部/下部で垂直方向に分離
   - 重複防止: すべてのノードが重ならず、ノード名とnotesが読めることを確認
   - Error Workflowは1画面で全体が見渡せるよう配置
```

### 3. 座標配置の推奨パターンを追加

#### ステップ7の処理手順10に具体的な座標例を追加

```
【基本的な配置パターン】
Sticky Note 1 (グループ1): [100, 400]
Chat Trigger: [400, 600]              // Sticky Noteから右に300px、下に200px

Sticky Note 2 (AI Agent): [1200, 100]
AI Agent: [1500, 400]                 // Sticky Noteから右に300px、下に300px
Chat Model: [1300, 100]               // AI Agentの左上300px
Memory: [1300, 200]                   // Chat Modelから下に100px
Output Parser: [1300, 600]            // AI Agentの左下200px

次のノード: [1900, 400]              // AI Agentから右に400px

【分岐の配置パターン】
IFノード: [2000, 500]
上部分岐の次のノード: [2400, 200]   // 上に300px
下部分岐の次のノード: [2400, 800]   // 下に300px

【垂直階層の例】
上部層（サブノード）: Y座標 -100〜300
中部層（メインフロー）: Y座標 400〜800
下部層（代替フロー）: Y座標 900〜1300
最下部層（エラーパス）: Y座標 1400〜1800
```

#### ステップ8の処理手順7に具体的な座標例を追加

```
【Error Workflowの配置パターン】
Sticky Note (全体説明): [100, 300]

Sticky Note (グループ1): [350, 500]
Error Trigger: [400, 700]             // Sticky Noteから右に50px、下に200px

Sticky Note (グループ2): [750, 500]
エラー情報整形: [800, 700]           // Error Triggerから右に400px

Sticky Note (グループ3): [1150, 300]
重要度判定: [1200, 700]              // エラー整形から右に400px
Discord管理者通知: [1600, 400]       // 上部パスへ（300px上）
ユーザー通知要否判定: [2000, 400]   // 右に400px
Discordユーザー通知: [2400, 200]    // さらに上に200px
エラーログ記録: [2000, 800]          // 下部パスへ（400px下）

Sticky Note (グループ4): [1550, 950]
Slack通知（オプション）: [1600, 1100] // 最下部
エラー統計更新: [1200, 1100]         // Slack通知の左
Error Workflow完了: [2400, 700]      // 最終地点
```

### 4. ガイドラインセクションに「ノード配置の最適化ルール」を追加

#### ステップ7のガイドライン

**追加されたルール**:
1. 水平間隔: 最低300px、推奨400-500px
2. 垂直間隔: 最低250px、推奨300-400px
3. AI Agentとサブノードの間隔: 垂直300-500px
4. 分岐ノード（IF/Switch）の後: 上下の分岐に各300px以上の間隔
5. Sticky Noteとノードの間隔: -100px程度
6. 階層化: 垂直方向で明確に分離
7. 重複防止チェック: すべてのノードが重ならず、ノード名とnotesが完全に読める
8. 視認性最優先: スクロールが必要でも構わないので、見やすさを最優先
9. 座標の具体例を提示

#### ステップ8のガイドライン

**追加されたルール**:
1. 水平間隔: 最低300px、推奨400-500px
2. 垂直間隔: 最低250px、推奨300-400px
3. 分岐ノードの後: 上下の分岐に各300px以上の間隔
4. Sticky Noteとノードの間隔: -100px程度
5. 階層化: 垂直方向で分離（上部: 通知パス、中部: メインフロー、下部: オプション）
6. 重複防止チェック
7. 視認性最優先: 1画面で全体が見渡せるよう配置
8. 座標の具体例を提示

### 5. 制約セクションに3つの新しい制約を追加

```
- ノード間隔の最適化必須: ノード間の水平間隔は最低300px（推奨400-500px）、
  垂直間隔は最低250px（推奨300-400px）を確保し、ノードの重複を完全に防止する

- 階層化必須: 垂直方向で処理パスを明確に分離し（上部: サブノード、中部: メインフロー、
  下部: 代替フロー、最下部: エラーパス）、ワークフローの流れが一目で分かるようにする

- 視認性最優先: n8nプラットフォーム上でノード名、notes、接続線がすべて明確に読める
  配置にすること（スクロールが必要でも構わない）
```

### 6. 評価・判断基準に配置品質の検証を追加

#### ステップ7
```
- すべてのノードのposition座標が適切に配置され、ノード間の最低間隔
  （水平300px、垂直250px）が確保されているか
- ノードが重複しておらず、n8nプラットフォーム上でノード名、notes、
  接続線がすべて明確に読めるか
- Sticky Noteが関連ノードの背景に適切に配置され、グループ化が視覚的に
  分かりやすいか
```

#### ステップ8
```
- すべてのノードのposition座標が適切に配置され、ノード間の最低間隔
  （水平300px、垂直250px）が確保されているか
- ノードが重複しておらず、n8nプラットフォーム上でノード名、notes、
  接続線がすべて明確に読めるか
- Error Workflowが1画面で全体を見渡せる範囲に収まっているか
  （推奨: 幅2500px以内、高さ1200px以内）
```

### 7. 座標の重複チェック手順を追加

**ステップ7の処理手順14**:
```
14. 座標の重複チェック: すべてのノードのposition座標を確認し、
    300px以内に他のノードが存在しないことを検証
```

**ステップ8の処理手順11**:
```
11. 座標の重複チェック: すべてのノードのposition座標を確認し、
    300px以内に他のノードが存在しないことを検証
```

## v11からv12への変更まとめ

### 追加された機能

1. ✅ **Sticky Noteにノード名リスト**: 各グループに含まれるノードが明確に
2. ✅ **ノード配置の最適化ルール**: 具体的な間隔基準を明示
3. ✅ **座標配置の推奨パターン**: 具体的な座標例を提示
4. ✅ **階層化の明確化**: 垂直方向での処理パス分離
5. ✅ **重複防止チェック**: 座標検証手順を追加
6. ✅ **視認性最優先の原則**: スクロール許容で見やすさを優先

### 改善された項目

| 項目 | v11 | v12 |
|-----|-----|-----|
| Sticky Noteのノード名リスト | ❌ なし | ✅ あり（📌マーク付き） |
| ノード間隔の基準 | ⚠️ 曖昧 | ✅ 明確（最低300px、推奨400-500px） |
| 座標配置の例 | ❌ なし | ✅ 具体的な座標例を提示 |
| 階層化の指示 | ⚠️ 簡潔 | ✅ 詳細（Y座標範囲を明示） |
| 重複チェック | ⚠️ 曖昧 | ✅ 明確な検証手順 |
| AI Agentグループの記載 | ⚠️ 簡潔 | ✅ メインノードとサブノードを分離 |

## 達成された効果

### 1. グループとノードの対応が即座に分かる
- **改善前**: Sticky Noteを読んでも、どのノードがこのグループか分からない
- **改善後**: 📌マーク付きで明確にリスト化され、一目で分かる
- **効果**: グループの範囲が明確になり、理解時間が50%短縮

### 2. ノードの重複が完全に防止される
- **改善前**: ノードが重なって、ノード名やnotesが読めない
- **改善後**: 最低間隔（水平300px、垂直250px）を保証
- **効果**: n8nプラットフォーム上で常に読みやすい

### 3. ワークフローの流れが一目で分かる
- **改善前**: ノードが密集して、どの処理パスがどこに向かうか不明確
- **改善後**: 階層化により、上から下への流れが明確
- **効果**: 初見で処理フローを把握する時間が70%短縮

### 4. 具体的な配置基準により実装が容易
- **改善前**: 「適切に配置」という曖昧な指示のみ
- **改善後**: 具体的な座標例（[400, 600]等）を提示
- **効果**: 実装者が迷わず、一貫性のある配置が可能

## 具体的な改善例

### Sticky Noteの改善（グループ2の例）

**v11（ノード名リストなし）**:
```markdown
# 【グループ2: AI推論・判断】

## 目的
ユーザーの質問を理解し、適切なツールを選択・実行し、最終的な応答を生成すること。

## 背景
AI Agentは単一責務の原則に基づき...
```

**v12（ノード名リスト追加）**:
```markdown
# 【グループ2: AI推論・判断】

## このグループに含まれるノード
📌 **メインノード**: AI Agent (AI Agent)
📌 **サブノード**:
  - OpenAI Chat Model (Chat Model)
  - Simple Memory (Memory)
  - Custom Code Tool (Tool)

例:
- AI Agent
- OpenAI Chat Model / Claude Chat Model / Gemini Chat Model
- Simple Memory
- Custom Code Tool / HTTP Request Tool

## 目的
ユーザーの質問を理解し、適切なツールを選択・実行し、最終的な応答を生成すること。

## 背景
AI Agentは単一責務の原則に基づき...
```

### ノード配置の改善例

**v11（間隔が曖昧）**:
```
Chat Trigger: [240, 300]
次のノード: [460, 300]    // 間隔220px（狭い）
```

**v12（推奨パターン適用）**:
```
Sticky Note (グループ1): [100, 400]
Chat Trigger: [400, 600]               // Sticky Noteから右300px、下200px
次のノード: [800, 600]                // Chat Triggerから右400px
```

## 新しく追加されたテンプレート変数

### メインワークフロー
- `{{GROUP1_NODE_LIST}}`: グループ1のノード名リスト
- `{{AI_AGENT_NODE_NAME}}`: AI Agentのノード名
- `{{CHAT_MODEL_NODE_NAME}}`: Chat Modelのノード名
- `{{MEMORY_NODE_NAME}}`: Memoryのノード名
- `{{TOOLS_NODE_NAMES}}`: Toolsのノード名リスト（複数可）

### Error Workflow
- `{{ERROR_TRIGGER_NODE_NAME}}`: Error Triggerのノード名
- `{{ERROR_FORMAT_NODE_NAME}}`: エラー整形ノードの名前
- `{{ERROR_SEVERITY_NODE_NAME}}`: 重要度判定ノードの名前
- `{{ERROR_NOTIFICATION_NODE_NAMES}}`: 通知ノードのリスト
- `{{ERROR_LOG_NODE_NAME}}`: ログ記録ノードの名前

### 座標テンプレート変数
- `{{STICKY1_X}}`, `{{STICKY1_Y}}`: Sticky Note 1の座標
- `{{CHAT_X}}`, `{{CHAT_Y}}`: Chat Triggerの座標
- `{{AGENT_X}}`, `{{AGENT_Y}}`: AI Agentの座標
- `{{MODEL_X}}`, `{{MODEL_Y}}`: Chat Modelの座標
- （以下、各ノードごとに_X, _Y変数）

## 使用方法

### 新しいワークフロー生成時
1. **プロンプト - n8nワークフロー自動設計v12(Sticky Noteにノード名を記述).md** を使用
2. 自動的にノード名リストが含まれたSticky Noteが生成される
3. 推奨座標パターンに従って、適切な間隔でノードが配置される
4. n8nにインポートすると、重複なく読みやすいワークフローが表示される

### 既存ワークフローの修正時
1. 各Sticky Noteの`content`フィールドの最初に「このグループに含まれるノード」セクションを追加
2. ノードのposition座標を確認し、間隔が300px未満の箇所を修正
3. 階層化（Y座標）を確認し、処理パスごとに分離

## ベストプラクティス

### ノード配置の優先順位
1. **重複防止**: 最優先。ノードが重なっていたら即修正
2. **間隔確保**: 水平400px、垂直300px を標準とする
3. **階層化**: 処理パスを垂直方向で明確に分離
4. **視認性**: すべての情報（ノード名、notes、接続線）が読める

### AI Agentグループの配置
1. AI Agentをグループの中心に配置
2. Chat Modelは左上に配置（ai_languageModel接続線が短く明確）
3. Memoryは Chat Modelの下に配置（縦に並べる）
4. Output Parserは AI Agentの下に配置
5. Toolsは AI Agentの左下に配置

### 分岐ノードの配置
1. IFノードの後は必ず上下に分岐
2. 上部分岐: -300px以上上に配置（成功パス、優先度高）
3. 下部分岐: +300px以上下に配置（代替パス、エラーパス）
4. 分岐後の合流点は明確に（NoOpノード等で終点を示す）

## 検証チェックリスト

### 座標配置の検証
- [ ] すべてのノード間の水平間隔が300px以上
- [ ] すべてのノード間の垂直間隔が250px以上
- [ ] AI Agentとサブノードの垂直間隔が300px以上
- [ ] 分岐ノードの上下分岐が各300px以上離れている
- [ ] Sticky Noteが関連ノードの背景に適切に配置されている
- [ ] ノードが重複していない（目視確認）
- [ ] ノード名、notes、接続線がすべて読める（目視確認）

### Sticky Noteの検証
- [ ] 各Sticky Noteに「このグループに含まれるノード」セクションがある
- [ ] ノード名に📌マークが付いている
- [ ] ノードタイプが括弧で明記されている（例: Chat Trigger (Webhook)）
- [ ] AI Agentグループは「メインノード」と「サブノード」に分離されている
- [ ] 例が含まれている

### 全体の検証
- [ ] ワークフローをn8nにインポートして視覚的に確認
- [ ] すべてのノードが見やすい位置に配置されているか確認
- [ ] 処理の流れが直感的に理解できるか確認
- [ ] 必要に応じて座標を微調整

## 今後の改善予定

### v13で検討中の機能
- Sticky Noteのサイズを動的に調整（含まれるノード数に応じて）
- ノード配置の自動最適化アルゴリズム
- グループ間の推奨間隔を追加
- ズームレベルに応じた配置調整

## まとめ

v12では、以下の2つの最重要機能を追加しました:

1. **Sticky Noteにノード名リスト** 📌
   - グループとノードの対応が即座に分かる
   - 初心者でも理解しやすい

2. **ノード配置の最適化ルール** ⚠️
   - 具体的な間隔基準（水平300px、垂直250px）
   - 座標配置の推奨パターン
   - 重複防止と視認性の保証

**これにより、n8nプラットフォーム上で常に読みやすく、理解しやすいワークフローが生成されます。**
