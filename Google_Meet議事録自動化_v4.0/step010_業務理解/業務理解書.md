# 業務理解書 (Step010)

## ワークフロー名
Google Meet議事録自動化システム

## ビジネス要件

### 業務目的
**現状の問題点**:
- Google Meet会議終了後、手動で議事録を作成するのに1時間かかる
- 議事録の品質が担当者によってばらつきがある
- 議事録作成の遅延により、決定事項やタスクの共有が遅れる

**理想的な状態**:
- 会議録音ファイルをGoogle Driveにアップロードすると、5分以内に構造化された議事録が自動生成される
- 議題、決定事項、宿題事項が明確に整理された一貫性のある議事録
- 議事録生成完了後、即座に関係者に通知される

**定量的目標**:
- 1時間会議の議事録作成時間: 60分 → 3分（95%削減）
- 処理時間の内訳:
  - 文字起こし: 30-60秒（Gemini直接処理、従来比50%短縮）
  - AI処理（整形・分析）: 2-3分
  - 保存・移動: 10秒
- 月間削減時間: 会議20回/月 × 57分削減 = 約19時間/月

### ユースケース
**主要ユーザー**:
- 利用者: プロジェクトメンバー（10-50名）
- 議事録作成者: 万壽本（自動化オーナー）
- 閲覧者: 会議参加者全員

**使用頻度**:
- 1日あたり: 1-3回
- 1週間あたり: 5-15回
- 1ヶ月あたり: 20-60回

**使用シーン**:
1. 会議終了後、録音ファイル（M4A）をGoogle Driveの指定フォルダにアップロード
2. 5分ごとのポーリングで新規ファイルを自動検知
3. ワークフローが自動実行され、議事録を生成
4. 生成完了後、Discordで関係者に通知
5. 処理済みファイルは自動的に別フォルダに移動

### ビジネスルール
**制約条件**:
- 議事録フォーマットは業務要件定義書に従う（目的・背景、日時、参加者、宿題事項、決定事項、議事内容の構造）
- 参加者リストには必ず「万壽本」を含める
- 処理済みM4Aファイルは `processed/` フォルダに移動
- エラー発生時のファイルは `/エラー/` フォルダに移動

**データ保持期間**:
- 議事録: 無期限（Google Drive上）
- M4Aファイル: 処理後も保持（`processed/` フォルダ）
- エラーログ: n8n内で7日間

**承認フロー**:
- 議事録生成に承認は不要（自動生成・自動保存）
- エラー発生時は管理者（万壽本）に即座にDiscord通知

## 機能要件

### トリガー条件
**トリガータイプ**:
- Google Drive Trigger（Event型）
- ポーリング間隔: 5分ごと
- 監視対象: 指定フォルダ配下の新規M4Aファイル

**トリガー頻度**:
- リアルタイム風（5分間隔でのポーリング）
- 新規ファイル検知時に即座に実行

**トリガーデータの形式**:
```json
{
  "fileId": "Google Drive File ID",
  "fileName": "会議録.m4a",
  "mimeType": "audio/m4a",
  "createdTime": "2025-01-09T10:00:00Z",
  "size": 123456789,
  "downloadUrl": "https://drive.google.com/..."
}
```

### データ処理
**入力データの形式**:
- M4A音声ファイル（Google Drive上）
- ファイルサイズ: 最大1GB（1時間会議想定）
- 音声形式: audio/m4a

**データ変換ロジック**:
1. **M4Aダウンロード**: Google Driveからバイナリデータとしてダウンロード
2. **Gemini文字起こし（ネイティブ）**:
   - M4A → 日本語テキスト（話者分離、タイムスタンプ付き）
   - 処理時間: 30-60秒（1時間会議）
   - Speaker Diarization: プロンプトベース（speaker A, B, C等）
   - Punctuation: 自動挿入
   - Timestamps: audioTimestamp=true
3. **チャンク分割**:
   - 20-30行ごとに分割
   - 前後6行のオーバーラップ追加（文脈保持）
4. **並列処理（Step1）**:
   - 5チャンク並列でフィラー除去・箇条書き化
   - バッチサイズ: 5
5. **チャンク統合（Merge）**:
   - line_id でソート、重複除去
6. **議題抽出（Step2）**:
   - 統合テキストから議題を自動抽出
   - 各議題に該当する行番号を記録
7. **議題ごとのデータ再構成（Code）**:
   - 議題ごとに該当文字起こしを収集
8. **並列処理（Step3）**:
   - 3議題並列で決定事項・宿題・保留事項を抽出
   - バッチサイズ: 3
9. **フォーマット変換（Step4）**:
   - 全データを統合し、指定フォーマットのMarkdownを生成
10. **品質保証（Step5）**:
    - 生成議事録の完全性を検証、不足項目を補完

**出力データの形式**:
- Markdown形式の議事録（UTF-8）
- ファイル名: `minutes - {YYYY-MM-DD} - {会議名}.md`
- 保存先: Google Drive `議事録_出力/` フォルダ

### 統合要件
**外部システム・サービス**:

1. **Google Drive**（必須）:
   - 用途: トリガー、ファイル取得、議事録保存、ファイル移動
   - API: Google Drive API v3
   - 認証方式: OAuth2（n8nで設定）
   - エンドポイント:
     - `files.list`: ファイル検索
     - `files.get`: メタデータ取得
     - `files.download`: M4Aダウンロード
     - `files.create`: 議事録保存
     - `files.update`: ファイル移動

2. **Google Gemini**（必須）:
   - 用途: 音声文字起こし（ネイティブ）+ AI処理（Step1-3）
   - API: Gemini API v1
   - モデル: Gemini 2.0 Flash
   - 認証方式: API Key
   - 環境変数: `GOOGLE_API_KEY`
   - エンドポイント: `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash`
   - 対応フォーマット: audio/m4a, audio/mp3, audio/wav, audio/aac, audio/flac, audio/ogg
   - 処理能力:
     - Max Duration: 8.4時間（1 million tokens）
     - Speaker Diarization: プロンプトベース
     - Timestamps: audioTimestamp=true

3. **Anthropic Claude**（必須）:
   - 用途: AI処理（Step4-5: フォーマット変換・品質保証）
   - API: Claude API
   - モデル: Claude Sonnet 4.5
   - 認証方式: API Key
   - 環境変数: `ANTHROPIC_API_KEY`
   - エンドポイント: `https://api.anthropic.com/v1/messages`

4. **Discord Webhook**（オプション）:
   - 用途: 処理完了通知、エラー通知
   - 認証方式: Webhook URL
   - 環境変数: `DISCORD_WEBHOOK_URL`

**データ同期方向**:
- Google Drive → n8n: 一方向（M4Aダウンロード）
- n8n → Google Drive: 一方向（議事録保存、ファイル移動）
- n8n → Discord: 一方向（通知）

### AI処理
**AI判断の対象**:

1. **音声文字起こし（Gemini）**:
   - 判断内容: M4A音声 → 日本語テキスト変換（話者分離、タイムスタンプ付き）
   - 入力データ: M4Aバイナリデータ
   - 期待する出力:
     ```json
     {
       "lines": [
         {
           "line_id": 1,
           "content": "発言内容",
           "speaker": "A",
           "timestamp": "00:01:20",
           "start_time": 80.5,
           "end_time": 85.2
         }
       ],
       "total_lines": 300
     }
     ```
   - モデル: Gemini 2.0 Flash
   - Temperature: デフォルト
   - Max Tokens: 自動

2. **文字起こし整形（Step1、Gemini）**:
   - 判断内容: フィラー語除去、箇条書き化
   - 入力データ: 文字起こしチャンク（20-30行 + 前後6行）
   - 期待する出力: 整形済みJSON配列
   - モデル: Gemini 2.0 Flash
   - Memory: なし（並列処理）
   - Temperature: 0.4
   - Max Tokens: 4000

3. **議題抽出（Step2、Gemini）**:
   - 判断内容: 会話の流れから議題を自動抽出
   - 入力データ: 統合済み文字起こし（全行）
   - 期待する出力: 議題リスト（タイトル、該当行番号）
   - モデル: Gemini 2.0 Flash
   - Memory: あり（Simple Memory、session_key: `step2_memory`）
   - Temperature: 0.4
   - Max Tokens: 4000

4. **議題分析（Step3、Gemini）**:
   - 判断内容: 決定事項、宿題、保留事項の抽出
   - 入力データ: 議題ごとの文字起こし
   - 期待する出力: 決定事項・宿題・保留事項のリスト
   - モデル: Gemini 2.0 Flash
   - Memory: なし（並列処理）
   - Temperature: 0.4
   - Max Tokens: 4000

5. **フォーマット変換（Step4、Claude）**:
   - 判断内容: 全データを統合し、指定フォーマットのMarkdownを生成
   - 入力データ: 会議名、議題分析結果、全文字起こし、ファイルメタデータ
   - 期待する出力: 業務要件定義書フォーマットのMarkdown
   - モデル: Claude Sonnet 4.5
   - Memory: あり（Simple Memory、session_key: `step4_memory`）
   - Temperature: 0.7
   - Max Tokens: 8000

6. **品質保証（Step5、Claude）**:
   - 判断内容: 議事録の完全性検証、不足項目補完
   - 入力データ: 生成済み議事録、元データ
   - 期待する出力: 補完済み議事録 + 警告リスト
   - モデル: Claude Sonnet 4.5
   - Memory: あり（Simple Memory、session_key: `step5_memory`）
   - Temperature: 0.7
   - Max Tokens: 8000

**AI処理の依存関係**:
```
Gemini音声文字起こし（Step0）
  ↓
並列: Gemini整形（Step1、5チャンク並列）
  ↓
Gemini議題抽出（Step2）
  ↓
並列: Gemini議題分析（Step3、3議題並列）
  ↓
Claudeフォーマット変換（Step4）
  ↓
Claude品質保証（Step5）
```

## 非機能要件

### パフォーマンス
**目標処理時間**:
- 1時間会議の総処理時間: **3分以内**（改善後）
  - 文字起こし（Gemini直接）: 30-60秒（従来比50%短縮）
  - AI処理（Step1-5）: 2-3分
  - 保存・移動: 10秒

**最大スループット**:
- 1時間あたり: 20ワークフロー実行（並列実行なし）
- 1日あたり: 100ワークフロー実行

**並列実行の必要性**:
- ワークフロー間の並列実行: 不要（5分間隔ポーリング）
- ワークフロー内の並列処理:
  - チャンク並列処理（Step1）: 5チャンク同時処理
  - 議題並列処理（Step3）: 3議題同時処理

**パフォーマンスボトルネック対策**:
- Geminiネイティブ文字起こし採用（Deepgram比50%高速化）
- バッチサイズ最適化（APIレート制限を考慮）

### セキュリティ
**認証方式**:
- Google Drive: OAuth2（n8nで管理）
- Google Gemini: API Key（環境変数 `GOOGLE_API_KEY`）
- Anthropic Claude: API Key（環境変数 `ANTHROPIC_API_KEY`）
- Discord: Webhook URL（環境変数 `DISCORD_WEBHOOK_URL`）

**アクセス制御**:
- Google Drive:
  - 読み取り権限: ワークフロー実行用サービスアカウント
  - 書き込み権限: 議事録保存フォルダへの書き込み
- n8n:
  - ワークフロー編集: 管理者のみ
  - 実行ログ閲覧: 管理者のみ

**データ暗号化**:
- 通信時: HTTPS/TLS 1.2以上（すべてのAPI通信）
- 保存時: Google Drive標準暗号化（保存時暗号化）
- n8n内部: 一時ファイルは処理後削除（機密情報の残留防止）

**機密情報の取り扱い**:
- API Key: n8n環境変数で管理（平文保存しない）
- OAuth Token: n8nで安全に管理
- 議事録: Google Drive上で組織アクセス制御

### 信頼性
**エラー許容度**:
- 目標成功率: 95%以上
- 許容エラー率: 5%未満
- 重大エラー（データ損失）: 0%

**リトライ戦略**:
1. **Gemini文字起こし失敗**:
   - リトライ回数: 3回
   - リトライ間隔: 5秒、10秒、20秒（Exponential Backoff）
   - 失敗時の対応: M4Aファイルを `/エラー/` フォルダに移動、Discord通知

2. **AI処理失敗（Step1-5）**:
   - リトライ回数: 2回
   - リトライ間隔: 3秒、10秒
   - 失敗時の対応: 部分生成議事録を `[ERROR]minutes - ...` として保存、Discord通知

3. **Google Drive失敗**:
   - リトライ回数: 3回
   - リトライ間隔: 5秒、10秒、20秒
   - 失敗時の対応: n8n内部ストレージに一時保存、管理者に通知

**データ整合性保証**:
- トランザクション: 議事録保存とファイル移動は順次実行（保存成功後に移動）
- ロールバック:
  - 議事録保存失敗 → ファイル移動なし
  - エラー発生時 → エラーフォルダに移動

**エラーハンドリング**:
- Error Trigger（各ノードのエラー出力を受け取る）
- エラー種別判定:
  1. Gemini文字起こし失敗 → `/エラー/` に移動
  2. AI処理失敗 → `[ERROR]minutes - ...` として保存
  3. Google Drive失敗 → n8n内部ストレージに一時保存

## 運用要件

### 運用・監視
**ログレベル**:
- INFO: ワークフロー開始、各ステップ完了、議事録保存完了
- WARNING: リトライ発生、API遅延
- ERROR: ステップ失敗、ファイル移動失敗、API呼び出し失敗

**アラート条件**:
1. **エラー発生時**:
   - トリガー: エラーステータス検知
   - 通知先: Discord Webhook
   - 通知内容: エラー種別、ファイル名、エラーメッセージ

2. **処理時間超過時**:
   - トリガー: 処理時間 > 5分
   - 通知先: Discord Webhook
   - 通知内容: ファイル名、処理時間、処理ステップ

3. **処理完了時（オプション）**:
   - トリガー: ワークフロー正常終了
   - 通知先: Discord Webhook
   - 通知内容: 議事録保存先URL、処理時間

**監視メトリクス**:
- 成功率: 成功実行数 / 総実行数
- 平均処理時間: 実行時間の平均値
- エラー率: エラー実行数 / 総実行数
- APIレート制限: Gemini/Claude API呼び出し回数

**ダッシュボード**:
- n8n実行履歴ダッシュボード（標準機能）
- Discord通知ログ（手動確認）

### 保守・拡張
**将来追加予定の機能**:
1. **他言語対応**:
   - 英語、中国語の会議に対応
   - Gemini多言語文字起こし機能を活用

2. **議事録フォーマットのカスタマイズ**:
   - プロジェクトごとに異なるフォーマットを選択可能
   - テンプレート管理機能の追加

3. **アクションアイテム自動追跡**:
   - 宿題事項を自動的にタスク管理システム（Notion、Trello等）に登録
   - 期限管理とリマインダー機能

4. **話者の自動識別**:
   - 音声特徴から話者を自動識別
   - 参加者名簿との照合

**データ量増加への対応**:
- スケーリング戦略:
  - M4Aファイルサイズ増加 → Gemini Max Duration（8.4時間）で対応
  - 処理頻度増加 → n8nワークフロー並列実行数を調整
  - ストレージ増加 → Google Driveストレージプラン拡張

**外部連携の追加可能性**:
1. **Slack連携**: Discord代替としてSlack通知
2. **Notion連携**: 議事録をNotionデータベースに自動保存
3. **Trello/Asana連携**: 宿題事項を自動的にタスクカードとして登録
4. **Zoom連携**: Zoom録画ファイルの自動処理

**モジュール設計**:
- グループ単位での独立性: 各グループは独立して動作
- AI処理の交換可能性: モデル変更（Gemini → GPT-4等）が容易
- フォーマット変換の柔軟性: Step4プロンプトのみ変更で対応

## 次ステップへの引き継ぎ事項

### AI処理が必要な箇所（6箇所）
1. **Gemini音声文字起こし（Step0）**: M4A → 日本語テキスト（話者分離、タイムスタンプ）
2. **Gemini文字起こし整形（Step1）**: フィラー除去、箇条書き化（並列処理）
3. **Gemini議題抽出（Step2）**: 会話の流れから議題を自動抽出
4. **Gemini議題分析（Step3）**: 決定事項、宿題、保留事項の抽出（並列処理）
5. **Claudeフォーマット変換（Step4）**: 全データ統合、指定フォーマットMarkdown生成
6. **Claude品質保証（Step5）**: 議事録の完全性検証、不足項目補完

### 外部連携が必要なシステム（4システム）
1. **Google Drive**: トリガー、ファイル取得、議事録保存、ファイル移動
2. **Google Gemini**: 音声文字起こし（ネイティブ）+ AI処理（Step1-3）
3. **Anthropic Claude**: AI処理（Step4-5）
4. **Discord Webhook**: 処理完了通知、エラー通知（オプション）

### 特記事項
1. **Geminiネイティブ文字起こし採用**:
   - 従来のDeepgram APIを廃止し、Gemini 2.0 FlashのネイティブTranscribe機能を使用
   - 処理時間50%短縮（60-120秒 → 30-60秒）
   - コスト70-85%削減（Deepgram料金不要）
   - 認証情報1つ削減（管理簡素化）

2. **並列処理の重要性**:
   - Step1（チャンク並列処理）: 5チャンク同時処理
   - Step3（議題並列処理）: 3議題同時処理
   - APIレート制限を考慮したバッチサイズ設計

3. **エラーハンドリングの完全性**:
   - 全グループにエラー出力を定義
   - Error Trigger → 種別判定 → ファイル移動 → Discord通知

4. **議事録フォーマットの厳格性**:
   - 業務要件定義書のフォーマットに厳密に従う
   - Step4のプロンプトに詳細なフォーマット指定が必要

5. **パフォーマンス目標**:
   - 1時間会議の総処理時間: 3分以内
   - 月間削減時間: 約19時間/月（会議20回/月想定）

6. **セキュリティ要件**:
   - すべてのAPI通信はHTTPS/TLS 1.2以上
   - API Keyは環境変数で管理（平文保存しない）
   - 議事録はGoogle Drive組織アクセス制御
