# 技術要件書 (Step030)

## ワークフロー名
Google Meet議事録自動化システム

---

## 12層アーキテクチャ概要

本ワークフローは、データフロー層（L1-L7）と横断的関心事層（L8-L12）を統合した12層アーキテクチャで設計されます。

### データフロー層（L1-L7）
```
L1: Trigger → L2: Input → L3: Validation → L4: Transformation →
L5: Core Logic → L6: Integration → L7: Output
```

### 横断的関心事層（L8-L12）
```
L8: Error Handling（エラー検知・リカバリ）
L9: Security（認証・認可・暗号化）
L10: Monitoring（ログ出力・メトリクス収集）
L11: Performance（並列処理・最適化）
L12: Orchestration（フロー制御・条件分岐）
```

---

## 業務要件の層別分解

### データフロー層（L1-L7）

| 層 | 業務要件（Step010より） | 該当要素 |
|----|------------------------|---------|
| **L1: Trigger** | Google Drive新規ファイル検知 | 5分ごとのポーリング、M4Aファイル検知 |
| **L2: Input** | M4Aファイルダウンロード | Google DriveからM4Aバイナリデータ取得 |
| **L3: Validation** | ファイル形式検証 | mimeType=audio/m4a確認、ファイルサイズ<1GB確認 |
| **L4: Transformation** | 音声→テキスト変換 | Gemini音声文字起こし、チャンク分割、整形、議題抽出、データ再構成 |
| **L5: Core Logic** | AI判断・分析 | 文字起こし整形（Step1）、議題抽出（Step2）、議題分析（Step3）、フォーマット変換（Step4）、品質保証（Step5） |
| **L6: Integration** | 外部システム連携 | Google Drive議事録保存、Google Driveファイル移動、Discord通知 |
| **L7: Output** | 最終結果出力 | 議事録Markdown保存、処理完了通知 |

### 横断的関心事層（L8-L12）

| 層 | 業務要件（Step010より） | 該当要素 |
|----|------------------------|---------|
| **L8: Error Handling** | エラー時リトライ、エラーフォルダ移動 | Gemini失敗時3回リトライ、AI失敗時2回リトライ、エラー通知 |
| **L9: Security** | API認証、データ暗号化 | Google Drive OAuth2、Gemini API Key、Claude API Key、HTTPS通信 |
| **L10: Monitoring** | ログ記録、処理時間計測 | n8n実行ログ、Discord通知、エラーログ |
| **L11: Performance** | 並列処理、バッチ処理 | チャンク並列処理（5並列）、議題並列処理（3並列）、処理時間3分以内 |
| **L12: Orchestration** | フロー制御、条件分岐 | Split in Batches、Merge、IF分岐、Loop制御 |

---

## データフロー層マッピング（L1-L7）

### L1: Trigger層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **Google Drive Trigger** | Google Drive: 新規ファイル検知 | 5分ごとにポーリング、M4Aファイル検知 | 外部（Google Drive） | L2 |

**パラメータ設定**:
```json
{
  "resource": "file",
  "event": "fileCreated",
  "triggerOn": "specificFolder",
  "folderToWatch": "/議事録_入力/",
  "pollTimes": {
    "item": [
      {
        "mode": "everyMinute",
        "minuteInterval": 5
      }
    ]
  },
  "filters": {
    "mimeType": "audio/m4a"
  }
}
```

---

### L2: Input層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **Google Drive: Get File Info** | Google Drive: ファイル情報取得 | ファイルメタデータ取得 | L1 | L2.2 |
| **Google Drive: Download** | Google Drive: M4Aダウンロード | M4Aバイナリデータ取得 | L2.1 | L3 |

**ノード1: ファイル情報取得**:
```json
{
  "resource": "file",
  "operation": "get",
  "fileId": "={{ $json.id }}",
  "options": {
    "fields": "id, name, mimeType, size, createdTime, webContentLink"
  }
}
```

**ノード2: M4Aダウンロード**:
```json
{
  "resource": "file",
  "operation": "download",
  "fileId": "={{ $json.id }}",
  "binaryPropertyName": "m4a_data"
}
```

---

### L3: Validation層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **IF** | バリデーション: ファイル形式確認 | mimeType確認、サイズ確認 | L2 | L4（成功）、L8（失敗） |

**パラメータ設定**:
```json
{
  "conditions": {
    "string": [
      {
        "value1": "={{ $json.mimeType }}",
        "operation": "equals",
        "value2": "audio/m4a"
      }
    ],
    "number": [
      {
        "value1": "={{ $json.size }}",
        "operation": "smaller",
        "value2": 1073741824
      }
    ]
  },
  "combineOperation": "all"
}
```

---

### L4: Transformation層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **Code** | チャンク分割 + オーバーラップ | 文字起こしを20-30行ごとに分割 | L5.1 | L11（並列処理） |
| **Code** | チャンク統合（Merge後） | line_idでソート、重複除去 | L11（Merge） | L5.2 |
| **Code** | 議題ごとのデータ再構成 | 各議題に該当する文字起こし収集 | L5.2 | L11（並列処理） |

**ノード1: チャンク分割**:
```javascript
const lines = $input.item.json.lines;
const chunkSize = 25;
const overlapSize = 6;
const chunks = [];

for (let i = 0; i < lines.length; i += chunkSize) {
  chunks.push({
    chunk_id: Math.floor(i / chunkSize) + 1,
    main_text: lines.slice(i, i + chunkSize),
    overlap_before: i > 0 ? lines.slice(i - overlapSize, i) : null,
    overlap_after: i + chunkSize < lines.length ? lines.slice(i + chunkSize, i + chunkSize + overlapSize) : null,
    line_range: [i + 1, Math.min(i + chunkSize, lines.length)]
  });
}

return chunks.map(chunk => ({ json: chunk }));
```

**ノード2: チャンク統合**:
```javascript
const allLines = [];
for (const item of $input.all()) {
  allLines.push(...item.json.lines);
}

// line_id でソート、重複除去
const uniqueLines = allLines
  .sort((a, b) => a.line_id - b.line_id)
  .filter((line, index, self) =>
    index === 0 || line.line_id !== self[index - 1].line_id
  );

return [{ json: { lines: uniqueLines } }];
```

**ノード3: 議題ごとのデータ再構成**:
```javascript
const agendas = $input.first().json.agendas;
const allLines = $input.first().json.all_lines;

const reconstructedAgendas = agendas.map(agenda => {
  const lines = agenda.line_ids.map(id =>
    allLines.find(line => line.line_id === id)
  ).filter(line => line !== undefined);

  return {
    agenda_id: agenda.agenda_id,
    title: agenda.title,
    lines: lines
  };
});

return reconstructedAgendas.map(agenda => ({ json: agenda }));
```

---

### L5: Core Logic層（AI処理）

| AI処理 | n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|-------|---------------|---------|------|-------|-------|
| **Step0** | **AI Agent (Gemini)** | Gemini: 音声文字起こし | M4A→日本語テキスト | L3 | L4.1 |
| **Step1** | **AI Agent (Gemini)** | Gemini: 文字起こし整形 | フィラー除去、箇条書き化 | L11（並列） | L11（Merge） |
| **Step2** | **AI Agent (Gemini)** | Gemini: 議題抽出 | 会話から議題抽出 | L4.2 | L4.3 |
| **Step3** | **AI Agent (Gemini)** | Gemini: 議題分析 | 決定事項・宿題・保留抽出 | L11（並列） | L11（Merge） |
| **Step4** | **AI Agent (Claude)** | Claude: フォーマット変換 | Markdown議事録生成 | L11（Merge） | L5.5 |
| **Step5** | **AI Agent (Claude)** | Claude: 品質保証 | 議事録検証・補完 | L5.4 | L6 |

**AI Agent共通設定**:
- Step020のAI設定書に記載されたモデル、温度、トークン数を使用
- Memory設定: Step2（session_key: step2_memory）、Step4（session_key: step4_memory）、Step5（session_key: step5_memory）
- System Promptは各AI処理ごとに定義（Step020参照）

---

### L6: Integration層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **Google Drive: Create File** | Google Drive: 議事録保存 | Markdown議事録をGoogle Driveに保存 | L5.5 | L6.2 |
| **Google Drive: Update File** | Google Drive: M4Aファイル移動 | 処理済みフォルダに移動 | L6.1 | L6.3 |
| **Discord Webhook** | Discord: 処理完了通知 | 議事録保存完了を通知 | L6.2 | L7 |

**ノード1: 議事録保存**:
```json
{
  "resource": "file",
  "operation": "create",
  "name": "={{ 'minutes - ' + $now.format('YYYY-MM-DD') + ' - ' + $json.meeting_name + '.md' }}",
  "parents": {
    "folderId": "/議事録_出力/"
  },
  "mimeType": "text/markdown",
  "binaryData": false,
  "options": {
    "fileContent": "={{ $json.markdown }}"
  }
}
```

**ノード2: M4Aファイル移動**:
```json
{
  "resource": "file",
  "operation": "update",
  "fileId": "={{ $('Google Drive: 新規ファイル検知').item.json.id }}",
  "updateFields": {
    "parents": {
      "folderId": "/processed/"
    }
  }
}
```

**ノード3: Discord通知**:
```json
{
  "webhookUrl": "={{ $env.DISCORD_WEBHOOK_URL }}",
  "content": "✅ 議事録生成完了！\n📄 ファイル: {{ $json.name }}\n🔗 URL: {{ $json.webViewLink }}\n⏱ 処理時間: {{ $executionTime }}秒"
}
```

---

### L7: Output層

| n8nノードタイプ | ノード名 | 責務 | 入力元 | 出力先 |
|---------------|---------|------|-------|-------|
| **Set** | 最終結果セット | 処理結果をJSON形式でセット | L6.3 | ワークフロー終了 |

**パラメータ設定**:
```json
{
  "values": {
    "string": [
      {
        "name": "status",
        "value": "success"
      },
      {
        "name": "minutes_url",
        "value": "={{ $json.webViewLink }}"
      },
      {
        "name": "execution_time",
        "value": "={{ $executionTime }}"
      }
    ]
  }
}
```

---

## 横断的関心事層マッピング（L8-L12）

### L8: Error Handling層

| n8nノードタイプ | ノード名 | 責務 | トリガー条件 | リカバリー処理 |
|---------------|---------|------|------------|--------------|
| **Error Trigger** | エラー検知 | 全ノードのエラーを受け取る | 任意のノードエラー | L8.2 |
| **Code** | エラー情報整理 | エラー種別、メッセージ、ノード名を整理 | L8.1 | L8.3 |
| **IF** | エラー種別判定 | Gemini失敗、AI失敗、Drive失敗を分類 | L8.2 | L8.4/L8.5/L8.6 |
| **Google Drive: Update File** | エラーファイル移動 | M4Aを/エラー/フォルダに移動 | L8.3（Gemini失敗） | L8.7 |
| **Google Drive: Create File** | エラー議事録保存 | `[ERROR]minutes - ...`として保存 | L8.3（AI失敗） | L8.7 |
| **Set** | エラー一時保存 | n8n内部ストレージに保存 | L8.3（Drive失敗） | L8.7 |
| **Discord Webhook** | エラー通知 | 管理者にDiscord通知 | L8.4/L8.5/L8.6 | ワークフロー終了 |

**エラーリトライ設定**:
- **Gemini API**: 最大3回リトライ、Exponential Backoff（5秒、10秒、20秒）
- **Claude API**: 最大2回リトライ、固定間隔（3秒、10秒）
- **Google Drive API**: 最大3回リトライ、Exponential Backoff（5秒、10秒、20秒）

**エラー通知フォーマット**:
```json
{
  "content": "🚨 エラー発生！\n種別: {{ $json.error_type }}\nファイル: {{ $json.file_name }}\nメッセージ: {{ $json.error_message }}\nノード: {{ $json.node_name }}"
}
```

---

### L9: Security層

| セキュリティ要素 | n8n実装方法 | 設定値 |
|----------------|-----------|-------|
| **Google Drive認証** | OAuth2 Credentials | n8nで設定、スコープ: drive.file |
| **Gemini API認証** | API Key Credentials | 環境変数 `GOOGLE_API_KEY` |
| **Claude API認証** | API Key Credentials | 環境変数 `ANTHROPIC_API_KEY` |
| **Discord Webhook** | Webhook URL | 環境変数 `DISCORD_WEBHOOK_URL` |
| **通信暗号化** | HTTPS/TLS 1.2+ | すべてのAPI通信で強制 |
| **データ暗号化** | Google Drive標準暗号化 | 保存時暗号化（AES-256） |

**Credentials設定**:
```json
{
  "googleDrive": {
    "oauthTokenData": "n8nで自動管理",
    "scopes": ["https://www.googleapis.com/auth/drive.file"]
  },
  "gemini": {
    "apiKey": "={{ $env.GOOGLE_API_KEY }}"
  },
  "claude": {
    "apiKey": "={{ $env.ANTHROPIC_API_KEY }}"
  }
}
```

---

### L10: Monitoring層

| n8nノードタイプ | ノード名 | 責務 | ログ種別 | 出力先 |
|---------------|---------|------|---------|-------|
| **Sticky Note** | ステップ説明 | 各グループの処理内容を記述 | ドキュメント | n8nキャンバス |
| **Set** | ログ記録 | 処理ステップ、処理時間、データサイズを記録 | INFO | n8n実行ログ |
| **Discord Webhook** | 処理完了通知 | 議事録保存完了を通知 | INFO | Discord |
| **Discord Webhook** | エラー通知 | エラー発生時に管理者に通知 | ERROR | Discord |

**ログフォーマット**:
```json
{
  "timestamp": "={{ $now.toISO() }}",
  "step": "Step1: 文字起こし整形",
  "status": "completed",
  "execution_time": "={{ $executionTime }}",
  "data_size": "={{ $json.lines.length }} lines"
}
```

**監視メトリクス**:
- 成功率: n8n実行履歴から計算
- 平均処理時間: n8n実行履歴から計算
- エラー率: n8n実行履歴から計算
- APIレート制限: Gemini/Claude API呼び出し回数

---

### L11: Performance層

| n8nノードタイプ | ノード名 | 責務 | 並列度 | 対象 |
|---------------|---------|------|-------|------|
| **Split in Batches** | チャンク並列処理 | 5チャンク並列でAI処理 | 5 | Step1（文字起こし整形） |
| **Merge** | チャンク統合 | 全チャンクをマージ、重複除去 | - | Step1結果 |
| **Split in Batches** | 議題並列処理 | 3議題並列でAI処理 | 3 | Step3（議題分析） |
| **Merge** | 議題統合 | 全議題をマージ | - | Step3結果 |

**Split in Batches設定（チャンク並列）**:
```json
{
  "batchSize": 5,
  "options": {
    "reset": false
  }
}
```

**Split in Batches設定（議題並列）**:
```json
{
  "batchSize": 3,
  "options": {
    "reset": false
  }
}
```

**Merge設定**:
```json
{
  "mode": "append",
  "options": {
    "removeDuplicates": true,
    "duplicateComparisonField": "line_id"
  }
}
```

**パフォーマンス目標**:
- 1時間会議の総処理時間: **3分以内**
  - 文字起こし（Gemini）: 30-60秒
  - AI処理（Step1-5）: 2-3分
  - 保存・移動: 10秒

---

### L12: Orchestration層

| n8nノードタイプ | ノード名 | 責務 | 分岐条件 |
|---------------|---------|------|---------|
| **IF** | バリデーション分岐 | ファイル形式が正しいか判定 | mimeType=audio/m4a |
| **IF** | エラー種別分岐 | エラー種別を判定 | error_type=gemini/ai/drive |
| **Split in Batches** | チャンク並列制御 | チャンクをバッチ処理 | batchSize=5 |
| **Split in Batches** | 議題並列制御 | 議題をバッチ処理 | batchSize=3 |
| **Merge** | データ統合 | 並列処理結果をマージ | - |

**フロー制御パターン**:
1. **バリデーション分岐**: L3でファイル形式確認 → 成功時L4、失敗時L8
2. **並列処理**: L11でSplit in Batches → 並列AI処理 → Merge
3. **エラー分岐**: L8でエラー種別判定 → 各リカバリー処理

---

## データフロー設計

### 全体データフロー

```
[外部: Google Drive]
    ↓ (M4Aファイルアップロード)
[L1: Google Drive Trigger] ← 5分ごとポーリング
    ↓ (fileId, fileName, mimeType, size, createdTime)
[L2.1: Google Drive: Get File Info]
    ↓ (ファイルメタデータ)
[L2.2: Google Drive: M4Aダウンロード]
    ↓ (M4Aバイナリデータ)
[L3: IF: ファイル形式確認]
    ↓ (成功時)                     ↓ (失敗時)
[L5.0: Gemini音声文字起こし]      [L8: エラーハンドリング]
    ↓ (lines: [{line_id, content, speaker, timestamp}])
[L4.1: Code: チャンク分割]
    ↓ (chunks: [{chunk_id, main_text, overlap_before, overlap_after}])
[L11.1: Split in Batches] (batchSize=5)
    ↓ (5チャンク並列)
[L5.1: Gemini文字起こし整形] × 5
    ↓ (整形済みchunks)
[L11.1: Merge]
    ↓ (統合lines)
[L4.2: Code: チャンク統合]
    ↓ (全lines統合、重複除去)
[L5.2: Gemini議題抽出]
    ↓ (meeting_name, agendas: [{agenda_id, title, line_ids}])
[L4.3: Code: 議題ごとのデータ再構成]
    ↓ (agendas: [{agenda_id, title, lines}])
[L11.2: Split in Batches] (batchSize=3)
    ↓ (3議題並列)
[L5.3: Gemini議題分析] × 3
    ↓ (議題分析結果)
[L11.2: Merge]
    ↓ (全議題分析結果)
[L5.4: Claudeフォーマット変換]
    ↓ (Markdown議事録)
[L5.5: Claude品質保証]
    ↓ (最終Markdown議事録)
[L6.1: Google Drive: 議事録保存]
    ↓ (議事録URL)
[L6.2: Google Drive: M4Aファイル移動]
    ↓ (移動完了)
[L6.3: Discord: 処理完了通知]
    ↓ (通知完了)
[L7: Set: 最終結果]
    ↓ (status, minutes_url, execution_time)
[ワークフロー終了]
```

### エラーフロー

```
[任意のノードエラー]
    ↓
[L8.1: Error Trigger]
    ↓ (エラー情報)
[L8.2: Code: エラー情報整理]
    ↓ (error_type, error_message, node_name, file_name)
[L8.3: IF: エラー種別判定]
    ↓
    ├─ Gemini失敗 → [L8.4: Google Drive: エラーファイル移動 (/エラー/)]
    ├─ AI失敗 → [L8.5: Google Drive: エラー議事録保存 ([ERROR]minutes - ...)]
    └─ Drive失敗 → [L8.6: Set: エラー一時保存 (n8n内部)]
    ↓
[L8.7: Discord: エラー通知]
    ↓
[ワークフロー終了]
```

---

## n8nノード選定詳細

### データフロー層ノード一覧

| 層 | ノードタイプ | 総数 | 主要ノード |
|----|------------|------|-----------|
| L1 | Google Drive Trigger | 1 | 新規ファイル検知 |
| L2 | Google Drive | 2 | ファイル情報取得、M4Aダウンロード |
| L3 | IF | 1 | ファイル形式確認 |
| L4 | Code | 3 | チャンク分割、チャンク統合、議題データ再構成 |
| L5 | AI Agent | 6 | Gemini×4（Step0-3）、Claude×2（Step4-5） |
| L6 | Google Drive + Discord | 3 | 議事録保存、ファイル移動、通知 |
| L7 | Set | 1 | 最終結果 |

### 横断的関心事層ノード一覧

| 層 | ノードタイプ | 総数 | 主要ノード |
|----|------------|------|-----------|
| L8 | Error Trigger + Code + IF + Google Drive + Discord | 7 | エラー検知、種別判定、リカバリー、通知 |
| L9 | Credentials（設定のみ） | 4 | Google Drive OAuth2、Gemini API、Claude API、Discord Webhook |
| L10 | Sticky Note + Set + Discord | 多数 | ステップ説明、ログ記録、通知 |
| L11 | Split in Batches + Merge | 4 | チャンク並列処理、議題並列処理、各2組 |
| L12 | IF + Split in Batches | 3 | バリデーション分岐、並列制御 |

### 総ノード数推定

- **データフロー層**: 約17ノード
- **横断的関心事層**: 約18ノード（Sticky Note除く）
- **Sticky Note**: 各グループに1-2個、合計約20個
- **総計**: 約55ノード

---

## 技術制約と要件

### n8nバージョン要件
- **n8n**: v1.0.0以上
- **LangChain統合**: @n8n/n8n-nodes-langchain v1.0.0以上

### 必須Credentials
1. **Google Drive OAuth2**: スコープ `drive.file`
2. **Gemini API Key**: 環境変数 `GOOGLE_API_KEY`
3. **Anthropic API Key**: 環境変数 `ANTHROPIC_API_KEY`
4. **Discord Webhook URL**: 環境変数 `DISCORD_WEBHOOK_URL`（オプション）

### パフォーマンス要件
- **処理時間**: 3分以内（1時間会議）
- **並列度**: チャンク5並列、議題3並列
- **リトライ**: Gemini 3回、Claude 2回、Google Drive 3回

### セキュリティ要件
- **通信暗号化**: HTTPS/TLS 1.2+
- **データ暗号化**: Google Drive標準暗号化（AES-256）
- **API Key管理**: n8n環境変数で管理

### 監視要件
- **ログ記録**: n8n実行ログ（INFO、ERROR）
- **通知**: Discord Webhook（処理完了、エラー）
- **メトリクス**: 成功率、処理時間、エラー率

---

## 次ステップへの引き継ぎ事項

### グループ分解（Step040への引き継ぎ）

推定グループ数: **13グループ**（メインフロー12 + エラーフロー1）

**メインフローグループ（12グループ）**:
1. Group 1: トリガー & ファイル取得（L1-L2）
2. Group 2: バリデーション（L3）
3. Group 3: Gemini音声文字起こし（L5.0）
4. Group 4: チャンク分割（L4.1）
5. Group 5: チャンク並列処理（L11.1 + L5.1）
6. Group 6: チャンク統合（L11.1 Merge + L4.2）
7. Group 7: 議題抽出（L5.2）
8. Group 8: 議題データ再構成（L4.3）
9. Group 9: 議題並列処理（L11.2 + L5.3）
10. Group 10: 議題統合 + フォーマット変換（L11.2 Merge + L5.4）
11. Group 11: 品質保証 + 議事録保存（L5.5 + L6.1）
12. Group 12: ファイル移動 + 通知 + 最終結果（L6.2 + L6.3 + L7）

**エラーフローグループ（1グループ）**:
13. Error Group 1: エラーハンドリング（L8全体）

### 重要な設計ポイント

1. **Geminiネイティブ文字起こし**: DeepgramではなくGemini 2.0 FlashのTranscribe機能を使用
2. **並列処理**: Split in Batchesを2箇所で使用（チャンク5並列、議題3並列）
3. **Memory使用**: Step2、Step4、Step5でSimple Memoryを使用
4. **エラーハンドリング**: Error Triggerで全エラーを受け取り、種別判定してリカバリー
5. **データ整合性**: Merge時に重複除去（line_id基準）

### 特記事項

1. **12層アーキテクチャの完全適用**: すべての業務要件を12層のいずれかにマッピング完了
2. **n8n-MCP活用**: ノード選定時にn8n-MCPサーバーを活用（実際の実装時に使用）
3. **Sticky Note配置**: 各グループに処理内容を記述するSticky Noteを配置（L10: Monitoring層）
4. **並列処理の最適化**: APIレート制限を考慮したバッチサイズ設計（チャンク5、議題3）
5. **エラー通知の完全性**: すべてのエラーをDiscordで管理者に通知
