# グループ構成表 (Step040)

## ワークフロー名
Google Meet議事録自動化システム

---

## グループ分解概要

**総グループ数**: 13グループ（メインフロー12 + エラーフロー1）
**総ノード数**: 約55ノード（Sticky Note除く）

---

## メインフローグループ（12グループ）

### Group 1: トリガー & ファイル取得
- **責務**: Google Drive新規M4Aファイル検知、ファイル情報取得、M4Aダウンロード
- **ノード数**: 3
- **入力**: 外部（Google Drive）
- **出力**: M4Aバイナリデータ + ファイルメタデータ
- **ノード構成**:
  1. Google Drive Trigger: 新規ファイル検知
  2. Google Drive: ファイル情報取得
  3. Google Drive: M4Aダウンロード

### Group 2: バリデーション
- **責務**: ファイル形式とサイズの検証
- **ノード数**: 1
- **入力**: Group 1
- **出力**: 検証済みデータ（成功時）、エラー情報（失敗時）
- **ノード構成**:
  1. IF: ファイル形式確認（mimeType=audio/m4a, size<1GB）

### Group 3: Gemini音声文字起こし
- **責務**: M4A音声ファイルから日本語文字起こし生成（話者分離、タイムスタンプ付き）
- **ノード数**: 1（AI Agent）
- **入力**: Group 2
- **出力**: JSON配列（lines: [{line_id, content, speaker, timestamp}]）
- **ノード構成**:
  1. AI Agent (Gemini 2.0 Flash): 音声文字起こし

### Group 4: チャンク分割
- **責務**: 文字起こしを20-30行ごとに分割、前後6行のオーバーラップ追加
- **ノード数**: 1（Code）
- **入力**: Group 3
- **出力**: チャンク配列（chunks: [{chunk_id, main_text, overlap_before, overlap_after}]）
- **ノード構成**:
  1. Code: チャンク分割 + オーバーラップ追加

### Group 5: チャンク並列処理（Step1）
- **責務**: 5チャンク並列でフィラー語除去と箇条書き化
- **ノード数**: 3（Split in Batches + AI Agent + Loop）
- **入力**: Group 4
- **出力**: 整形済みチャンク配列
- **ノード構成**:
  1. Split in Batches: チャンク並列処理（batchSize=5）
  2. AI Agent (Gemini 2.0 Flash): 文字起こし整形
  3. Loop処理（Split in Batchesが自動制御）

### Group 6: チャンク統合
- **責務**: 全チャンクをマージ、line_idでソート、重複除去
- **ノード数**: 2（Merge + Code）
- **入力**: Group 5
- **出力**: 統合済みJSON配列（全lines）
- **ノード構成**:
  1. Merge: 全チャンクをマージ
  2. Code: line_idソート + 重複除去

### Group 7: 議題抽出（Step2）
- **責務**: 統合テキストから会議の議題を自動抽出
- **ノード数**: 1（AI Agent）
- **入力**: Group 6
- **出力**: 議題リスト（meeting_name, agendas: [{agenda_id, title, line_ids}]）
- **ノード構成**:
  1. AI Agent (Gemini 2.0 Flash + Memory): 議題抽出

### Group 8: 議題データ再構成
- **責務**: 各議題に該当する文字起こしを収集
- **ノード数**: 1（Code）
- **入力**: Group 7
- **出力**: 議題ごとのデータ（agendas: [{agenda_id, title, lines}]）
- **ノード構成**:
  1. Code: 議題ごとのデータ再構成

### Group 9: 議題並列処理（Step3）
- **責務**: 3議題並列で決定事項・宿題・保留事項を抽出
- **ノード数**: 3（Split in Batches + AI Agent + Loop）
- **入力**: Group 8
- **出力**: 議題分析結果配列
- **ノード構成**:
  1. Split in Batches: 議題並列処理（batchSize=3）
  2. AI Agent (Gemini 2.0 Flash): 議題分析
  3. Loop処理（Split in Batchesが自動制御）

### Group 10: 議題統合 + フォーマット変換（Step4）
- **責務**: 全議題をマージ、Markdown議事録を生成
- **ノード数**: 2（Merge + AI Agent）
- **入力**: Group 9
- **出力**: Markdown議事録
- **ノード構成**:
  1. Merge: 全議題をマージ
  2. AI Agent (Claude Sonnet 4.5 + Memory): フォーマット変換

### Group 11: 品質保証 + 議事録保存（Step5）
- **責務**: 議事録の完全性検証・補完、Google Driveに保存
- **ノード数**: 2（AI Agent + Google Drive）
- **入力**: Group 10
- **出力**: 議事録URL
- **ノード構成**:
  1. AI Agent (Claude Sonnet 4.5 + Memory): 品質保証
  2. Google Drive: 議事録保存

### Group 12: ファイル移動 + 通知 + 最終結果
- **責務**: M4Aファイルを処理済みフォルダに移動、Discord通知、最終結果セット
- **ノード数**: 3
- **入力**: Group 11
- **出力**: 処理完了ステータス
- **ノード構成**:
  1. Google Drive: M4Aファイル移動（/processed/）
  2. Discord Webhook: 処理完了通知
  3. Set: 最終結果セット

---

## エラーフローグループ（1グループ）

### Error Group 1: エラーハンドリング
- **責務**: 全ノードのエラー検知、種別判定、リカバリー処理、エラー通知
- **ノード数**: 7
- **入力**: 任意のノードエラー
- **出力**: エラー通知完了
- **ノード構成**:
  1. Error Trigger: エラー検知
  2. Code: エラー情報整理
  3. IF: エラー種別判定
  4. Google Drive: エラーファイル移動（Gemini失敗時）
  5. Google Drive: エラー議事録保存（AI失敗時）
  6. Set: エラー一時保存（Drive失敗時）
  7. Discord Webhook: エラー通知

---

## グループ間依存関係

```
Group 1 → Group 2 → Group 3 → Group 4 → Group 5 → Group 6 →
Group 7 → Group 8 → Group 9 → Group 10 → Group 11 → Group 12

Any Group Error → Error Group 1
```

---

## 並列処理グループ

- **Group 5**: チャンク並列処理（5チャンク並列）
- **Group 9**: 議題並列処理（3議題並列）

---

## Sticky Note配置計画

各グループに1-2個のSticky Noteを配置し、処理内容を記述します。

| Group | Sticky Note内容 |
|-------|----------------|
| Group 1 | トリガー: Google Drive新規M4Aファイル検知（5分ごと）<br>ファイル情報取得、M4Aダウンロード |
| Group 2 | バリデーション: mimeType=audio/m4a、size<1GB確認 |
| Group 3 | Gemini音声文字起こし: M4A→日本語テキスト<br>Speaker Diarization、Timestamps付き |
| Group 4 | チャンク分割: 20-30行ごと、前後6行オーバーラップ |
| Group 5 | チャンク並列処理（Step1）: 5チャンク並列<br>フィラー除去、箇条書き化 |
| Group 6 | チャンク統合: line_idソート、重複除去 |
| Group 7 | 議題抽出（Step2）: 会話から議題を自動抽出<br>Memory使用（session_key: step2_memory） |
| Group 8 | 議題データ再構成: 各議題に該当文字起こし収集 |
| Group 9 | 議題並列処理（Step3）: 3議題並列<br>決定事項・宿題・保留事項抽出 |
| Group 10 | 議題統合 + フォーマット変換（Step4）<br>Markdown議事録生成、Memory使用 |
| Group 11 | 品質保証（Step5）+ 議事録保存<br>完全性検証、Google Drive保存 |
| Group 12 | ファイル移動 + Discord通知 + 最終結果 |
| Error Group 1 | エラーハンドリング: 種別判定、リカバリー、通知 |

---

## 次ステップへの引き継ぎ事項

### Step050（AIエージェント責務定義）への引き継ぎ
- AI Agentノード数: 6個（Gemini×4、Claude×2）
- Memory使用箇所: 3個（Step2、Step4、Step5）
- 単一責務の原則: 各AI Agentは1つの明確な責務のみを持つ

### Step060（パターン適用と詳細設計）への引き継ぎ
- 並列処理パターン: 2箇所（チャンク、議題）
- エラーハンドリングパターン: Error Trigger + 種別判定 + リカバリー
- データフローパターン: Trigger → Validation → Transformation → Core Logic → Integration → Output
