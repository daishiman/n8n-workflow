# 詳細設計書 (Step060)

## ワークフロー名
Google Meet議事録自動化システム

---

## 適用パターン一覧

本ワークフローでは、以下の5つのベストプラクティスパターンを適用します。

1. **並列処理パターン** (Split in Batches)
2. **エラーハンドリングパターン** (Error Trigger + リトライ)
3. **Memory使用パターン** (Simple Memory)
4. **データ変換パターン** (Code + AI Agent)
5. **外部連携パターン** (Google Drive + Discord)

---

## パターン1: 並列処理パターン

### 適用箇所
- **Group 5**: チャンク並列処理（Step1）
- **Group 9**: 議題並列処理（Step3）

### パターン詳細

**チャンク並列処理（Group 5）**:
```
Code: チャンク分割
  ↓ (12チャンク配列)
Split in Batches (batchSize=5)
  ↓ (5チャンク並列)
AI Agent: 文字起こし整形 × 5並列実行
  ↓ (整形済みチャンク)
Merge: 全チャンクをマージ
  ↓ (統合済みlines)
Code: line_idソート + 重複除去
```

**議題並列処理（Group 9）**:
```
Code: 議題データ再構成
  ↓ (3議題配列)
Split in Batches (batchSize=3)
  ↓ (3議題並列)
AI Agent: 議題分析 × 3並列実行
  ↓ (分析結果)
Merge: 全議題をマージ
```

### パターンの利点
- 処理時間短縮: 12チャンク → 5並列 = 2.4倍高速化
- APIレート制限回避: バッチサイズ調整で制限内に収める
- スケーラビリティ: チャンク数・議題数増加に対応可能

---

## パターン2: エラーハンドリングパターン

### 適用箇所
- **Error Group 1**: 全ノードのエラーを受け取り、種別判定、リカバリー

### パターン詳細

```
任意のノードエラー
  ↓
Error Trigger
  ↓
Code: エラー情報整理
  {
    error_type: "gemini" | "ai" | "drive",
    error_message: "...",
    node_name: "...",
    file_name: "..."
  }
  ↓
IF: エラー種別判定
  ├─ Gemini失敗 → Google Drive: /エラー/フォルダに移動
  ├─ AI失敗 → Google Drive: [ERROR]minutes - ...として保存
  └─ Drive失敗 → Set: n8n内部ストレージに一時保存
  ↓
Discord Webhook: エラー通知
```

### リトライ戦略
| API | 最大リトライ回数 | リトライ間隔 | タイムアウト |
|-----|----------------|------------|------------|
| Gemini | 3回 | 5秒、10秒、20秒 | 30秒 |
| Claude | 2回 | 3秒、10秒 | 90秒 |
| Google Drive | 3回 | 5秒、10秒、20秒 | 30秒 |

---

## パターン3: Memory使用パターン

### 適用箇所
- **Step2**: 議題抽出（session_key: step2_memory）
- **Step4**: フォーマット変換（session_key: step4_memory）
- **Step5**: 品質保証（session_key: step5_memory）

### パターン詳細

**Memory設定**:
```json
{
  "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
  "parameters": {
    "sessionKey": "step2_memory",  // または step4_memory, step5_memory
    "contextWindowLength": 10  // Step2, Step4, Step5は10、他は5
  }
}
```

**Memory使用理由**:
- **Step2**: 会話全体の文脈を保持し、自然な議題区切りを検出
- **Step4**: 全データ統合時の文脈を保持し、一貫性のあるMarkdown生成
- **Step5**: 元データとの整合性を確認し、不足項目を補完

**Memory不使用箇所**:
- **Step1**: チャンクが独立、並列処理のためMemory不要
- **Step3**: 議題が独立、並列処理のためMemory不要

---

## パターン4: データ変換パターン

### 適用箇所
- **Group 3**: Gemini音声文字起こし
- **Group 4**: Code チャンク分割
- **Group 5**: Gemini文字起こし整形
- **Group 6**: Code チャンク統合
- **Group 8**: Code 議題データ再構成

### パターン詳細

**音声→テキスト変換（Group 3）**:
```
M4Aバイナリ
  ↓ (Gemini 2.0 Flash Transcribe)
JSON配列
{
  "lines": [
    {
      "line_id": 1,
      "content": "発言内容",
      "speaker": "A",
      "timestamp": "00:01:20",
      "start_time": 80.5,
      "end_time": 85.2
    }
  ]
}
```

**チャンク分割（Group 4）**:
```javascript
const lines = $input.item.json.lines;
const chunkSize = 25;
const overlapSize = 6;

// 20-30行ごとに分割、前後6行オーバーラップ
for (let i = 0; i < lines.length; i += chunkSize) {
  chunks.push({
    chunk_id: Math.floor(i / chunkSize) + 1,
    main_text: lines.slice(i, i + chunkSize),
    overlap_before: i > 0 ? lines.slice(i - overlapSize, i) : null,
    overlap_after: lines.slice(i + chunkSize, i + chunkSize + overlapSize)
  });
}
```

**チャンク統合（Group 6）**:
```javascript
const allLines = [];
for (const item of $input.all()) {
  allLines.push(...item.json.lines);
}

// line_id でソート、重複除去
const uniqueLines = allLines
  .sort((a, b) => a.line_id - b.line_id)
  .filter((line, index, self) =>
    index === 0 || line.line_id !== self[index - 1].line_id
  );
```

---

## パターン5: 外部連携パターン

### 適用箇所
- **Group 1**: Google Drive（トリガー、ファイル取得）
- **Group 11**: Google Drive（議事録保存）
- **Group 12**: Google Drive（ファイル移動）、Discord（通知）

### パターン詳細

**Google Drive保存（Group 11）**:
```json
{
  "resource": "file",
  "operation": "create",
  "name": "={{ 'minutes - ' + $now.format('YYYY-MM-DD') + ' - ' + $json.meeting_name + '.md' }}",
  "parents": {
    "folderId": "/議事録_出力/"
  },
  "mimeType": "text/markdown",
  "options": {
    "fileContent": "={{ $json.markdown }}"
  }
}
```

**Google Driveファイル移動（Group 12）**:
```json
{
  "resource": "file",
  "operation": "update",
  "fileId": "={{ $('Google Drive: 新規ファイル検知').item.json.id }}",
  "updateFields": {
    "parents": {
      "folderId": "/processed/"
    }
  }
}
```

**Discord通知（Group 12）**:
```json
{
  "webhookUrl": "={{ $env.DISCORD_WEBHOOK_URL }}",
  "content": "✅ 議事録生成完了！\n📄 ファイル: {{ $json.name }}\n🔗 URL: {{ $json.webViewLink }}\n⏱ 処理時間: {{ $executionTime }}秒"
}
```

---

## グループ別詳細設計

### Group 1: トリガー & ファイル取得
- **ノード数**: 3
- **パターン**: 外部連携パターン
- **ノード構成**:
  1. Google Drive Trigger（5分ポーリング、mimeType=audio/m4a）
  2. Google Drive: Get File Info
  3. Google Drive: Download（binaryPropertyName="m4a_data"）

### Group 2: バリデーション
- **ノード数**: 1
- **パターン**: エラーハンドリングパターン
- **ノード構成**:
  1. IF: mimeType="audio/m4a" AND size<1GB

### Group 3: Gemini音声文字起こし
- **ノード数**: 1
- **パターン**: データ変換パターン
- **ノード構成**:
  1. AI Agent (Gemini 2.0 Flash): 音声文字起こし
     - Model: gemini-2.0-flash-exp
     - Temperature: 0.3
     - Max Tokens: 100000
     - Audio Timestamp: true

### Group 4: チャンク分割
- **ノード数**: 1
- **パターン**: データ変換パターン
- **ノード構成**:
  1. Code: チャンク分割 + オーバーラップ追加

### Group 5: チャンク並列処理（Step1）
- **ノード数**: 2 (+ Loop)
- **パターン**: 並列処理パターン
- **ノード構成**:
  1. Split in Batches (batchSize=5)
  2. AI Agent (Gemini 2.0 Flash): 文字起こし整形
     - Model: gemini-2.0-flash-exp
     - Temperature: 0.4
     - Max Tokens: 4000
     - Memory: なし

### Group 6: チャンク統合
- **ノード数**: 2
- **パターン**: データ変換パターン
- **ノード構成**:
  1. Merge
  2. Code: line_idソート + 重複除去

### Group 7: 議題抽出（Step2）
- **ノード数**: 1
- **パターン**: Memory使用パターン
- **ノード構成**:
  1. AI Agent (Gemini 2.0 Flash + Memory): 議題抽出
     - Model: gemini-2.0-flash-exp
     - Temperature: 0.4
     - Max Tokens: 4000
     - Memory: Simple Memory (session_key: step2_memory, contextWindowLength: 10)

### Group 8: 議題データ再構成
- **ノード数**: 1
- **パターン**: データ変換パターン
- **ノード構成**:
  1. Code: 議題ごとのデータ再構成

### Group 9: 議題並列処理（Step3）
- **ノード数**: 2 (+ Loop)
- **パターン**: 並列処理パターン
- **ノード構成**:
  1. Split in Batches (batchSize=3)
  2. AI Agent (Gemini 2.0 Flash): 議題分析
     - Model: gemini-2.0-flash-exp
     - Temperature: 0.4
     - Max Tokens: 4000
     - Memory: なし

### Group 10: 議題統合 + フォーマット変換（Step4）
- **ノード数**: 2
- **パターン**: Memory使用パターン
- **ノード構成**:
  1. Merge
  2. AI Agent (Claude Sonnet 4.5 + Memory): フォーマット変換
     - Model: claude-sonnet-4-5-20250929
     - Temperature: 0.7
     - Max Tokens: 8000
     - Memory: Simple Memory (session_key: step4_memory, contextWindowLength: 5)

### Group 11: 品質保証 + 議事録保存（Step5）
- **ノード数**: 2
- **パターン**: Memory使用パターン + 外部連携パターン
- **ノード構成**:
  1. AI Agent (Claude Sonnet 4.5 + Memory): 品質保証
     - Model: claude-sonnet-4-5-20250929
     - Temperature: 0.7
     - Max Tokens: 8000
     - Memory: Simple Memory (session_key: step5_memory, contextWindowLength: 5)
  2. Google Drive: Create File（議事録保存）

### Group 12: ファイル移動 + 通知 + 最終結果
- **ノード数**: 3
- **パターン**: 外部連携パターン
- **ノード構成**:
  1. Google Drive: Update File（M4Aファイル移動）
  2. Discord Webhook: 処理完了通知
  3. Set: 最終結果セット

### Error Group 1: エラーハンドリング
- **ノード数**: 7
- **パターン**: エラーハンドリングパターン
- **ノード構成**:
  1. Error Trigger
  2. Code: エラー情報整理
  3. IF: エラー種別判定
  4. Google Drive: エラーファイル移動
  5. Google Drive: エラー議事録保存
  6. Set: エラー一時保存
  7. Discord Webhook: エラー通知

---

## Phase 2への引き継ぎ事項

### グループ別JSON生成の準備完了

**メインフローグループ（12グループ）**:
- Group 1-12: 各グループの詳細設計完了

**エラーフローグループ（1グループ）**:
- Error Group 1: エラーハンドリング詳細設計完了

### JSON生成時の注意事項
1. **AI Agentノード**: Step020のAI設定書からパラメータをコピー
2. **Codeノード**: 上記のJavaScriptコードをコピー
3. **Split in Batches**: batchSizeを正確に設定（チャンク=5、議題=3）
4. **Merge**: removeDuplicates=true、duplicateComparisonField="line_id"
5. **Memory**: session_keyとcontextWindowLengthを正確に設定

### 次ステップ（Phase 2）
Step070-129: 各グループのJSON生成（Step070テンプレートを使用）
